<!-- This is the current version of the sheet code--><input name="attr_version" type="hidden" value="1.0"/><input class="build_message" name="attr_build_message" type="hidden" value=""/><div class="build_message"><div class="build_text"><span name="attr_build_message"></span></div></div><!-- PRIMARY SHEET DISPLAY--><input class="toggles" name="attr_toggles" type="hidden" value="color:default,innate,focus,cantrips,normalspells,"/><div class="backdrop"><div class="container"><input class="type" name="attr_sheet_type" type="hidden" value="character"/><input class="toggles" name="attr_toggles" type="hidden" value="color:default,innate,focus,cantrips,normalspells"/><div class="pc-info">
	<div class="column">
		<img alt="Pathfinder second edition logo"
			src="https://s3.amazonaws.com/files.d20.io/images/81978424/gPz-jgjL0kKUDQEXUWvgmQ/med.png?1558470838" />
		<h1 name="character_sheet">character sheet</h1>
	</div>
	<div class="column">
		<div class="character-info">
			<label title="character name">
				<span>character name</span>
				<input name="attr_character_name" placeholder="character name" spellcheck="false"
					title="@{character_name}" type="text" value="" />
			</label>
			<label title="player name">
				<span>player name</span>
				<input name="attr_player_name" placeholder="player name" spellcheck="false" title="@{player_name}"
					type="text" value="" />
			</label>
			<label title="xp">
				<span>experience points (xp)</span>
				<input name="attr_xp" placeholder="xp" spellcheck="false" title="@{xp}" type="text" value="" />
			</label>
			<label title="class">
				<span>class</span>
				<input name="attr_class" placeholder="class" spellcheck="false" title="@{class}" type="text"
					value="" />
			</label>
			<label title="alignment">
				<span>alignment</span>
				<input name="attr_alignment" placeholder="alignment" spellcheck="false" title="@{alignment}"
					type="text" value="" />
			</label>
		</div>
	</div>
	<div class="column">
		<label title="level">
			<span>level</span>
			<input name="attr_level" placeholder="level" spellcheck="false" title="@{level}" type="text"
				value="1" />
		</label>
	</div>
</div>	<!--- end CHARACTER INFO at the top ---><div class="tabs"><label class="whisper-toggle" title="whisper rolls to gm"><input name="attr_whispertype" type="checkbox" value="/w gm"/><span class="pictos">q</span></label><label title="character"><input name="attr_sheet_type" type="radio" value="character"/><span>character</span></label><label title="details"><input name="attr_sheet_type" type="radio" value="details"/><span>details</span></label><label title="feats"><input name="attr_sheet_type" type="radio" value="feats"/><span>feats</span></label><label title="inventory"><input name="attr_sheet_type" type="radio" value="inventory"/><span>inventory</span></label><label title="options"><input name="attr_sheet_type" type="radio" value="options"/><span>options</span></label></div><!-- NPC SHEET--><!--include src/html/npc.html--><!-- PC SHEET--><div class="character"><div class="column"><!--- HIT POINTS column --->
<h1>hit points</h1>
<div class='hitpoints background-color'>
    <div class='grid display background-color'>
        <button class='pictos settings-button' name='act_toggle_hitpoints' title='hit points settings' type='action'>
            y
        </button>
        <div class='circle'>
            <label title='hit points max'>
                <span class='redstroke' title='max'>max</span>
                <span name='attr_hit_points_max' title='@{hit_points_max}'></span>
            </label>
        </div>
        <label title='hit points current'>
            <span class='sublabel darkred' >current</span>
            <input name='attr_hit_points' placeholder='0' spellcheck='false' title='@{hit_points}' type='text' value='' />
        </label>
        <label title='hit points temporary'>
            <span class='sublabel darkred' >temporary</span>
            <input name='attr_hit_points_temporary' placeholder='0' spellcheck='false' title='@{hit_points_temporary}' type='text' value='' />
        </label>
    </div>
    <div class='grid settings'>
        <label class='sublabel' title='hit points permanent bonus from other sources like feats and class features'>
            <span class='sublabel darkred' >bonus</span>
            <input class='3em' name='attr_hit_points_other' placeholder='0' spellcheck='false' title='@{hit_points_other}' type='text' value='' />
        </label>
        <label class='sublabel' title='hit points bonus from items'>
            <span class='sublabel darkred' >item</span>
            <input class='3em' name='attr_hit_points_item' placeholder='0' spellcheck='false' title='@{hit_points_item}' type='text' value='' />
        </label>
        <label title='hit points notes'>
            <span >notes</span>
            <textarea name='attr_hit_points_notes' placeholder='notes' spellcheck='false' title='@{hit_points_notes}' value=''></textarea>
        </label>
    </div>
	<hr />
	<div class='grid shield-grid display'>
		<button class='pictos settings-button' name='act_toggle_shield' title='shield settings' type='action'>
			y
		</button>
		<div class='circle'>
			<label class='shield display'>
				<span >abs</span>
				<span name='attr_armor_class_shield' title='@{armor_class_shield}'></span>
			</label>
		</div>
		<div class='shield-hp'>
			<label class='sublabel' title='absorption'>
				<span class='sublabel darkred' >current</span>
				<input name='attr_armor_class_shield_hp' placeholder='0' spellcheck='false' title='@{armor_class_shield_hp}' type='text' value='6' />
			</label>
		</div>
		<label class='sublabel' title='damage reduction'>
			<span class='sublabel darkred' >dr</span>
			<span name='attr_armor_class_shield_hardness' title='@{armor_class_shield_hardness}'></span>
		</label>
		<div class='settings grid'>
			<label title='absorption'>
				<span class='sublabel darkred' >absorption</span>
				<input name='attr_armor_class_shield_ac_bonus' placeholder='0' spellcheck='false' title='@{armor_class_shield_ac_bonus}' type='text' value='0' />
			</label>
			<label title='damage reduction'>
				<span class='sublabel darkred' >dr</span>
				<input name='attr_armor_class_shield_hardness' placeholder='0' spellcheck='false' title='@{armor_class_shield_hardness}' type='text' value='0' />
			</label>
			<label title='absorption notes'>
				<span >notes</span>
				<textarea name='attr_armor_class_shield_notes' placeholder='notes' spellcheck='false' title='@{armor_class_shield_notes}' value=''></textarea>
			</label>
		</div>
	</div>
    <hr />
    <div class='resistance repeating'>
        <h3 >resistances and immunities</h3>
        <fieldset class='repeating_resistances-immunities'>
            <input class='toggles' name='attr_toggles' type='hidden' value='display,settings,' />
            <div class='grid repeating-grid'>
                <button class='pictos settings-button' name='act_settings' title='resistances and immunities settings' type='action'>
                    y
                </button>
                <button name='roll_RESIST' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{resistances_and_immunities}}} {{subheader=^{resistances_and_immunities}}} {{notes_show=[[1]]}} {{notes=@{resistances_and_immunities_notes}}}'>
                    <span class='repeating-title' name='attr_resistances_and_immunities'></span>
                </button>
                <button name='act_collapse' title='show or hide resistance notes' type='action'>
                    4
                </button>
                <span class='collapse' name='attr_resistances_and_immunities_notes'></span>
            </div>
            <div class='settings repeating-grid'>
                <label title='resistances and immunities name'>
                    <span >name</span>
                    <input name='attr_resistances_and_immunities' placeholder='resistances or immunities' title='@{resistances_and_immunities}' type='text' value='' />
                </label>
                <label title='resistances and immunities notes'>
                    <span >notes</span>
                    <textarea name='attr_resistances_and_immunities_notes' placeholder='notes' spellcheck='false' title='@{resistances_and_immunities_notes}'></textarea>
                </label>
            </div>
        </fieldset>
    </div>
    <div class='conditions repeating'>
        <h3 >conditions</h3>
        <fieldset class='repeating_conditions'>
            <input class='toggles' name='attr_toggles' type='hidden' value='display,settings,' />
            <div class='grid repeating-grid'>
                <button class='pictos settings-button' name='act_settings' title='condition settings' type='action'>
                    y
                </button>
                <button name='roll_CONDITION' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{condition}}} {{subheader=^{conditions}}} {{notes_show=[[1]]}} {{notes=@{condition_notes}}}'>
                    <span class='repeating-title' name='attr_condition'></span>
                </button>
                <button name='act_collapse' title='show or hide condition notes' type='action'>
                    4
                </button>
                <span class='collapse' name='attr_condition_notes'></span>
            </div>
            <div class='settings repeating-grid'>
                <label title='condition name'>
                    <span >name</span>
                    <input name='attr_condition' placeholder='condition' title='@{condition}' type='text' value='' />
                </label>
                <label title='conditions notes'>
                    <span >notes</span>
                    <textarea name='attr_condition_notes' placeholder='notes' spellcheck='false' title='@{condition_notes}'></textarea>
                </label>
            </div>
        </fieldset>
    </div>
</div>
<!--- ABILITY SCORES  & CLASS DC column --->
<h1>ability scores</h1>
<div class='ability-scores background-color'>
    <div class='display strength-row'>
        <button class='pictos settings-button' name='act_toggle_strength' title='strength settings' type='action'>
            y
        </button>
        <div class='circle'>
            <span name='attr_strength_modifier' title='@{strength_modifier}'></span>
        </div>
        <div class='ability-modifier'>
            <button name='roll_STR' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{strength}}} {{subheader=^{ability}}} {{roll01=[[1d20cs20cf1 + (@{strength_modifier})[@{text_ability_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=ability}} {{notes_show=@{roll_show_notes}}} {{notes=@{strength_notes}}}'>str</button>
            <span >modifier</span>
        </div>
        <div class='ability-score'>
            <span >strength</span><br />
            <span >score</span>
        </div>
        <div class='circle'>
            <span name='attr_strength' title='@{strength}'></span>
        </div>
    </div>
    <div class='settings strength-settings'>
        <label class='sublabel' title='strength score'>
            <span class='sublabel darkred' >score base</span>
            <input name='attr_strength_score' placeholder='0' spellcheck='false' title='@{strength_score}' type='text' value='10' />
        </label>
        <label class='sublabel' title='strength modifier temporary'>
            <span class='sublabel darkred' >mod temp</span>
            <input name='attr_strength_modifier_temporary' placeholder='0' spellcheck='false' title='@{strength_modifier_temporary}' type='text' value='0' />
        </label>
        <label class='sublabel' title='strength score temporary'>
            <span class='sublabel darkred' >score temp</span>
            <input name='attr_strength_score_temporary' placeholder='0' spellcheck='false' title='@{strength_score_temporary}' type='text' value='0' />
        </label>
		<label class="sublabel" title="strength tenacity">
			<span class='sublabel darkred' >tenacity</span>
            <input name='attr_strength_tenacity' placeholder='0' spellcheck='false' title='@{strength_tenacity}' type='text' value='0' />
		</label>
		<label class="sublabel" title="strength max tenacity">
			<span class='sublabel darkred' >max tenacity</span>
            <span name='attr_strength_max_tenacity' title='@{strength_max_tenacity}'></span>
		</label>
		<label class="sublabel" title="strength tenacity mod">
			<span class='sublabel darkred' >tenacity mod</span>
            <input name='attr_strength_tenacity_mod' placeholder='0' spellcheck='false' title='@{strength_tenacity_mod}' type='text' value='0' />
		</label>
        <label class='notes' title='strenght notes'>
            <span >notes</span>
            <textarea class='notes' name='attr_strength_notes' placeholder='notes' spellcheck='false' title='@{strength_notes}' value=''></textarea>
        </label>
    </div>
    <div class='display dexterity-row'>
        <button class='pictos settings-button' name='act_toggle_dexterity' title='dexterity settings' type='action'>
            y
        </button>
        <div class='circle'>
            <span name='attr_dexterity_modifier' title='@{dexterity_modifier}'></span>
        </div>
        <div class='ability-modifier'>
            <button name='roll_DEX' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{dexterity}}} {{subheader=^{ability}}} {{roll01=[[1d20cs20cf1 + (@{dexterity_modifier})[@{text_ability_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=ability}} {{notes_show=@{roll_show_notes}}} {{notes=@{dexterity_notes}}}'>dex</button>
            <span >modifier</span>
        </div>
        <div class='ability-score'>
            <span >dexterity</span><br />
            <span >score</span>
        </div>
        <div class='circle'>
            <span name='attr_dexterity' title='@{dexterity}'></span>
        </div>
    </div>
    <div class='settings dexterity-settings'>
        <label class='sublabel' title='dexterity score'>
            <span class='sublabel darkred' >score base</span>
            <input name='attr_dexterity_score' placeholder='0' spellcheck='false' title='@{dexterity_score}' type='text' value='10' />
        </label>
        <label class='sublabel' title='dexterity modifier temporary'>
            <span class='sublabel darkred' >mod temp</span>
            <input name='attr_dexterity_modifier_temporary' placeholder='0' spellcheck='false' title='@{dexterity_modifier_temporary}' type='text' value='0' />
        </label>
        <label class='sublabel' title='dexterity score temporary' >
            <span class='sublabel darkred' >score temp</span>
            <input name='attr_dexterity_score_temporary' placeholder='0' spellcheck='false' title='@{dexterity_score_temporary}' type='text' value='0' />
        </label>
		<label class="sublabel" title="dexterity tenacity">
			<span class='sublabel darkred' >tenacity</span>
            <input name='attr_dexterity_tenacity' placeholder='0' spellcheck='false' title='@{dexterity_tenacity}' type='text' value='0' />
		</label>
		<label class="sublabel" title="dexterity max tenacity">
			<span class='sublabel darkred' >max tenacity</span>
            <span name='attr_dexterity_max_tenacity' title='@{dexterity_max_tenacity}'></span>
		</label>
		<label class="sublabel" title="dexterity tenacity mod">
			<span class='sublabel darkred' >tenacity mod</span>
            <input name='attr_dexterity_tenacity_mod' placeholder='0' spellcheck='false' title='@{dexterity_tenacity_mod}' type='text' value='0' />
		</label>
        <label class='notes' title='dexterity notes'>
            <span >notes</span>
            <textarea name='attr_dexterity_notes' placeholder='notes' spellcheck='false' title='@{dexterity_notes}' value=''></textarea>
        </label>
    </div>
    <div class='display constitution-row'>
        <button class='pictos settings-button' name='act_toggle_constitution' title='constitution settings' type='action'>
            y
        </button>
        <div class='circle'>
            <span name='attr_constitution_modifier' title='@{constitution_modifier}'></span>
        </div>
        <div class='ability-modifier'>
            <button name='roll_CON' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{constitution}}} {{subheader=^{ability}}} {{roll01=[[1d20cs20cf1 + (@{constitution_modifier})[@{text_ability_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=ability}} {{notes_show=@{roll_show_notes}}} {{notes=@{constitution_notes}}}'>con</button>
            <span >modifier</span>
        </div>
        <div class='ability-score'>
            <span >constitution</span><br/>
            <span >score</span>
        </div>
        <div class='circle'>
            <span name='attr_constitution' title='@{constitution}'></span>
        </div>
    </div>
    <div class='settings constitution-settings'>
        <label class='sublabel' title='constitution score'>
            <span class='sublabel darkred' >score base</span>
            <input name='attr_constitution_score' placeholder='0' spellcheck='false' title='@{constitution_score}' type='text' value='10' />
        </label>
        <label class='sublabel' title='constitution modifier temporary'>
            <span class='sublabel darkred' >mod temp</span>
            <input name='attr_constitution_modifier_temporary' placeholder='0' spellcheck='false' title='@{constitution_modifier_temporary}' type='text' value='0' />
        </label>
        <label class='sublabel' title='constitution score temporary'>
            <span class='sublabel darkred' >score temp</span>
            <input name='attr_constitution_score_temporary' placeholder='0' spellcheck='false' title='@{constitution_score_temporary}' type='text' value='0' />
        </label>
		<label class="sublabel" title="constitution tenacity">
			<span class='sublabel darkred' >tenacity</span>
            <input name='attr_constitution_tenacity' placeholder='0' spellcheck='false' title='@{constitution_tenacity}' type='text' value='0' />
		</label>
		<label class="sublabel" title="constitution max tenacity">
			<span class='sublabel darkred' >max tenacity</span>
            <span name='attr_constitution_max_tenacity' title='@{constitution_max_tenacity}'></span>
		</label>
		<label class="sublabel" title="constitution tenacity mod">
			<span class='sublabel darkred' >tenacity mod</span>
            <input name='attr_constitution_tenacity_mod' placeholder='0' spellcheck='false' title='@{constitution_tenacity_mod}' type='text' value='0' />
		</label>
		<label class="sublabel" title="tenacity drain">
			<span class='sublabel darkred' >tenacity drain</span>
            <span name='attr_constitution_tenacity_drain' title='@{constitution_tenacity_drain}'></span>
		</label>
        <label class='notes' title='constitution notes'>
            <span >notes</span>
            <textarea name='attr_constitution_notes' placeholder='notes' spellcheck='false' title='@{constitution_notes}' value=''></textarea>
        </label>
    </div>
    <div class='display intelligence-row'>
        <button class='pictos settings-button' name='act_toggle_intelligence' title='intelligence settings' type='action'>
            y
        </button>
        <div class='circle'>
            <span name='attr_intelligence_modifier' title='@{intelligence_modifier}'></span>
        </div>
        <div class='ability-modifier'>
            <button name='roll_INT' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{intelligence}}} {{subheader=^{ability}}} {{roll01=[[1d20cs20cf1 + (@{intelligence_modifier})[@{text_ability_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=ability}} {{notes_show=@{roll_show_notes}}} {{notes=@{intelligence_notes}}}'>int</button>
            <span >modifier</span>
        </div>
        <div class='ability-score'>
            <span >intelligence</span><br />
            <span >score</span>
        </div>
        <div class='circle'>
            <span name='attr_intelligence' title='@{intelligence}'></span>
        </div>
    </div>
    <div class='settings intelligence-settings'>
        <label class='sublabel' title='intelligence score'>
            <span class='sublabel darkred' >score base</span>
            <input name='attr_intelligence_score' placeholder='0' spellcheck='false' title='@{intelligence_score}' type='text' value='10' />
        </label>
        <label class='sublabel' title='intelligence modifier temporary'>
            <span class='sublabel darkred' >mod temp</span>
            <input name='attr_intelligence_modifier_temporary' placeholder='0' spellcheck='false' title='@{intelligence_modifier_temporary}' type='text' value='0' />
        </label>
        <label class='sublabel' title='intelligence score temporary'>
            <span class='sublabel darkred' >score temp</span>
            <input name='attr_intelligence_score_temporary' placeholder='0' spellcheck='false' title='@{intelligence_score_temporary}' type='text' value='0' />
        </label>
		<label class="sublabel" title="intelligence tenacity">
			<span class='sublabel darkred' >tenacity</span>
            <input name='attr_intelligence_tenacity' placeholder='0' spellcheck='false' title='@{intelligence_tenacity}' type='text' value='0' />
		</label>
		<label class="sublabel" title="intelligence max tenacity">
			<span class='sublabel darkred' >max tenacity</span>
            <span name='attr_intelligence_max_tenacity' title='@{intelligence_max_tenacity}'></span>
		</label>
		<label class="sublabel" title="intelligence tenacity mod">
			<span class='sublabel darkred' >tenacity mod</span>
            <input name='attr_intelligence_tenacity_mod' placeholder='0' spellcheck='false' title='@{intelligence_tenacity_mod}' type='text' value='0' />
		</label>
        <label class='notes' title='intelligence notes'>
            <span >notes</span>
            <textarea name='attr_intelligence_notes' placeholder='notes' spellcheck='false' title='@{intelligence_notes}' value=''></textarea>
        </label>
    </div>
    <div class='display wisdom-row'>
        <button class='pictos settings-button' name='act_toggle_wisdom' title='wisdom settings' type='action'>
            y
        </button>
        <div class='circle'>
            <span name='attr_wisdom_modifier' title='@{wisdom_modifier}'></span>
        </div>
        <div class='ability-modifier'>
            <button name='roll_WIS' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{wisdom}}} {{subheader=^{ability}}} {{roll01=[[1d20cs20cf1 + (@{wisdom_modifier})[@{text_ability_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=ability}} {{notes_show=@{roll_show_notes}}} {{notes=@{wisdom_notes}}}'>wis</button>
            <span >modifier</span>
        </div>
        <div class='ability-score'>
            <span >wisdom</span><br />
            <span >score</span>
        </div>
        <div class='circle'>
            <span name='attr_wisdom' title='@{wisdom}'></span>
        </div>
    </div>
    <div class='settings wisdom-settings'>
        <label class='sublabel' title='wisdom score'>
            <span class='sublabel darkred' >score base</span>
            <input name='attr_wisdom_score' placeholder='0' spellcheck='false' title='@{wisdom_score}' type='text' value='10' />
        </label>
        <label class='sublabel' title='wisdom modifier temporary'>
            <span class='sublabel darkred' >mod temp</span>
            <input name='attr_wisdom_modifier_temporary' placeholder='0' spellcheck='false' title='@{wisdom_modifier_temporary}' type='text' value='0' />
        </label>
        <label class='sublabel' title='wisdom score temporary'>
            <span class='sublabel darkred' >score temp</span>
            <input name='attr_wisdom_score_temporary' placeholder='0' spellcheck='false' title='@{wisdom_score_temporary}' type='text' value='0' />
        </label>
		<label class="sublabel" title="wisdom tenacity">
			<span class='sublabel darkred' >tenacity</span>
            <input name='attr_wisdom_tenacity' placeholder='0' spellcheck='false' title='@{wisdom_tenacity}' type='text' value='0' />
		</label>
		<label class="sublabel" title="wisdom max tenacity">
			<span class='sublabel darkred' >max tenacity</span>
            <span name='attr_wisdom_max_tenacity' title='@{wisdom_max_tenacity}'></span>
		</label>
		<label class="sublabel" title="wisdom tenacity mod">
			<span class='sublabel darkred' >tenacity mod</span>
            <input name='attr_wisdom_tenacity_mod' placeholder='0' spellcheck='false' title='@{wisdom_tenacity_mod}' type='text' value='0' />
		</label>
        <label class='notes' title='wisdom notes'>
            <span >notes</span>
            <textarea name='attr_wisdom_notes' placeholder='notes' spellcheck='false' title='@{wisdom_notes}' value=''></textarea>
        </label>
    </div>
    <div class='display charisma-row'>
        <button class='pictos settings-button' name='act_toggle_charisma' title='charisma settings' type='action'>
            y
        </button>
        <div class='circle'>
            <span name='attr_charisma_modifier' title='@{attr_charisma_modifier}'></span>
        </div>
        <div class='ability-modifier'>
            <button name='roll_CHA' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{charisma}}} {{subheader=^{ability}}} {{roll01=[[1d20cs20cf1 + (@{charisma_modifier})[@{text_ability_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=ability}} {{notes_show=@{roll_show_notes}}} {{notes=@{charisma_notes}}}'>cha</button>
            <span >modifier</span>
        </div>
        <div class='ability-score'>
            <span >charisma</span><br />
            <span >score</span>
        </div>
        <div class='circle'>
            <span name='attr_charisma' title='@{charisma}'></span>
        </div>
    </div>
    <div class='settings charisma-settings'>
        <label class='sublabel' title='charisma score'>
            <span class='sublabel darkred' >score base</span>
            <input name='attr_charisma_score' placeholder='0' spellcheck='false' title='@{charisma_score}' type='text' value='10' />
        </label>
        <label class='sublabel' title='charisma modifier temporary'>
            <span class='sublabel darkred' >mod temp</span>
            <input name='attr_charisma_modifier_temporary' placeholder='0' spellcheck='false' title='@{charisma_modifier_temporary}' type='text' value='0' />
        </label>
        <label class='sublabel' title='charisma score temporary'>
            <span class='sublabel darkred' >score temp</span>
            <input name='attr_charisma_score_temporary' placeholder='0' spellcheck='false' title='@{charisma_score_temporary}' type='text' value='0' />
        </label>
        <label class='notes' title='charisma notes'>
            <span >notes</span>
            <textarea name='attr_charisma_notes' placeholder='notes' spellcheck='false' title='@{charisma_notes}' value=''></textarea>
        </label>
    </div>
</div>

<!-- Class DCs etc. -->
<div class='classdc background-color'>
    <h1 >class dc</h1>
    <div class='grid display'>
        <button class='pictos settings-button' name='act_toggle_class_dc' title='class dc settings' type='action'>
            y
        </button>
        <div class='circle'>
            <span name='attr_class_dc'></span>
        </div>
        <div class='dcbase sublabel' class='dcbase'>
            <span class='symbol'>=</span>
            <span class='sublabel' >dc base</span>
            <span class='sublabel' ><b>10</b></span>
        </div>
        <label class='sublabel' title='class dc key ability'>
            <span class='sublabel darkred' >key</span>
            <span name='attr_class_dc_key_ability'></span>
        </label>
		<label class='sublabel' title='class dc half level bonus'>
            <span class='sublabel darkred' >half level</span>
            <span name='attr_class_dc_proficiency'></span>
        </label>
        <label class='sublabel' title='class dc item'>
            <span class='sublabel darkred' >item</span>
            <span name='attr_class_dc_item' title='@{class_dc_item}'></span>
        </label>
        <label class='sublabel' title='class dc temporary'>
            <span class='sublabel darkred' >temp</span>
            <span name='attr_class_dc_temporary' title='@{class_dc_temporary}'></span>
        </label>
    </div>
    <div class='grid settings'>
        <div class='ability-select'>
            <label title='class dc key ability select'>
                <select name='attr_class_dc_key_ability_select' title='@{class_dc_key_select}'>
                    <option value='@{strength_modifier}' selected>str</option>
                    <option value='@{dexterity_modifier}'>dex</option>
                    <option value='@{constitution_modifier}'>con</option>
                    <option value='@{intelligence_modifier}'>int</option>
                    <option value='@{wisdom_modifier}'>wis</option>
                    <option value='@{charisma_modifier}'>cha</option>
                    <option value='custom'>custom</option>
                </select>
            </label>
            <label title='class dc key ability'>
                <input name='attr_class_dc_key_ability' placeholder='0' spellcheck='false' title='@{class_dc_key_ability}' type='text' value='' />
            </label>
        </div>
        <label class='sublabel' title='class dc item'>
            <span class='sublabel darkred' >item</span>
            <input name='attr_class_dc_item' placeholder='0' spellcheck='false' title='@{class_dc_item}' type='text' value='0' />
        </label>
        <label class='sublabel' title='class dc temporary'>
            <span class='sublabel darkred' >temp</span>
            <input name='attr_class_dc_temporary' placeholder='0' spellcheck='false' title='@{class_dc_temporary}' type='text' value='0' />
        </label>
        <label title='class dc notes'>
            <span >notes</span>
            <textarea name='attr_class_dc_notes' placeholder='notes' spellcheck='false' title='@{class_dc_notes}' value=''></textarea>
        </label>
    </div>
</div>

<!-- SPEED  -->
<div class='speed grid'>
    <h1 >speed</h1>
    <label title='speed in feet'>
        <input name='attr_speed' placeholder='30' spellcheck='false' title='@{speed}' type='text' value='' />
    </label>
    <span title="feet">feet</span>
    <div>
        <h3 >movement types & notes</h3>
        <label title='movement types & speed notes'>
            <textarea name='attr_speed_notes' placeholder='notes' spellcheck='false' title='@{speed_notes}' value=''></textarea>
        </label>
    </div>
</div>
<!-- Attacks - Melee -->
<div class='strikes melee background-color'>
    <h1 >attacks</h1>
    <fieldset class='repeating_melee-strikes'>
        <input name='attr_weapon_strike' type='hidden' value='0' />
        <input name='attr_weapon_display' type='hidden' value='+0' />
        <input name='attr_damage_display' type='hidden' value='0' />
        <input name='attr_damage_info' type='hidden' value='' />
        <input name='attr_damage_dice_query' type='hidden' value='@{damage_dice}' />
        <input name='attr_weapon_roll' type='hidden' value='{{roll01_name=^{attack}}} {{roll01=[[1d20cs>@{weapon_crit_range}cf1 + [@{weapon_proficiency_display}] @{weapon_strike}[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=attack}} {{roll01_info=@{weapon_traits}}} {{roll01_critical=1}}' />
        <input name='attr_critical_confirm' type="hidden" value='{{criticalconfirm_name=^{critical_confirm}}} {{criticalconfirm=[[1d20cs>@{weapon_crit_range}cf1 + [@{weapon_proficiency_display}] @{weapon_strike}[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{criticalconfirm_type=critical-damage}} {{criticalconfirm_info=@{weapon_traits}}}' />
		<input name='attr_damage_roll' type='hidden' value='{{roll02_name=^{damage}}} {{roll02=[[@{damage_dice_query}@{damage_dice_size} + @{damage_ability}[@{text_ability_modifier}] + @{damage_other}[OTHER] + @{query_roll_damage_bonus}[@{text_roll_damage_bonus}]]]}} {{roll02_type=damage}} {{roll02_info=@{damage_info}}}' />
        <input name='attr_damage_critical_roll' type='hidden' value='{{criticalroll_name=^{critical_damage}}} {{criticalroll=[[(@{damage_dice_query}*@{weapon_crit_mult})@{damage_dice_size} + @{damage_ability}[@{text_ability_modifier}] + @{damage_other}[OTHER] + @{query_roll_damage_bonus}[@{text_roll_damage_bonus}]]]}} {{criticalroll_type=critical-damage}} {{criticalroll_info=@{damage_info}}}' />
        <input name='attr_damage_additional_roll' type='hidden' value='{{roll04_name=^{damage_additional}}} {{roll04=@{damage_additional}}} {{roll04_type=damage}}' />
        <input name="attr_weapon_proficiency_display" type="hidden" value ="" />
        <!-- Optional Critical Damage handling -->
        <button name='roll_CRITICAL_DAMAGE' style='display: none;' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{weapon}}} {{subheader=^{melee_strike}}} {{notes_show=@{roll_show_notes}}} {{notes=@{weapon_notes}}} @{damage_critical_roll}'></button>
        <input name='attr_roll_critical_damage_button' type='hidden' value='{{criticalrollmisc=[^{roll} ^{critical_damage}](~repeating_melee-strikes_CRITICAL_DAMAGE) }}' />
        <input name='attr_roll_critical_damage' type='hidden' value='@{damage_critical_roll}' />
        <!-- Show & hide hidden areas -->
        <input class='toggles' name='attr_toggles' type='hidden' value='display,settings,' />
        <div class='grid display'>
            <button class='pictos settings-button' name='act_settings' title='melee weapon settings' type='action'>
                y
            </button>
            <span class='sublabel darkred weapon' >weapon</span>
            <button class='display-weapon' name='roll_ATTACK-DAMAGE' title='weapon name display & attack and damage roll' type='roll'  value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{weapon}}} {{subheader=^{melee_strike}}} {{notes_show=@{roll_show_notes}}} {{notes=@{weapon_notes}}} @{weapon_roll} @{critical_confirm} @{damage_roll} @{roll_critical_damage} @{damage_additional_roll}'>
                <span name='attr_weapon'></span>
            </button>
            <button name='act_collapse' title='show or hide weapon notes' type='action'>
                4
            </button>
            <span class='sublabel darkred attack' >atk</span>
            <span class='sublabel darkred damage' >damage</span>
            <button class='display-attack' name='roll_ATTACK' title='weapon attack display & attack only roll' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{weapon}}} {{subheader=^{melee_strike}}} {{notes_show=@{roll_show_notes}}} {{notes=@{weapon_notes}}} @{weapon_roll} @{critical_confirm}'>
                <span class='weapon' name='attr_weapon_display'></span>
            </button>
            <button class='display-damage' name='roll_DAMAGE' title='weapon damage display & damage only roll' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{weapon}}} {{subheader=^{melee_strike}}} {{notes_show=@{roll_show_notes}}} {{notes=@{weapon_notes}}} @{damage_roll} @{roll_critical_damage} @{damage_additional_roll}'>
                <span class='weapon' name='attr_damage_display'></span>
            </button>
            <span class='collapse' name='attr_weapon_notes'></span>
        </div>
        <div class='settings'>
            <div class='grid'>
                <h2 class="weapon_name">weapon</h2>
                <label title='melee weapon name'>
                    <input name='attr_weapon' placeholder='weapon' spellcheck='false' title='@{weapon}' type='text' value='' />
                </label>
            </div>
            <div class='grid strikes-grid'>
                <div class='circle'>
                    <span name='attr_weapon_strike' title='@{weapon_strike}'></span>
                </div>
                <span class='symbol'>=</span>	
                <div class='ability-select'>
                    <label title='melee weapon strike ability select'>
                        <select name='attr_weapon_ability_select' title='@{weapon_ability_select}'>
                            <option value='@{strength_modifier}' selected>str</option>
                            <option value='@{dexterity_modifier}'>dex</option>
                            <option value='@{constitution_modifier}'>con</option>
                            <option value='@{intelligence_modifier}'>int</option>
                            <option value='@{wisdom_modifier}'>wis</option>
                            <option value='@{charisma_modifier}'>cha</option>
                            <option value='custom'>custom</option>
                        </select>
                    </label>
                    <label title='melee weapon strike ability'>
                        <input name='attr_weapon_ability' placeholder='0' spellcheck='false' title='@{weapon_ability}' type='text' value='0' />
                    </label>
                </div>
                <label class='sublabel' title='melee weapon strike item'>
                    <span class='sublabel darkred' >item</span>
                    <input name='attr_weapon_item' placeholder='0' spellcheck='false' title='@{weapon_item}' type='text' value='0' />
                </label>
                <label class='sublabel' title='melee weapon strike temporary'>
                    <span class='sublabel darkred' >temp</span>
                    <input name='attr_weapon_temporary' placeholder='0' spellcheck='false' title='@{weapon_temporary}' type='text' value='0' />
                </label>
            </div>
			<div class="grid weapon-attributes">
				<label class='sublabel' title='melee weapon strike temporary'>
					<span class='sublabel darkred' >crit range</span>
					<input name='attr_weapon_crit_range' placeholder='0' spellcheck='false' title='@{weapon_crit_range}' type='text' value='20' />
				</label>
				<label class='sublabel' title='melee weapon strike temporary'>
					<span class='sublabel darkred' >crit mult</span>
					<input name='attr_weapon_crit_mult' placeholder='0' spellcheck='false' title='@{weapon_crit_mult}' type='text' value='2' />
				</label>
			</div>
            <div>
                <label title='melee weapon traits'>
                    <span class='sublabel darkred' >traits</span>
                    <input name='attr_weapon_traits' placeholder='traits' spellcheck='false' title='@{weapon_traits}' type='text' value='' />
                </label>
            </div>
            <div class='grid damage-grid'>
                <h2 >damage</h2>
                <label class='sublabel' title='melee weapon damage number of dice'>
                    <span class='sublabel darkred' >dice</span>
                    <input name='attr_damage_dice' placeholder='1' title='@{damage_dice}' type='number' value='1' />
                </label>
                <label class='sublabel' title='melee weapon damage die size'>
                    <span class='sublabel darkred' >size</span>
                    <input name='attr_damage_dice_size' placeholder='d6' spellcheck='false' title='@{damage_dice_size}' type='text' value='d6' />
                </label>
                <span class='symbol'>+</span>
                <div class='ability-select'>
                    <label title='melee weapon damage ability select'>
                        <select name='attr_damage_ability_select' title='@{damage_ability_select}'>
                            <option value='@{strength_modifier}' selected>str</option>
                            <option value='@{dexterity_modifier}'>dex</option>
                            <option value='@{constitution_modifier}'>con</option>
                            <option value='@{intelligence_modifier}'>int</option>
                            <option value='@{wisdom_modifier}'>wis</option>
                            <option value='@{charisma_modifier}'>cha</option>
                            <option value='custom'>custom</option>
                        </select>
                    </label>
                    <label title='melee weapon damage ability'>
                        <input name='attr_damage_ability' placeholder='0' spellcheck='false' title='@{damage_ability}' type='text' value='0' />
                    </label>
                </div>
                <label class='sublabel' title='melee weapon other damage'>
                    <span class='sublabel darkred' >other</span>
                    <input name='attr_damage_other' placeholder='0' spellcheck='false' title='@{damage_other}' type='text' value='0' />
                </label>
                <label title='melee weapon damage supplementary effects'>
                    <span class='sublabel darkred' >effects</span>
                    <input name='attr_damage_effects' placeholder='effects' spellcheck='false' title='@{damage_effects}' type='text' value='' />
                </label>
                <label title='melee attack additional damage'>
                    <span class='sublabel darkred' >additional damage</span>
                    <input name='attr_damage_additional' placeholder='[[1d6]] acid, [[1d6]] chaotic, and [[1d6]] evil, and [[2d6]] slashing vs. plants' spellcheck='false' title='@{damage_additional}' type='text' value='' />
                </label>
            </div>
            <h2 name="notes">Notes</h2>
            <label title='melee weapon notes'>
                <textarea name='attr_weapon_notes' placeholder='notes' spellcheck='false' title='@{weapon_notes}' value=''></textarea>
            </label>
        </div>
    </fieldset>
</div><!-- Languages -->
<div class='languages background-color'>
    <h1 >languages</h1>
    <div class='repeating'>
        <fieldset class='repeating_languages'>
            <input class='toggles' name='attr_toggles' type='hidden' value='display,settings,' />
            <div class='grid repeating-grid'>
                <button class='pictos settings-button' name='act_settings' title='language settings' type='action'>
                    y
                </button>
                <button type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{language}}} {{subheader=^{language}}} {{notes_show=[[1]]}} {{notes=@{language_notes}}}'>
                    <span class='sheet-repeating-title' name='attr_language'></span>
                </button>
                <button name='act_collapse' title='show or hide language notes' type='action'>
                    4
                </button>
                <span class='collapse' name='attr_language_notes'></span>
            </div>
            <div class='settings repeating-grid'>
                <label title='language name'>
                    <span >name</span>
                    <input name='attr_language' placeholder='language' title='@{language}' type='text' value='' />
                </label>
                <label title='languages notes'>
                    <span >notes</span>
                    <textarea name='attr_language_notes' placeholder='notes' spellcheck='false' title='@{language_notes}'></textarea>
                </label>
            </div>
        </fieldset>
    </div>
</div>
</div><div class="column"><div class="armorclass background-color"><!--- ARMOR CLASS column --->
<h1>defense score</h1>
<!---AC Base row -->
<div class='grid armorclass-main'>
    <button class='pictos settings-button' name='act_toggle_armor_class' title='armor class settings' type='action'>
        y
    </button>
    <div class='circle'>
        <label title='defensive score'>
            <span>ds</span>
            <span class='ac-circle' name='attr_armor_class' title='@{ac}'></span>
        </label>
    </div>
    <div class='dcbase sublabel'>
        <span class='symbol'>=</span>
        <span class='sublabel'>dc base</span>
        <span class='sublabel'><b>10</b></span>
    </div>
    <div class='armor-cap'>
        <label class='sublabel' title='defense score modifier'>
            <span class='sublabel darkred'>mod</span>
            <span name='attr_armor_class_ability' title='@{armor_class_ability}'></span>
        </label>
        <span title="or">or</span>
        <div>
            <label class='sublabel' title='ability score modifier maximum'>
                <span class='sublabel darkred' >max mod</span>
                <span name='attr_armor_class_cap' title='@{armor_class_cap}'></span>
            </label>
        </div>
    </div>
    <label class='sublabel' title='shield bonus'>
        <span class='sublabel darkred' >shield</span>
        <span name='attr_armor_class_item' title='@{armor_class_item}'></span>
    </label>
	<label class='sublabel' title='defense score misc bonus'>
        <span class='sublabel darkred'>misc</span>
        <span name='attr_armor_class_misc' title='@{armor_class_misc}'></span>
    </label>
    <label class='sublabel' title='defense score temporary bonus'>
        <span class='sublabel darkred'>temp</span>
        <span name='attr_armor_class_temporary' title='@{armor_class_temporary}'></span>
    </label>
    <div class='settings grid'>
        <!-- The Dex & Cap section in Armor Class -->
        <div class='armor-cap'>
            <div class='ability-select'>
                <label title='armor class ability select'>
                    <select name='attr_armor_class_ability_select' title='@{armor_class_ability_select}'>
                        <option value='@{strength_modifier}'>str</option>
                        <option value='@{dexterity_modifier}' selected>dex</option>
                        <option value='@{constitution_modifier}'>con</option>
                        <option value='@{intelligence_modifier}'>int</option>
                        <option value='@{wisdom_modifier}'>wis</option>
                        <option value='@{charisma_modifier}'>cha</option>
                        <option value='custom'>custom</option>
                    </select>
                </label>
                <label title='armor class ability input'>
                   <input name='attr_armor_class_ability' placeholder='0' spellcheck='false' title='@{armor_class_ability}' type='text' value='' />
                </label>
            </div>
            <span title="or">or</span>
            <label title='ability score modifier maximum'>
                <span class='sublabel darkred' >max mod</span>
                <input name='attr_armor_class_cap' placeholder='0' spellcheck='false' title='@{armor_class_cap}' type='text' value='' />
            </label>
        </div>
        <label class='sublabel' title='shield bonus'>
            <span class='sublabel darkred' >shield</span>
            <input name='attr_armor_class_item' placeholder='0' spellcheck='false' title='@{armor_class_item}' type='text' value='0' />
        </label>
		<label class='sublabel' title='defense score misc bonus'>
            <span class='sublabel darkred' >misc</span>
            <input name='attr_armor_class_misc' placeholder='0' spellcheck='false' title='@{armor_class_misc}' type='text' value='0' />
        </label>
        <label class='sublabel' title='defense score temporary bonus'>
            <span class='sublabel darkred' >temp</span>
            <input name='attr_armor_class_temporary' placeholder='0' spellcheck='false' title='@{armor_class_temporary}' type='text' value='0' />
        </label>
        <label title='defense score notes'>
            <span >notes</span>
            <textarea name='attr_armor_class_notes' placeholder='notes' spellcheck='false' title='@{armor_class_notes}' value=''></textarea>
        </label>
    </div>
</div></div><div class="savingthrows background-color"><!-- Saving Throws -->
<h1>saving throws</h1>
<div class='grid display'>
    <button class='pictos settings-button' name='act_toggle_saving_throws' title='saving throw settings' type='action'>
        y
    </button>
	<div class='savingthrows-strength'>
        <button class='redstroke' name='roll_STRENGTHSAVE' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{strengthsave}}} {{subheader=^{saving_throw}}} {{roll01=[[1d20cs20cf1 + [@{saving_throws_strengthsave_proficiency_display}] (@{saving_throws_strengthsave})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=saving-throw}} {{notes_show=@{roll_show_notes}}} {{notes=@{saving_throws_notes}}}'>strength</button>
            <div class='circle' title="@{saving_throws_strengthsave}">
            <span class="proficiency" name='attr_saving_throws_strengthsave_proficiency_display'></span>
            <span name='attr_saving_throws_strengthsave'></span>
        </div>
    </div>
    <div class='savingthrows-fortitude'>
        <button class='redstroke' name='roll_FORT' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{fortitude}}} {{subheader=^{saving_throw}}} {{roll01=[[1d20cs20cf1 + [@{saving_throws_fortitude_proficiency_display}] (@{saving_throws_fortitude})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=saving-throw}} {{notes_show=@{roll_show_notes}}} {{notes=@{saving_throws_notes}}}'>fortitude</button>
        <div class='circle' title="@{saving_throws_fortitude}">
            <span class="proficiency" name='attr_saving_throws_fortitude_proficiency_display'></span>
            <span name='attr_saving_throws_fortitude'></span>
        </div>
    </div>
    <div class='savingthrows-reflex'>
        <button class='redstroke' name='roll_REF' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{reflex}}} {{subheader=^{saving_throw}}} {{roll01=[[1d20cs20cf1 + [@{saving_throws_reflex_proficiency_display}] (@{saving_throws_reflex})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=saving-throw}} {{notes_show=@{roll_show_notes}}} {{notes=@{saving_throws_notes}}}'>reflex</button>
        <div class='circle' title="@{saving_throws_reflex}">
            <span class="proficiency" name='attr_saving_throws_reflex_proficiency_display'></span>
            <span name='attr_saving_throws_reflex'></span>
        </div>
    </div>
    <div class='savingthrows-will'>
        <button class='redstroke' name='roll_WILL' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{will}}} {{subheader=^{saving_throw}}} {{roll01=[[1d20cs20cf1 + [@{saving_throws_will_proficiency_display}] (@{saving_throws_will})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=saving-throw}} {{notes_show=@{roll_show_notes}}} {{notes=@{saving_throws_notes}}}'>will</button>
            <div class='circle' title="@{saving_throws_will}">
            <span class="proficiency" name='attr_saving_throws_will_proficiency_display'></span>
            <span name='attr_saving_throws_will'></span>
        </div>
    </div>
</div>
<div class='grid settings'>
	<div class='grid'>
        <div class='ability-select'>
            <label title='strengthsave saving throw ability select'>
                <select name='attr_saving_throws_strengthsave_ability_select' title='@{saving_throws_strengthsave_ability_select}'>
                    <option value='@{strength_modifier}' selected>str</option>
                    <option value='@{dexterity_modifier}'>dex</option>
                    <option value='@{constitution_modifier}'>con</option>
                    <option value='@{intelligence_modifier}'>int</option>
                    <option value='@{wisdom_modifier}'>wis</option>
                    <option value='@{charisma_modifier}'>cha</option>
                    <option value='custom'>custom</option>
                </select>
            </label>
            <label title='strengthsave saving throw ability'>
                <input name='attr_saving_throws_strengthsave_ability' placeholder='0' spellcheck='false' title='@{saving_throws_strengthsave_ability}' type='text' value='' />
            </label>
        </div>
        <label class='sublabel' title='strengthsave saving throw rank select'>
            <span class='sublabel darkred' >rank</span>
            <select name='attr_saving_throws_strengthsave_rank' title='@{saving_throws_strengthsave_rank}'>
                <option value='0' selected>untrained</option>
                <option value='2'>level 1</option>
                <option value='4'>level 2</option>
                <option value='6'>level 3</option>
                <option value='8'>level 4</option>
                <option value='10'>level 5</option>
            </select>
        </label>
        <label class='sublabel' title='strengthsave item'>
            <span class='sublabel darkred' >item</span>
            <input name='attr_saving_throws_strengthsave_item' placeholder='0' spellcheck='false' title='@{saving_throws_strengthsave_item}' type='text' value='0' />
        </label>
        <label class='sublabel' title='strengthsave temporary'>
            <span class='sublabel darkred' >temp</span>
            <input name='attr_saving_throws_strengthsave_temporary' placeholder='0' spellcheck='false' title='@{saving_throws_strengthsave_temporary}' type='text' value='0' />
        </label>
    </div>

    <div class='grid'>
        <div class='ability-select'>
            <label title='fortitude saving throw ability select'>
                <select name='attr_saving_throws_fortitude_ability_select' title='@{saving_throws_fortitude_ability_select}'>
                    <option value='@{strength_modifier}'>str</option>
                    <option value='@{dexterity_modifier}'>dex</option>
                    <option value='@{constitution_modifier}' selected>con</option>
                    <option value='@{intelligence_modifier}'>int</option>
                    <option value='@{wisdom_modifier}'>wis</option>
                    <option value='@{charisma_modifier}'>cha</option>
                    <option value='custom'>custom</option>
                </select>
            </label>
            <label title='fortitude saving throw ability'>
                <input name='attr_saving_throws_fortitude_ability' placeholder='0' spellcheck='false' title='@{saving_throws_fortitude_ability}' type='text' value='' />
            </label>
        </div>
        <label class='sublabel' title='fortitude saving throw rank select'>
            <span class='sublabel darkred' >rank</span>
            <select name='attr_saving_throws_fortitude_rank' title='@{saving_throws_fortitude_rank}'>
                <option value='0' selected>untrained</option>
                <option value='2'>level 1</option>
                <option value='4'>level 2</option>
                <option value='6'>level 3</option>
                <option value='8'>level 4</option>
                <option value='10'>level 5</option>
            </select>
        </label>
        <label class='sublabel' title='fortitude item'>
            <span class='sublabel darkred' >item</span>
            <input name='attr_saving_throws_fortitude_item' placeholder='0' spellcheck='false' title='@{saving_throws_fortitude_item}' type='text' value='0' />
        </label>
        <label class='sublabel' title='fortitude temporary'>
            <span class='sublabel darkred' >temp</span>
            <input name='attr_saving_throws_fortitude_temporary' placeholder='0' spellcheck='false' title='@{saving_throws_fortitude_temporary}' type='text' value='0' />
        </label>
    </div>

    <div class='grid'>
        <div class='ability-select'>
            <label title='reflex saving throw ability select'>
                <select name='attr_saving_throws_reflex_ability_select' title='@{saving_throws_reflex_ability_select}'>
                    <option value='@{strength_modifier}'>str</option>
                    <option value='@{dexterity_modifier}' selected>dex</option>
                    <option value='@{constitution_modifier}'>con</option>
                    <option value='@{intelligence_modifier}'>int</option>
                    <option value='@{wisdom_modifier}'>wis</option>
                    <option value='@{charisma_modifier}'>cha</option>
                    <option value='custom'>custom</option>
                </select>
            </label>
            <label title='reflex saving throw ability'>
                <input name='attr_saving_throws_reflex_ability' placeholder='0' spellcheck='false' title='@{attr_saving_throws_reflex_ability}' type='text' value='' />
            </label>
        </div>
        <label class='sublabel' title='reflex saving throw rank select'>
            <span class='sublabel darkred' >rank</span>
            <select name='attr_saving_throws_reflex_rank' title='@{saving_throws_reflex_rank}'>
                <option value='0' selected>untrained</option>
                <option value='2'>level 1</option>
                <option value='4'>level 2</option>
                <option value='6'>level 3</option>
                <option value='8'>level 4</option>
                <option value='10'>level 5</option>
            </select>
        </label>
        <label class='sublabel' title='reflex item'>
            <span class='sublabel darkred' >item</span>
            <input name='attr_saving_throws_reflex_item' placeholder='0' spellcheck='false' title='@{saving_throws_reflex_item}' type='text' value='0' />
        </label>
        <label class='sublabel' title='reflex temporary'>
            <span class='sublabel darkred' >temp</span>
            <input name='attr_saving_throws_reflex_temporary' placeholder='0' spellcheck='false' title='@{saving_throws_reflex_temporary}' type='text' value='0' />
        </label>
    </div>

    <div class='grid'>
        <div class='ability-select'>
            <label title='will saving throw ability select'>
                <select name='attr_saving_throws_will_ability_select' title='@{saving_throws_will_ability_select}'>
                    <option value='@{strength_modifier}'>str</option>
                    <option value='@{dexterity_modifier}'>dex</option>
                    <option value='@{constitution_modifier}'>con</option>
                    <option value='@{intelligence_modifier}'>int</option>
                    <option value='@{wisdom_modifier}' selected>wis</option>
                    <option value='@{charisma_modifier}'>cha</option>
                    <option value='custom'>custom</option>
                </select>
            </label>
            <label title='will saving throw ability'>
                <input name='attr_saving_throws_will_ability' placeholder='0' spellcheck='false' title='@{saving_throws_will_ability}' type='text' value='' />
            </label>
        </div>
        <label class='sublabel' title='will saving throw rank select'>
            <span class='sublabel darkred' >rank</span>
            <select name='attr_saving_throws_will_rank' title='@{saving_throws_will_rank}'>
                <option value='0' selected>untrained</option>
                <option value='2'>level 1</option>
                <option value='4'>level 2</option>
                <option value='6'>level 3</option>
                <option value='8'>level 4</option>
                <option value='10'>level 5</option>
            </select>
        </label>
        <label class='sublabel' title='will item'>
            <span class='sublabel darkred' >item</span>
            <input name='attr_saving_throws_will_item' placeholder='0' spellcheck='false' title='@{saving_throws_will_item}' type='text' value='0' />
        </label>
        <label class='sublabel' title='will temporary'>
            <span class='sublabel darkred' >temp</span>
            <input name='attr_saving_throws_will_temporary' placeholder='0' spellcheck='false' title='@{saving_throws_will_temporary}' type='text' value='0' />
        </label>
    </div>

    <label title='saving throw notes'>
        <span >notes</span>
        <textarea name='attr_saving_throws_notes' placeholder='notes' spellcheck='false' title='@{saving_throws_notes}' value=''></textarea>
    </label>
</div>
</div><div class="initiative background-color"> <!-- Perception & Initiative -->
<div class='perception background-color'>
    <h1 >initiative</h1>
    <div class='grid display'>
        <div class='circle'>
            <span name='attr_perception' title='@{perception}'></span>
        </div>
        <button class='pictos settings-button' name='act_toggle_perception' title='perception settings' type='action'>
            y
        </button>
        <label class='sublabel' title='perception modifier'>
            <span class='sublabel darkred' >mod</span>
            <span name='attr_perception_ability' title='@{perception_ability}'></span>
        </label>
        <label class='sublabel' title='perception item'>
            <span class='sublabel darkred' >misc</span>
            <span name='attr_perception_item' title='@{perception_item}'></span>
        </label>
        <label class='sublabel' title='perception temporary'>
            <span class='sublabel darkred' >temp</span>
            <span name='attr_perception_temporary' title='@{perception_temporary}'></span>
        </label>
    </div>
    <div class='grid button-grid'>
        <button class='perception-button' name='roll_INITIATIVE' type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{initiative}}} {{subheader=^{@{initiative_skill}}}}  {{roll01=[[1d20cs20cf1 + (@{initiative}) + (@{initiative_modifier})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}] &{tracker}]]}} {{roll01_type=initiative}}'>initiative</button>
        <input name='attr_initiative' type='hidden' value='@{perception}[perception]' />
    </div>
    <div class='grid settings'>
        <div class='ability-select'>
            <label title='perception ability select'>
                <select name='attr_perception_ability_select' title='@{perception_ability_select}'>
                    <option value='@{strength_modifier}'>str</option>
                    <option value='@{dexterity_modifier}' selected>dex</option>
                    <option value='@{constitution_modifier}'>con</option>
                    <option value='@{intelligence_modifier}'>int</option>
                    <option value='@{wisdom_modifier}'>wis</option>
                    <option value='@{charisma_modifier}'>cha</option>
                    <option value='custom'>custom</option>
                </select>
            </label>
        </div>
        <label class='sublabel' title='perception item'>
            <span class='sublabel darkred' >misc</span>
            <input name='attr_perception_item' placeholder='0' title='@{perception_item}' type='text' value='0' />
        </label>
        <label class='sublabel' title='perception temporary'>
            <span class='sublabel darkred' >temp</span>
            <input name='attr_perception_temporary' placeholder='0' title='@{perception_temporary}' type='text' value='0' />
        </label>
        <label title='perception notes'>
            <span >notes</span>
            <textarea name='attr_perception_notes' placeholder='notes' title='@{perception_notes}' value=''></textarea>
        </label>
    </div>
    <div class='senses repeating'>
        <h3 >senses</h3>
        <fieldset class='repeating_senses'>
            <input class='toggles' name='attr_toggles' type='hidden' value='display,settings,' />
            <div class='grid repeating-grid'>
                <button class='pictos settings-button' name='act_settings' title='sense settings' type='action'>
                    y
                </button>
                <button type='roll' value='@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{sense}}} {{subheader=^{sense}}} {{notes_show=[[1]]}} {{notes=@{sense_notes}}}'>
                    <span class='repeating-title' name='attr_sense'></span>
                </button>
                <button name='act_collapse' title='show or hide sense notes' type='action'>
                    4
                </button>
                <span class='collapse' name='attr_sense_notes'></span>
            </div>
            <div class='settings repeating-grid'>
                <label title='sense name'>
                    <span >name</span>
                    <input name='attr_sense' placeholder='senses' title='@{sense}' type='text' value='' />
                </label>
                <label title='senses notes'>
                    <span >notes</span>
                    <textarea name='attr_sense_notes' placeholder='notes' spellcheck='false' title='@{sense_notes}'></textarea>
                </label>
            </div>
        </fieldset>
    </div>
</div>
</div><div class="skills background-color"><h1>skills</h1><div class="grid display"><button class="pictos settings-button" name="act_toggle_acrobatics" title="acrobatics settings" type="action">y</button><button class="h2" name="roll_ACROBATICS" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{acrobatics}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{acrobatics_proficiency_display}] (@{acrobatics})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{acrobatics_notes}}}">acrobatics</button><div class="circle"><span name="attr_acrobatics" title="@{acrobatics}"></span></div><span class="symbol">=</span><label class="sublabel" title="acrobatics ability modifier"><span class="sublabel darkred">mod</span><span name="attr_acrobatics_ability" title="@{acrobatics ability}"></span></label><label class="sublabel" title="acrobatics proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_acrobatics_proficiency_display"></span><span class="inline" name="attr_acrobatics_proficiency" title="@{acrobatics_proficiency}"></span></span></label><label class="sublabel" title="acrobatics item"><span class="sublabel darkred">item</span><span name="attr_acrobatics_item" title="@{acrobatics_item}"></span></label><label class="sublabel" title="acrobatics temporary"><span class="sublabel darkred">temp</span><span name="attr_acrobatics_temporary" title="@{acrobatics_temporary}"></span></label><label class="sublabel" title="acrobatics armor pentalty"><span class="sublabel darkred">armor</span><span name="attr_acrobatics_armor" title="@{acrobatics_armor}"></span></label></div><div class="grid settings acrobatics-settings"><div class="ability-select"><select name="attr_acrobatics_ability_select" title="@{acrobatics_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}" selected="">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="acrobatics ability input"><input name="attr_acrobatics_ability" placeholder="0" spellcheck="false" title="@{acrobatics_ability}" type="text" value=""/></label></div><label title="acrobatics rank select"><span class="sublabel darkred">rank</span><select name="attr_acrobatics_rank" title="@{acrobatics_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="acrobatics item"><span class="sublabel darkred">item</span><input name="attr_acrobatics_item" placeholder="0" spellcheck="false" title="@{acrobatics_item}" type="text" value=""/></label><label class="sublabel" title="acrobatics temporary"><span class="sublabel darkred">temp</span><input name="attr_acrobatics_temporary" placeholder="0" spellcheck="false" title="@{acrobatics_temporary}" type="text" value=""/></label><label class="sublabel" title="acrobatics armor pentalty"><span class="sublabel darkred">armor</span><input name="attr_acrobatics_armor" placeholder="0" spellcheck="false" title="@{acrobatics_armor}" type="text" value=""/></label><label title="acrobatics notes"><textarea name="attr_acrobatics_notes" placeholder="notes" spellcheck="false" title="@{acrobatics_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_alchemy" title="alchemy settings" type="action">y</button><button class="h2" name="roll_ALCHEMY" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{alchemy}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{alchemy_proficiency_display}] (@{alchemy})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{alchemy_notes}}}">alchemy</button><div class="circle"><span name="attr_alchemy" title="@{alchemy}"></span></div><span class="symbol">=</span><label class="sublabel" title="alchemy ability modifier"><span class="sublabel darkred">mod</span><span name="attr_alchemy_ability" title="@{alchemy ability}"></span></label><label class="sublabel" title="alchemy proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_alchemy_proficiency_display"></span><span class="inline" name="attr_alchemy_proficiency" title="@{alchemy_proficiency}"></span></span></label><label class="sublabel" title="alchemy item"><span class="sublabel darkred">item</span><span name="attr_alchemy_item" title="@{alchemy_item}"></span></label><label class="sublabel" title="alchemy temporary"><span class="sublabel darkred">temp</span><span name="attr_alchemy_temporary" title="@{alchemy_temporary}"></span></label></div><div class="grid settings alchemy-settings"><div class="ability-select"><select name="attr_alchemy_ability_select" title="@{alchemy_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}" selected="">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="alchemy ability input"><input name="attr_alchemy_ability" placeholder="0" spellcheck="false" title="@{alchemy_ability}" type="text" value=""/></label></div><label title="alchemy rank select"><span class="sublabel darkred">rank</span><select name="attr_alchemy_rank" title="@{alchemy_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="alchemy item"><span class="sublabel darkred">item</span><input name="attr_alchemy_item" placeholder="0" spellcheck="false" title="@{alchemy_item}" type="text" value=""/></label><label class="sublabel" title="alchemy temporary"><span class="sublabel darkred">temp</span><input name="attr_alchemy_temporary" placeholder="0" spellcheck="false" title="@{alchemy_temporary}" type="text" value=""/></label><label title="alchemy notes"><textarea name="attr_alchemy_notes" placeholder="notes" spellcheck="false" title="@{alchemy_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_athletics" title="athletics settings" type="action">y</button><button class="h2" name="roll_ATHLETICS" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{athletics}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{athletics_proficiency_display}] (@{athletics})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{athletics_notes}}}">athletics</button><div class="circle"><span name="attr_athletics" title="@{athletics}"></span></div><span class="symbol">=</span><label class="sublabel" title="athletics ability modifier"><span class="sublabel darkred">mod</span><span name="attr_athletics_ability" title="@{athletics ability}"></span></label><label class="sublabel" title="athletics proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_athletics_proficiency_display"></span><span class="inline" name="attr_athletics_proficiency" title="@{athletics_proficiency}"></span></span></label><label class="sublabel" title="athletics item"><span class="sublabel darkred">item</span><span name="attr_athletics_item" title="@{athletics_item}"></span></label><label class="sublabel" title="athletics temporary"><span class="sublabel darkred">temp</span><span name="attr_athletics_temporary" title="@{athletics_temporary}"></span></label><label class="sublabel" title="athletics armor pentalty"><span class="sublabel darkred">armor</span><span name="attr_athletics_armor" title="@{athletics_armor}"></span></label></div><div class="grid settings athletics-settings"><div class="ability-select"><select name="attr_athletics_ability_select" title="@{athletics_ability_select}"><option value="@{strength_modifier}" selected="">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="athletics ability input"><input name="attr_athletics_ability" placeholder="0" spellcheck="false" title="@{athletics_ability}" type="text" value=""/></label></div><label title="athletics rank select"><span class="sublabel darkred">rank</span><select name="attr_athletics_rank" title="@{athletics_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="athletics item"><span class="sublabel darkred">item</span><input name="attr_athletics_item" placeholder="0" spellcheck="false" title="@{athletics_item}" type="text" value=""/></label><label class="sublabel" title="athletics temporary"><span class="sublabel darkred">temp</span><input name="attr_athletics_temporary" placeholder="0" spellcheck="false" title="@{athletics_temporary}" type="text" value=""/></label><label class="sublabel" title="athletics armor pentalty"><span class="sublabel darkred">armor</span><input name="attr_athletics_armor" placeholder="0" spellcheck="false" title="@{athletics_armor}" type="text" value=""/></label><label title="athletics notes"><textarea name="attr_athletics_notes" placeholder="notes" spellcheck="false" title="@{athletics_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_awareness" title="awareness settings" type="action">y</button><button class="h2" name="roll_AWARENESS" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{awareness}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{awareness_proficiency_display}] (@{awareness})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{awareness_notes}}}">awareness</button><div class="circle"><span name="attr_awareness" title="@{awareness}"></span></div><span class="symbol">=</span><label class="sublabel" title="awareness ability modifier"><span class="sublabel darkred">mod</span><span name="attr_awareness_ability" title="@{awareness ability}"></span></label><label class="sublabel" title="awareness proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_awareness_proficiency_display"></span><span class="inline" name="attr_awareness_proficiency" title="@{awareness_proficiency}"></span></span></label><label class="sublabel" title="awareness item"><span class="sublabel darkred">item</span><span name="attr_awareness_item" title="@{awareness_item}"></span></label><label class="sublabel" title="awareness temporary"><span class="sublabel darkred">temp</span><span name="attr_awareness_temporary" title="@{awareness_temporary}"></span></label></div><div class="grid settings awareness-settings"><div class="ability-select"><select name="attr_awareness_ability_select" title="@{awareness_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}" selected="">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="awareness ability input"><input name="attr_awareness_ability" placeholder="0" spellcheck="false" title="@{awareness_ability}" type="text" value=""/></label></div><label title="awareness rank select"><span class="sublabel darkred">rank</span><select name="attr_awareness_rank" title="@{awareness_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="awareness item"><span class="sublabel darkred">item</span><input name="attr_awareness_item" placeholder="0" spellcheck="false" title="@{awareness_item}" type="text" value=""/></label><label class="sublabel" title="awareness temporary"><span class="sublabel darkred">temp</span><input name="attr_awareness_temporary" placeholder="0" spellcheck="false" title="@{awareness_temporary}" type="text" value=""/></label><label title="awareness notes"><textarea name="attr_awareness_notes" placeholder="notes" spellcheck="false" title="@{awareness_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_charm" title="charm settings" type="action">y</button><button class="h2" name="roll_CHARM" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{charm}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{charm_proficiency_display}] (@{charm})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{charm_notes}}}">charm</button><div class="circle"><span name="attr_charm" title="@{charm}"></span></div><span class="symbol">=</span><label class="sublabel" title="charm ability modifier"><span class="sublabel darkred">mod</span><span name="attr_charm_ability" title="@{charm ability}"></span></label><label class="sublabel" title="charm proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_charm_proficiency_display"></span><span class="inline" name="attr_charm_proficiency" title="@{charm_proficiency}"></span></span></label><label class="sublabel" title="charm item"><span class="sublabel darkred">item</span><span name="attr_charm_item" title="@{charm_item}"></span></label><label class="sublabel" title="charm temporary"><span class="sublabel darkred">temp</span><span name="attr_charm_temporary" title="@{charm_temporary}"></span></label></div><div class="grid settings charm-settings"><div class="ability-select"><select name="attr_charm_ability_select" title="@{charm_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}" selected="">cha</option><option value="custom">custom</option></select><label title="charm ability input"><input name="attr_charm_ability" placeholder="0" spellcheck="false" title="@{charm_ability}" type="text" value=""/></label></div><label title="charm rank select"><span class="sublabel darkred">rank</span><select name="attr_charm_rank" title="@{charm_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="charm item"><span class="sublabel darkred">item</span><input name="attr_charm_item" placeholder="0" spellcheck="false" title="@{charm_item}" type="text" value=""/></label><label class="sublabel" title="charm temporary"><span class="sublabel darkred">temp</span><input name="attr_charm_temporary" placeholder="0" spellcheck="false" title="@{charm_temporary}" type="text" value=""/></label><label title="charm notes"><textarea name="attr_charm_notes" placeholder="notes" spellcheck="false" title="@{charm_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_craft" title="craft settings" type="action">y</button><button class="h2" name="roll_CRAFT" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{craft}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{craft_proficiency_display}] (@{craft})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{craft_notes}}}">craft</button><div class="circle"><span name="attr_craft" title="@{craft}"></span></div><span class="symbol">=</span><label class="sublabel" title="craft ability modifier"><span class="sublabel darkred">mod</span><span name="attr_craft_ability" title="@{craft ability}"></span></label><label class="sublabel" title="craft proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_craft_proficiency_display"></span><span class="inline" name="attr_craft_proficiency" title="@{craft_proficiency}"></span></span></label><label class="sublabel" title="craft item"><span class="sublabel darkred">item</span><span name="attr_craft_item" title="@{craft_item}"></span></label><label class="sublabel" title="craft temporary"><span class="sublabel darkred">temp</span><span name="attr_craft_temporary" title="@{craft_temporary}"></span></label></div><div class="grid settings craft-settings"><div class="ability-select"><select name="attr_craft_ability_select" title="@{craft_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}" selected="">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="craft ability input"><input name="attr_craft_ability" placeholder="0" spellcheck="false" title="@{craft_ability}" type="text" value=""/></label></div><label title="craft rank select"><span class="sublabel darkred">rank</span><select name="attr_craft_rank" title="@{craft_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="craft item"><span class="sublabel darkred">item</span><input name="attr_craft_item" placeholder="0" spellcheck="false" title="@{craft_item}" type="text" value=""/></label><label class="sublabel" title="craft temporary"><span class="sublabel darkred">temp</span><input name="attr_craft_temporary" placeholder="0" spellcheck="false" title="@{craft_temporary}" type="text" value=""/></label><label title="craft notes"><textarea name="attr_craft_notes" placeholder="notes" spellcheck="false" title="@{craft_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_deception" title="deception settings" type="action">y</button><button class="h2" name="roll_DECEPTION" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{deception}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{deception_proficiency_display}] (@{deception})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{deception_notes}}}">deception</button><div class="circle"><span name="attr_deception" title="@{deception}"></span></div><span class="symbol">=</span><label class="sublabel" title="deception ability modifier"><span class="sublabel darkred">mod</span><span name="attr_deception_ability" title="@{deception ability}"></span></label><label class="sublabel" title="deception proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_deception_proficiency_display"></span><span class="inline" name="attr_deception_proficiency" title="@{deception_proficiency}"></span></span></label><label class="sublabel" title="deception item"><span class="sublabel darkred">item</span><span name="attr_deception_item" title="@{deception_item}"></span></label><label class="sublabel" title="deception temporary"><span class="sublabel darkred">temp</span><span name="attr_deception_temporary" title="@{deception_temporary}"></span></label></div><div class="grid settings deception-settings"><div class="ability-select"><select name="attr_deception_ability_select" title="@{deception_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}" selected="">cha</option><option value="custom">custom</option></select><label title="deception ability input"><input name="attr_deception_ability" placeholder="0" spellcheck="false" title="@{deception_ability}" type="text" value=""/></label></div><label title="deception rank select"><span class="sublabel darkred">rank</span><select name="attr_deception_rank" title="@{deception_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="deception item"><span class="sublabel darkred">item</span><input name="attr_deception_item" placeholder="0" spellcheck="false" title="@{deception_item}" type="text" value=""/></label><label class="sublabel" title="deception temporary"><span class="sublabel darkred">temp</span><input name="attr_deception_temporary" placeholder="0" spellcheck="false" title="@{deception_temporary}" type="text" value=""/></label><label title="deception notes"><textarea name="attr_deception_notes" placeholder="notes" spellcheck="false" title="@{deception_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_husbandry" title="husbandry settings" type="action">y</button><button class="h2" name="roll_HUSBANDRY" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{husbandry}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{husbandry_proficiency_display}] (@{husbandry})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{husbandry_notes}}}">husbandry</button><div class="circle"><span name="attr_husbandry" title="@{husbandry}"></span></div><span class="symbol">=</span><label class="sublabel" title="husbandry ability modifier"><span class="sublabel darkred">mod</span><span name="attr_husbandry_ability" title="@{husbandry ability}"></span></label><label class="sublabel" title="husbandry proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_husbandry_proficiency_display"></span><span class="inline" name="attr_husbandry_proficiency" title="@{husbandry_proficiency}"></span></span></label><label class="sublabel" title="husbandry item"><span class="sublabel darkred">item</span><span name="attr_husbandry_item" title="@{husbandry_item}"></span></label><label class="sublabel" title="husbandry temporary"><span class="sublabel darkred">temp</span><span name="attr_husbandry_temporary" title="@{husbandry_temporary}"></span></label></div><div class="grid settings husbandry-settings"><div class="ability-select"><select name="attr_husbandry_ability_select" title="@{husbandry_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}" selected="">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="husbandry ability input"><input name="attr_husbandry_ability" placeholder="0" spellcheck="false" title="@{husbandry_ability}" type="text" value=""/></label></div><label title="husbandry rank select"><span class="sublabel darkred">rank</span><select name="attr_husbandry_rank" title="@{husbandry_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="husbandry item"><span class="sublabel darkred">item</span><input name="attr_husbandry_item" placeholder="0" spellcheck="false" title="@{husbandry_item}" type="text" value=""/></label><label class="sublabel" title="husbandry temporary"><span class="sublabel darkred">temp</span><input name="attr_husbandry_temporary" placeholder="0" spellcheck="false" title="@{husbandry_temporary}" type="text" value=""/></label><label title="husbandry notes"><textarea name="attr_husbandry_notes" placeholder="notes" spellcheck="false" title="@{husbandry_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_insight" title="insight settings" type="action">y</button><button class="h2" name="roll_INSIGHT" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{insight}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{insight_proficiency_display}] (@{insight})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{insight_notes}}}">insight</button><div class="circle"><span name="attr_insight" title="@{insight}"></span></div><span class="symbol">=</span><label class="sublabel" title="insight ability modifier"><span class="sublabel darkred">mod</span><span name="attr_insight_ability" title="@{insight ability}"></span></label><label class="sublabel" title="insight proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_insight_proficiency_display"></span><span class="inline" name="attr_insight_proficiency" title="@{insight_proficiency}"></span></span></label><label class="sublabel" title="insight item"><span class="sublabel darkred">item</span><span name="attr_insight_item" title="@{insight_item}"></span></label><label class="sublabel" title="insight temporary"><span class="sublabel darkred">temp</span><span name="attr_insight_temporary" title="@{insight_temporary}"></span></label></div><div class="grid settings insight-settings"><div class="ability-select"><select name="attr_insight_ability_select" title="@{insight_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}" selected="">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="insight ability input"><input name="attr_insight_ability" placeholder="0" spellcheck="false" title="@{insight_ability}" type="text" value=""/></label></div><label title="insight rank select"><span class="sublabel darkred">rank</span><select name="attr_insight_rank" title="@{insight_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="insight item"><span class="sublabel darkred">item</span><input name="attr_insight_item" placeholder="0" spellcheck="false" title="@{insight_item}" type="text" value=""/></label><label class="sublabel" title="insight temporary"><span class="sublabel darkred">temp</span><input name="attr_insight_temporary" placeholder="0" spellcheck="false" title="@{insight_temporary}" type="text" value=""/></label><label title="insight notes"><textarea name="attr_insight_notes" placeholder="notes" spellcheck="false" title="@{insight_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_intimidation" title="intimidation settings" type="action">y</button><button class="h2" name="roll_INTIMIDATION" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{intimidation}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{intimidation_proficiency_display}] (@{intimidation})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{intimidation_notes}}}">intimidation</button><div class="circle"><span name="attr_intimidation" title="@{intimidation}"></span></div><span class="symbol">=</span><label class="sublabel" title="intimidation ability modifier"><span class="sublabel darkred">mod</span><span name="attr_intimidation_ability" title="@{intimidation ability}"></span></label><label class="sublabel" title="intimidation proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_intimidation_proficiency_display"></span><span class="inline" name="attr_intimidation_proficiency" title="@{intimidation_proficiency}"></span></span></label><label class="sublabel" title="intimidation item"><span class="sublabel darkred">item</span><span name="attr_intimidation_item" title="@{intimidation_item}"></span></label><label class="sublabel" title="intimidation temporary"><span class="sublabel darkred">temp</span><span name="attr_intimidation_temporary" title="@{intimidation_temporary}"></span></label></div><div class="grid settings intimidation-settings"><div class="ability-select"><select name="attr_intimidation_ability_select" title="@{intimidation_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}" selected="">cha</option><option value="custom">custom</option></select><label title="intimidation ability input"><input name="attr_intimidation_ability" placeholder="0" spellcheck="false" title="@{intimidation_ability}" type="text" value=""/></label></div><label title="intimidation rank select"><span class="sublabel darkred">rank</span><select name="attr_intimidation_rank" title="@{intimidation_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="intimidation item"><span class="sublabel darkred">item</span><input name="attr_intimidation_item" placeholder="0" spellcheck="false" title="@{intimidation_item}" type="text" value=""/></label><label class="sublabel" title="intimidation temporary"><span class="sublabel darkred">temp</span><input name="attr_intimidation_temporary" placeholder="0" spellcheck="false" title="@{intimidation_temporary}" type="text" value=""/></label><label title="intimidation notes"><textarea name="attr_intimidation_notes" placeholder="notes" spellcheck="false" title="@{intimidation_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_investigation" title="investigation settings" type="action">y</button><button class="h2" name="roll_INVESTIGATION" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{investigation}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{investigation_proficiency_display}] (@{investigation})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{investigation_notes}}}">investigation</button><div class="circle"><span name="attr_investigation" title="@{investigation}"></span></div><span class="symbol">=</span><label class="sublabel" title="investigation ability modifier"><span class="sublabel darkred">mod</span><span name="attr_investigation_ability" title="@{investigation ability}"></span></label><label class="sublabel" title="investigation proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_investigation_proficiency_display"></span><span class="inline" name="attr_investigation_proficiency" title="@{investigation_proficiency}"></span></span></label><label class="sublabel" title="investigation item"><span class="sublabel darkred">item</span><span name="attr_investigation_item" title="@{investigation_item}"></span></label><label class="sublabel" title="investigation temporary"><span class="sublabel darkred">temp</span><span name="attr_investigation_temporary" title="@{investigation_temporary}"></span></label></div><div class="grid settings investigation-settings"><div class="ability-select"><select name="attr_investigation_ability_select" title="@{investigation_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}" selected="">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="investigation ability input"><input name="attr_investigation_ability" placeholder="0" spellcheck="false" title="@{investigation_ability}" type="text" value=""/></label></div><label title="investigation rank select"><span class="sublabel darkred">rank</span><select name="attr_investigation_rank" title="@{investigation_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="investigation item"><span class="sublabel darkred">item</span><input name="attr_investigation_item" placeholder="0" spellcheck="false" title="@{investigation_item}" type="text" value=""/></label><label class="sublabel" title="investigation temporary"><span class="sublabel darkred">temp</span><input name="attr_investigation_temporary" placeholder="0" spellcheck="false" title="@{investigation_temporary}" type="text" value=""/></label><label title="investigation notes"><textarea name="attr_investigation_notes" placeholder="notes" spellcheck="false" title="@{investigation_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_lore" title="lore settings" type="action">y</button><button class="h2" name="roll_LORE" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{lore}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{lore_proficiency_display}] (@{lore})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{lore_notes}}}">lore</button><div class="circle"><span name="attr_lore" title="@{lore}"></span></div><span class="symbol">=</span><label class="sublabel" title="lore ability modifier"><span class="sublabel darkred">mod</span><span name="attr_lore_ability" title="@{lore ability}"></span></label><label class="sublabel" title="lore proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_lore_proficiency_display"></span><span class="inline" name="attr_lore_proficiency" title="@{lore_proficiency}"></span></span></label><label class="sublabel" title="lore item"><span class="sublabel darkred">item</span><span name="attr_lore_item" title="@{lore_item}"></span></label><label class="sublabel" title="lore temporary"><span class="sublabel darkred">temp</span><span name="attr_lore_temporary" title="@{lore_temporary}"></span></label></div><div class="grid settings lore-settings"><div class="ability-select"><select name="attr_lore_ability_select" title="@{lore_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}" selected="">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="lore ability input"><input name="attr_lore_ability" placeholder="0" spellcheck="false" title="@{lore_ability}" type="text" value=""/></label></div><label title="lore rank select"><span class="sublabel darkred">rank</span><select name="attr_lore_rank" title="@{lore_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="lore item"><span class="sublabel darkred">item</span><input name="attr_lore_item" placeholder="0" spellcheck="false" title="@{lore_item}" type="text" value=""/></label><label class="sublabel" title="lore temporary"><span class="sublabel darkred">temp</span><input name="attr_lore_temporary" placeholder="0" spellcheck="false" title="@{lore_temporary}" type="text" value=""/></label><label title="lore notes"><textarea name="attr_lore_notes" placeholder="notes" spellcheck="false" title="@{lore_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_medicine" title="medicine settings" type="action">y</button><button class="h2" name="roll_MEDICINE" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{medicine}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{medicine_proficiency_display}] (@{medicine})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{medicine_notes}}}">medicine</button><div class="circle"><span name="attr_medicine" title="@{medicine}"></span></div><span class="symbol">=</span><label class="sublabel" title="medicine ability modifier"><span class="sublabel darkred">mod</span><span name="attr_medicine_ability" title="@{medicine ability}"></span></label><label class="sublabel" title="medicine proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_medicine_proficiency_display"></span><span class="inline" name="attr_medicine_proficiency" title="@{medicine_proficiency}"></span></span></label><label class="sublabel" title="medicine item"><span class="sublabel darkred">item</span><span name="attr_medicine_item" title="@{medicine_item}"></span></label><label class="sublabel" title="medicine temporary"><span class="sublabel darkred">temp</span><span name="attr_medicine_temporary" title="@{medicine_temporary}"></span></label></div><div class="grid settings medicine-settings"><div class="ability-select"><select name="attr_medicine_ability_select" title="@{medicine_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}" selected="">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="medicine ability input"><input name="attr_medicine_ability" placeholder="0" spellcheck="false" title="@{medicine_ability}" type="text" value=""/></label></div><label title="medicine rank select"><span class="sublabel darkred">rank</span><select name="attr_medicine_rank" title="@{medicine_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="medicine item"><span class="sublabel darkred">item</span><input name="attr_medicine_item" placeholder="0" spellcheck="false" title="@{medicine_item}" type="text" value=""/></label><label class="sublabel" title="medicine temporary"><span class="sublabel darkred">temp</span><input name="attr_medicine_temporary" placeholder="0" spellcheck="false" title="@{medicine_temporary}" type="text" value=""/></label><label title="medicine notes"><textarea name="attr_medicine_notes" placeholder="notes" spellcheck="false" title="@{medicine_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_navigation" title="navigation settings" type="action">y</button><button class="h2" name="roll_NAVIGATION" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{navigation}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{navigation_proficiency_display}] (@{navigation})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{navigation_notes}}}">navigation</button><div class="circle"><span name="attr_navigation" title="@{navigation}"></span></div><span class="symbol">=</span><label class="sublabel" title="navigation ability modifier"><span class="sublabel darkred">mod</span><span name="attr_navigation_ability" title="@{navigation ability}"></span></label><label class="sublabel" title="navigation proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_navigation_proficiency_display"></span><span class="inline" name="attr_navigation_proficiency" title="@{navigation_proficiency}"></span></span></label><label class="sublabel" title="navigation item"><span class="sublabel darkred">item</span><span name="attr_navigation_item" title="@{navigation_item}"></span></label><label class="sublabel" title="navigation temporary"><span class="sublabel darkred">temp</span><span name="attr_navigation_temporary" title="@{navigation_temporary}"></span></label></div><div class="grid settings navigation-settings"><div class="ability-select"><select name="attr_navigation_ability_select" title="@{navigation_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}" selected="">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="navigation ability input"><input name="attr_navigation_ability" placeholder="0" spellcheck="false" title="@{navigation_ability}" type="text" value=""/></label></div><label title="navigation rank select"><span class="sublabel darkred">rank</span><select name="attr_navigation_rank" title="@{navigation_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="navigation item"><span class="sublabel darkred">item</span><input name="attr_navigation_item" placeholder="0" spellcheck="false" title="@{navigation_item}" type="text" value=""/></label><label class="sublabel" title="navigation temporary"><span class="sublabel darkred">temp</span><input name="attr_navigation_temporary" placeholder="0" spellcheck="false" title="@{navigation_temporary}" type="text" value=""/></label><label title="navigation notes"><textarea name="attr_navigation_notes" placeholder="notes" spellcheck="false" title="@{navigation_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_operate" title="operate settings" type="action">y</button><button class="h2" name="roll_OPERATE" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{operate}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{operate_proficiency_display}] (@{operate})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{operate_notes}}}">operate</button><div class="circle"><span name="attr_operate" title="@{operate}"></span></div><span class="symbol">=</span><label class="sublabel" title="operate ability modifier"><span class="sublabel darkred">mod</span><span name="attr_operate_ability" title="@{operate ability}"></span></label><label class="sublabel" title="operate proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_operate_proficiency_display"></span><span class="inline" name="attr_operate_proficiency" title="@{operate_proficiency}"></span></span></label><label class="sublabel" title="operate item"><span class="sublabel darkred">item</span><span name="attr_operate_item" title="@{operate_item}"></span></label><label class="sublabel" title="operate temporary"><span class="sublabel darkred">temp</span><span name="attr_operate_temporary" title="@{operate_temporary}"></span></label></div><div class="grid settings operate-settings"><div class="ability-select"><select name="attr_operate_ability_select" title="@{operate_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}" selected="">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="operate ability input"><input name="attr_operate_ability" placeholder="0" spellcheck="false" title="@{operate_ability}" type="text" value=""/></label></div><label title="operate rank select"><span class="sublabel darkred">rank</span><select name="attr_operate_rank" title="@{operate_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="operate item"><span class="sublabel darkred">item</span><input name="attr_operate_item" placeholder="0" spellcheck="false" title="@{operate_item}" type="text" value=""/></label><label class="sublabel" title="operate temporary"><span class="sublabel darkred">temp</span><input name="attr_operate_temporary" placeholder="0" spellcheck="false" title="@{operate_temporary}" type="text" value=""/></label><label title="operate notes"><textarea name="attr_operate_notes" placeholder="notes" spellcheck="false" title="@{operate_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_performance" title="performance settings" type="action">y</button><button class="h2" name="roll_PERFORMANCE" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{performance}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{performance_proficiency_display}] (@{performance})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{performance_notes}}}">performance</button><div class="circle"><span name="attr_performance" title="@{performance}"></span></div><span class="symbol">=</span><label class="sublabel" title="performance ability modifier"><span class="sublabel darkred">mod</span><span name="attr_performance_ability" title="@{performance ability}"></span></label><label class="sublabel" title="performance proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_performance_proficiency_display"></span><span class="inline" name="attr_performance_proficiency" title="@{performance_proficiency}"></span></span></label><label class="sublabel" title="performance item"><span class="sublabel darkred">item</span><span name="attr_performance_item" title="@{performance_item}"></span></label><label class="sublabel" title="performance temporary"><span class="sublabel darkred">temp</span><span name="attr_performance_temporary" title="@{performance_temporary}"></span></label></div><div class="grid settings performance-settings"><div class="ability-select"><select name="attr_performance_ability_select" title="@{performance_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}" selected="">cha</option><option value="custom">custom</option></select><label title="performance ability input"><input name="attr_performance_ability" placeholder="0" spellcheck="false" title="@{performance_ability}" type="text" value=""/></label></div><label title="performance rank select"><span class="sublabel darkred">rank</span><select name="attr_performance_rank" title="@{performance_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="performance item"><span class="sublabel darkred">item</span><input name="attr_performance_item" placeholder="0" spellcheck="false" title="@{performance_item}" type="text" value=""/></label><label class="sublabel" title="performance temporary"><span class="sublabel darkred">temp</span><input name="attr_performance_temporary" placeholder="0" spellcheck="false" title="@{performance_temporary}" type="text" value=""/></label><label title="performance notes"><textarea name="attr_performance_notes" placeholder="notes" spellcheck="false" title="@{performance_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_religion" title="religion settings" type="action">y</button><button class="h2" name="roll_RELIGION" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{religion}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{religion_proficiency_display}] (@{religion})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{religion_notes}}}">religion</button><div class="circle"><span name="attr_religion" title="@{religion}"></span></div><span class="symbol">=</span><label class="sublabel" title="religion ability modifier"><span class="sublabel darkred">mod</span><span name="attr_religion_ability" title="@{religion ability}"></span></label><label class="sublabel" title="religion proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_religion_proficiency_display"></span><span class="inline" name="attr_religion_proficiency" title="@{religion_proficiency}"></span></span></label><label class="sublabel" title="religion item"><span class="sublabel darkred">item</span><span name="attr_religion_item" title="@{religion_item}"></span></label><label class="sublabel" title="religion temporary"><span class="sublabel darkred">temp</span><span name="attr_religion_temporary" title="@{religion_temporary}"></span></label></div><div class="grid settings religion-settings"><div class="ability-select"><select name="attr_religion_ability_select" title="@{religion_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}" selected="">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="religion ability input"><input name="attr_religion_ability" placeholder="0" spellcheck="false" title="@{religion_ability}" type="text" value=""/></label></div><label title="religion rank select"><span class="sublabel darkred">rank</span><select name="attr_religion_rank" title="@{religion_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="religion item"><span class="sublabel darkred">item</span><input name="attr_religion_item" placeholder="0" spellcheck="false" title="@{religion_item}" type="text" value=""/></label><label class="sublabel" title="religion temporary"><span class="sublabel darkred">temp</span><input name="attr_religion_temporary" placeholder="0" spellcheck="false" title="@{religion_temporary}" type="text" value=""/></label><label title="religion notes"><textarea name="attr_religion_notes" placeholder="notes" spellcheck="false" title="@{religion_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_repair" title="repair settings" type="action">y</button><button class="h2" name="roll_REPAIR" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{repair}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{repair_proficiency_display}] (@{repair})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{repair_notes}}}">repair</button><div class="circle"><span name="attr_repair" title="@{repair}"></span></div><span class="symbol">=</span><label class="sublabel" title="repair ability modifier"><span class="sublabel darkred">mod</span><span name="attr_repair_ability" title="@{repair ability}"></span></label><label class="sublabel" title="repair proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_repair_proficiency_display"></span><span class="inline" name="attr_repair_proficiency" title="@{repair_proficiency}"></span></span></label><label class="sublabel" title="repair item"><span class="sublabel darkred">item</span><span name="attr_repair_item" title="@{repair_item}"></span></label><label class="sublabel" title="repair temporary"><span class="sublabel darkred">temp</span><span name="attr_repair_temporary" title="@{repair_temporary}"></span></label></div><div class="grid settings repair-settings"><div class="ability-select"><select name="attr_repair_ability_select" title="@{repair_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}" selected="">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="repair ability input"><input name="attr_repair_ability" placeholder="0" spellcheck="false" title="@{repair_ability}" type="text" value=""/></label></div><label title="repair rank select"><span class="sublabel darkred">rank</span><select name="attr_repair_rank" title="@{repair_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="repair item"><span class="sublabel darkred">item</span><input name="attr_repair_item" placeholder="0" spellcheck="false" title="@{repair_item}" type="text" value=""/></label><label class="sublabel" title="repair temporary"><span class="sublabel darkred">temp</span><input name="attr_repair_temporary" placeholder="0" spellcheck="false" title="@{repair_temporary}" type="text" value=""/></label><label title="repair notes"><textarea name="attr_repair_notes" placeholder="notes" spellcheck="false" title="@{repair_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_stealth" title="stealth settings" type="action">y</button><button class="h2" name="roll_STEALTH" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{stealth}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{stealth_proficiency_display}] (@{stealth})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{stealth_notes}}}">stealth</button><div class="circle"><span name="attr_stealth" title="@{stealth}"></span></div><span class="symbol">=</span><label class="sublabel" title="stealth ability modifier"><span class="sublabel darkred">mod</span><span name="attr_stealth_ability" title="@{stealth ability}"></span></label><label class="sublabel" title="stealth proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_stealth_proficiency_display"></span><span class="inline" name="attr_stealth_proficiency" title="@{stealth_proficiency}"></span></span></label><label class="sublabel" title="stealth item"><span class="sublabel darkred">item</span><span name="attr_stealth_item" title="@{stealth_item}"></span></label><label class="sublabel" title="stealth temporary"><span class="sublabel darkred">temp</span><span name="attr_stealth_temporary" title="@{stealth_temporary}"></span></label><label class="sublabel" title="stealth armor pentalty"><span class="sublabel darkred">armor</span><span name="attr_stealth_armor" title="@{stealth_armor}"></span></label></div><div class="grid settings stealth-settings"><div class="ability-select"><select name="attr_stealth_ability_select" title="@{stealth_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}" selected="">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="stealth ability input"><input name="attr_stealth_ability" placeholder="0" spellcheck="false" title="@{stealth_ability}" type="text" value=""/></label></div><label title="stealth rank select"><span class="sublabel darkred">rank</span><select name="attr_stealth_rank" title="@{stealth_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="stealth item"><span class="sublabel darkred">item</span><input name="attr_stealth_item" placeholder="0" spellcheck="false" title="@{stealth_item}" type="text" value=""/></label><label class="sublabel" title="stealth temporary"><span class="sublabel darkred">temp</span><input name="attr_stealth_temporary" placeholder="0" spellcheck="false" title="@{stealth_temporary}" type="text" value=""/></label><label class="sublabel" title="stealth armor pentalty"><span class="sublabel darkred">armor</span><input name="attr_stealth_armor" placeholder="0" spellcheck="false" title="@{stealth_armor}" type="text" value=""/></label><label title="stealth notes"><textarea name="attr_stealth_notes" placeholder="notes" spellcheck="false" title="@{stealth_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_survival" title="survival settings" type="action">y</button><button class="h2" name="roll_SURVIVAL" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{survival}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{survival_proficiency_display}] (@{survival})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{survival_notes}}}">survival</button><div class="circle"><span name="attr_survival" title="@{survival}"></span></div><span class="symbol">=</span><label class="sublabel" title="survival ability modifier"><span class="sublabel darkred">mod</span><span name="attr_survival_ability" title="@{survival ability}"></span></label><label class="sublabel" title="survival proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_survival_proficiency_display"></span><span class="inline" name="attr_survival_proficiency" title="@{survival_proficiency}"></span></span></label><label class="sublabel" title="survival item"><span class="sublabel darkred">item</span><span name="attr_survival_item" title="@{survival_item}"></span></label><label class="sublabel" title="survival temporary"><span class="sublabel darkred">temp</span><span name="attr_survival_temporary" title="@{survival_temporary}"></span></label></div><div class="grid settings survival-settings"><div class="ability-select"><select name="attr_survival_ability_select" title="@{survival_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}" selected="">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="survival ability input"><input name="attr_survival_ability" placeholder="0" spellcheck="false" title="@{survival_ability}" type="text" value=""/></label></div><label title="survival rank select"><span class="sublabel darkred">rank</span><select name="attr_survival_rank" title="@{survival_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="survival item"><span class="sublabel darkred">item</span><input name="attr_survival_item" placeholder="0" spellcheck="false" title="@{survival_item}" type="text" value=""/></label><label class="sublabel" title="survival temporary"><span class="sublabel darkred">temp</span><input name="attr_survival_temporary" placeholder="0" spellcheck="false" title="@{survival_temporary}" type="text" value=""/></label><label title="survival notes"><textarea name="attr_survival_notes" placeholder="notes" spellcheck="false" title="@{survival_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_tech" title="tech settings" type="action">y</button><button class="h2" name="roll_TECH" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{tech}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{tech_proficiency_display}] (@{tech})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{tech_notes}}}">tech</button><div class="circle"><span name="attr_tech" title="@{tech}"></span></div><span class="symbol">=</span><label class="sublabel" title="tech ability modifier"><span class="sublabel darkred">mod</span><span name="attr_tech_ability" title="@{tech ability}"></span></label><label class="sublabel" title="tech proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_tech_proficiency_display"></span><span class="inline" name="attr_tech_proficiency" title="@{tech_proficiency}"></span></span></label><label class="sublabel" title="tech item"><span class="sublabel darkred">item</span><span name="attr_tech_item" title="@{tech_item}"></span></label><label class="sublabel" title="tech temporary"><span class="sublabel darkred">temp</span><span name="attr_tech_temporary" title="@{tech_temporary}"></span></label></div><div class="grid settings tech-settings"><div class="ability-select"><select name="attr_tech_ability_select" title="@{tech_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}" selected="">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="tech ability input"><input name="attr_tech_ability" placeholder="0" spellcheck="false" title="@{tech_ability}" type="text" value=""/></label></div><label title="tech rank select"><span class="sublabel darkred">rank</span><select name="attr_tech_rank" title="@{tech_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="tech item"><span class="sublabel darkred">item</span><input name="attr_tech_item" placeholder="0" spellcheck="false" title="@{tech_item}" type="text" value=""/></label><label class="sublabel" title="tech temporary"><span class="sublabel darkred">temp</span><input name="attr_tech_temporary" placeholder="0" spellcheck="false" title="@{tech_temporary}" type="text" value=""/></label><label title="tech notes"><textarea name="attr_tech_notes" placeholder="notes" spellcheck="false" title="@{tech_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_thievery" title="thievery settings" type="action">y</button><button class="h2" name="roll_THIEVERY" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{thievery}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{thievery_proficiency_display}] (@{thievery})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{thievery_notes}}}">thievery</button><div class="circle"><span name="attr_thievery" title="@{thievery}"></span></div><span class="symbol">=</span><label class="sublabel" title="thievery ability modifier"><span class="sublabel darkred">mod</span><span name="attr_thievery_ability" title="@{thievery ability}"></span></label><label class="sublabel" title="thievery proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_thievery_proficiency_display"></span><span class="inline" name="attr_thievery_proficiency" title="@{thievery_proficiency}"></span></span></label><label class="sublabel" title="thievery item"><span class="sublabel darkred">item</span><span name="attr_thievery_item" title="@{thievery_item}"></span></label><label class="sublabel" title="thievery temporary"><span class="sublabel darkred">temp</span><span name="attr_thievery_temporary" title="@{thievery_temporary}"></span></label><label class="sublabel" title="thievery armor pentalty"><span class="sublabel darkred">armor</span><span name="attr_thievery_armor" title="@{thievery_armor}"></span></label></div><div class="grid settings thievery-settings"><div class="ability-select"><select name="attr_thievery_ability_select" title="@{thievery_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}" selected="">dex</option><option value="@{constitution_modifier}">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="thievery ability input"><input name="attr_thievery_ability" placeholder="0" spellcheck="false" title="@{thievery_ability}" type="text" value=""/></label></div><label title="thievery rank select"><span class="sublabel darkred">rank</span><select name="attr_thievery_rank" title="@{thievery_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="thievery item"><span class="sublabel darkred">item</span><input name="attr_thievery_item" placeholder="0" spellcheck="false" title="@{thievery_item}" type="text" value=""/></label><label class="sublabel" title="thievery temporary"><span class="sublabel darkred">temp</span><input name="attr_thievery_temporary" placeholder="0" spellcheck="false" title="@{thievery_temporary}" type="text" value=""/></label><label class="sublabel" title="thievery armor pentalty"><span class="sublabel darkred">armor</span><input name="attr_thievery_armor" placeholder="0" spellcheck="false" title="@{thievery_armor}" type="text" value=""/></label><label title="thievery notes"><textarea name="attr_thievery_notes" placeholder="notes" spellcheck="false" title="@{thievery_notes}" value=""></textarea></label></div><div class="grid display"><button class="pictos settings-button" name="act_toggle_withstand" title="withstand settings" type="action">y</button><button class="h2" name="roll_WITHSTAND" type="roll" value="@{whispertype} &amp;{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=^{withstand}}} {{subheader=^{skill}}} {{roll01=[[1d20cs20cf1 + [@{withstand_proficiency_display}] (@{withstand})[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=skill}} {{notes_show=@{roll_show_notes}}} {{notes=@{withstand_notes}}}">withstand</button><div class="circle"><span name="attr_withstand" title="@{withstand}"></span></div><span class="symbol">=</span><label class="sublabel" title="withstand ability modifier"><span class="sublabel darkred">mod</span><span name="attr_withstand_ability" title="@{withstand ability}"></span></label><label class="sublabel" title="withstand proficiency"><span class="sublabel darkred">prof</span><span><span class="inline" name="attr_withstand_proficiency_display"></span><span class="inline" name="attr_withstand_proficiency" title="@{withstand_proficiency}"></span></span></label><label class="sublabel" title="withstand item"><span class="sublabel darkred">item</span><span name="attr_withstand_item" title="@{withstand_item}"></span></label><label class="sublabel" title="withstand temporary"><span class="sublabel darkred">temp</span><span name="attr_withstand_temporary" title="@{withstand_temporary}"></span></label></div><div class="grid settings withstand-settings"><div class="ability-select"><select name="attr_withstand_ability_select" title="@{withstand_ability_select}"><option value="@{strength_modifier}">str</option><option value="@{dexterity_modifier}">dex</option><option value="@{constitution_modifier}" selected="">con</option><option value="@{intelligence_modifier}">int</option><option value="@{wisdom_modifier}">wis</option><option value="@{charisma_modifier}">cha</option><option value="custom">custom</option></select><label title="withstand ability input"><input name="attr_withstand_ability" placeholder="0" spellcheck="false" title="@{withstand_ability}" type="text" value=""/></label></div><label title="withstand rank select"><span class="sublabel darkred">rank</span><select name="attr_withstand_rank" title="@{withstand_rank}"><option value="0" selected="">untrained</option><option value="2">level 1</option><option value="4">level 2</option><option value="6">level 3</option><option value="8">level 4</option><option value="10">level 5</option></select></label><label title="withstand item"><span class="sublabel darkred">item</span><input name="attr_withstand_item" placeholder="0" spellcheck="false" title="@{withstand_item}" type="text" value=""/></label><label class="sublabel" title="withstand temporary"><span class="sublabel darkred">temp</span><input name="attr_withstand_temporary" placeholder="0" spellcheck="false" title="@{withstand_temporary}" type="text" value=""/></label><label title="withstand notes"><textarea name="attr_withstand_notes" placeholder="notes" spellcheck="false" title="@{withstand_notes}" value=""></textarea></label></div></div></div></div><div class="details">
    <div class="column">

        <!--- CHARACTERISTICS --->
        <div class="characteristics background-color section-pad">
            <label class="sublabel" title="ethnicity">
                <span class="sublabel darkred" >ethnicity</span>
                <input name="attr_ethnicity" placeholder="ethnicity" spellcheck="false" title="@{ethnicity}" type="text" value="" />
            </label>
            <label class="sublabel" title="nationality">
                <span class="sublabel darkred" >nationality</span>
                <input name="attr_nationality" placeholder="nationality" spellcheck="false" title="@{nationality}" type="text" value="" />
            </label>
            <label class="sublabel" title="birthplace">
                <span class="sublabel darkred" >birthplace</span>
                <input name="attr_birthplace" placeholder="birthplace" spellcheck="false" title="@{birthplace}" type="text" value="" />
            </label>
            <label class="sublabel" title="age">
                <span class="sublabel darkred" >age</span>
                <input name="attr_age" placeholder="age" spellcheck="false" title="@{age}" type="text" value="" />
            </label>
            <label class="sublabel" title="gender">
                <span class="sublabel darkred" >gender</span>
                <input name="attr_gender_pronouns" placeholder="gender & pronouns" spellcheck="false" title="@{gender_pronouns}" type="text" value="" />
            </label>
            <label class="sublabel" title="height">
                <span class="sublabel darkred" >height</span>
                <input name="attr_height" placeholder="height" spellcheck="false" title="@{height}" type="text" value="" />
            </label>
            <label class="sublabel" title="weight">
                <span class="sublabel darkred" >weight</span>
                <input name="attr_weight" placeholder="weight" spellcheck="false" title="@{weight}" type="text" value="" />
            </label>
            <label class="sublabel" title="appearance">
                <span class="sublabel darkred" >appearance</span>
                <input name="attr_appearance" placeholder="appearance" spellcheck="false" title="@{appearance}" type="text" value="" />
            </label>
        </div>

        <!--- PERSONALITY  --->

        <div class="personality background-color">
            <h1 >personality</h1>
            <div class="section-pad">
                <label class="sublabel"  title="attitude">
                    <span class="sublabel darkred" >attitude</span>
                    <input name="attr_attitude" placeholder="attitude" spellcheck="false" title="@{attitude}" type="text" value="" />
                </label>
                <label class="sublabel"  title="beliefs">
                    <span class="sublabel darkred" >beliefs</span>
                    <input name="attr_beliefs" placeholder="beliefs" spellcheck="false" title="@{beliefs}" type="text" value="" />
                </label>
                <label class="sublabel"  title="likes">
                    <span class="sublabel darkred" >likes</span>
                    <input name="attr_likes" placeholder="likes" spellcheck="false" title="@{likes}" type="text" value="" />
                </label>
                <label class="sublabel"  title="dislikes">
                    <span class="sublabel darkred" >dislikes</span>
                    <input name="attr_dislikes" placeholder="dislikes" spellcheck="false" title="@{dislikes}" type="text" value="" />
                </label>
                <label class="sublabel"  title="catchphrases">
                    <span class="sublabel darkred" >catchphrases</span>
                    <input name="attr_catchphrases" placeholder="catchphrases" spellcheck="false" title="@{catchphrases}" type="text" value="" />
                </label>
            </div>
        </div>

        <!--- NOTES  --->

        <div class="notes background-color">
            <h1 >campaign notes</h1>
            <!--<button class="pictos settings-button" name="act_toggle_notes" type="action">y</button>-->
            <div class="notes-flex notes-settings">
                <h2 >notes</h2>
                <textarea name="attr_campaign_notes" placeholder="notes" spellcheck="false" title="@{campaign_notes}" value=""></textarea>
                <h2 >allies</h2>
                <textarea name="attr_campaign_notes_allies" placeholder="allies" spellcheck="false" title="@{campaign_notes_allies}" value=""></textarea>
                <h2 >enemies</h2>
                <textarea name="attr_campaign_notes_enemies" placeholder="enemies" spellcheck="false" title="@{campaign_notes_enemies}" value=""></textarea>
                <h2 >organizations</h2>
                <textarea name="attr_campaign_notes_organizations" placeholder="organizations" spellcheck="false" title="@{campaign_notes_organizations}" value=""></textarea>
            </div>
        </div>
    </div>
</div>
<div class="feats">
    <div class="column">
        <div class="feats-ancestry-grid background-color">
            <h1 >traits</h1>
            <fieldset class="repeating_feat-ancestry">
                <input class="toggles" name="attr_toggles" type="hidden" value="display,settings," />
                <div class="grid repeating-grid-display feat-border">
                    <button class="pictos settings-button" name="act_settings" title="feat ancestry settings" type="action">
                        y
                    </button>
                    <button class="h2" name="roll_ACTION" type="roll" value="@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{feat_ancestry}}} {{info01_name=^{type}}} {{info01=@{feat_ancestry_type}}} {{info02_name=^{level}}} {{info02=@{feat_ancestry_level}}} {{desc=@{feat_ancestry_notes}}}"><span name= "attr_feat_ancestry"></span></button>
                    <input name="attr_feat_ancestry_uses" spellcheck="false" title="@{feat_ancestry_uses}" type="text" value="" />
					<span>/</span>
					<span name="attr_feat_ancestry_uses_max"></span>
                    <button name="act_collapse" title="show or hide feat ancestry description" type="action">
                        4
                    </button>
                    <span class="collapse" name="attr_feat_ancestry_notes"></span>
                </div>
                <div class="grid feats-repeating-grid settings">
					<label class="sublabel"  title="ancestry feat and abilities">
						<span class="sublabel darkred" >name</span>
						<input name="attr_feat_ancestry" placeholder="name" spellcheck="false" title="@{feat_ancestry}" type="text" value="" />
					</label>
					<label class="sublabel"  title="ancestry feat type">
						<span class="sublabel darkred" >prereq</span>
						<input name="attr_feat_ancestry_type" placeholder="prereq" spellcheck="false" title="@{feat_ancestry_type}" type="text" value="" />
					</label>
					<label class="sublabel"  title="ancestry feat level">
						<span class="sublabel darkred" >level</span>
						<input name="attr_feat_ancestry_level" placeholder="1st" spellcheck="false" title="@{feat_ancestry_level}" type="text" value="" />
					</label>
					<label class="sublabel" title="class feat uses">
						<span class="sublabel darkred" >uses</span>
						<input name="attr_feat_ancestry_uses" spellcheck="false" title="@{feat_ancestry_uses}" type="text" value="" />
					</label>
					<label class="sublabel" title="class feat max uses">
						<span class="sublabel darkred" >max uses</span>
						<input name="attr_feat_ancestry_uses_max" spellcheck="false" title="@{feat_ancestry_uses_max}" type="text" value="" />
					</label>
					<div>
						<label class="sublabel"  title="ancestry feat description">
							<span class="sublabel darkred" >description</span>
							<textarea name="attr_feat_ancestry_notes" placeholder="description" spellcheck="false" title="@{feat_ancestry_notes}" value=""></textarea>
						</label>
					</div>
                </div>
            </fieldset>
        </div>

        <div class="feats-general-grid background-color">
            <h1>feats</h1>
            <fieldset class="repeating_feat-general">
                <input class="toggles" name="attr_toggles" type="hidden" value="display,settings," />
                <div class="grid repeating-grid-display feat-border">
                    <button class="pictos settings-button" name="act_settings" title="feat general settings" type="action">
                        y
                    </button>
					<button class="h2" name="roll_action" type="roll" value="@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{feat_general}}} {{info01_name=^{level}}} {{info01=@{feat_general_level}}} {{desc=@{feat_general_notes}}}"><span name= "attr_feat_general"></span></button>
					<input name="attr_feat_general_uses" placeholder="1st" spellcheck="false" title="@{feat_general_uses}" type="text" value="" />
					<span>/</span>
					<span name="attr_feat_general_uses_max"></span>
                    <button name="act_collapse"  title="show or hide feat general description" type="action">
                        4
                    </button>
                    <span class="collapse" name="attr_feat_general_notes"></span>
                </div>
                <div class="grid feats-repeating-grid settings">
					<label class="sublabel" title="general feat">
						<span class="sublabel darkred" >name</span>
						<input name="attr_feat_general" placeholder="name" spellcheck="false" title="@{feat_general}" type="text" value="" />
					</label>
					<label class="sublabel"  title="ancestry feat type">
						<span class="sublabel darkred" >prereq</span>
						<input name="attr_feat_general_type" placeholder="prereq" spellcheck="false" title="@{feat_ancestry_type}" type="text" value="" />
					</label>
					<label class="sublabel" title="general feat level">
						<span class="sublabel darkred" >level</span>
						<input name="attr_feat_general_level" placeholder="1st" spellcheck="false" title="@{feat_general_level}" type="text" value="" />
					</label>
					<label class="sublabel" title="class feat uses">
						<span class="sublabel darkred" >uses</span>
						<input name="attr_feat_general_uses" placeholder="1st" spellcheck="false" title="@{feat_general_uses}" type="text" value="" />
					</label>
					<label class="sublabel" title="class feat max uses">
						<span class="sublabel darkred" >max uses</span>
						<input name="attr_feat_general_uses_max" placeholder="1st" spellcheck="false" title="@{feat_general_uses_max}" type="text" value="" />
					</label>
					<div>
						<label class="sublabel" title="general feat description">
							<span class="sublabel darkred" >description</span>
							<textarea name="attr_feat_general_notes" placeholder="description" spellcheck="false" title="@{feat_general_notes}" value=""></textarea>
						</label>
					</div>
                </div>
            </fieldset>
        </div>
    </div>

    <div class="column">
        <div class="feats-class-grid background-color">
            <h1 >class features</h1>
            <fieldset class="repeating_feat-class">
                <input class="toggles" name="attr_toggles" type="hidden" value="display,settings," />
                <div class="grid repeating-grid-display feat-border">
                    <button class="pictos settings-button" name="act_settings" title="feat class settings" type="action">
                        y
                    </button>
                    <button class="h2" name="roll_action" type="roll" value="@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{feat_class}}} {{info01_name=^{type}}} {{info02_name=^{level}}} {{info02=@{feat_class_level}}} {{desc=@{feat_class_notes}}}"><span name= "attr_feat_class"></span></button>
                    <input name="attr_feat_class_uses" placeholder="1st" spellcheck="false" title="@{feat_class_uses}" type="text" value="" />
					<span>/</span>
					<span name="attr_feat_class_uses_max"></span>
                    <button name="act_collapse"  title="show or hide feat class description" type="action">
                        4
                    </button>
                    <span class="collapse" name="attr_feat_class_notes"></span>
                </div>
                <div class="grid feats-repeating-grid settings">
					<label class="sublabel" title="class abilities">
						<span class="sublabel darkred" >name</span>
						<input name="attr_feat_class" placeholder="name" spellcheck="false" title="@{feat_class}" type="text" value="" />
					</label>
					<label class="sublabel" title="class feat level">
						<span class="sublabel darkred" >level</span>
						<input name="attr_feat_class_level" placeholder="1st" spellcheck="false" title="@{feat_class_level}" type="text" value="" />
					</label>
					<label class="sublabel" title="class feat uses">
						<span class="sublabel darkred" >uses</span>
						<input name="attr_feat_class_uses" placeholder="1st" spellcheck="false" title="@{feat_class_uses}" type="text" value="" />
					</label>
					<label class="sublabel" title="class feat max uses">
						<span class="sublabel darkred" >max uses</span>
						<input name="attr_feat_class_uses_max" placeholder="1st" spellcheck="false" title="@{feat_class_uses_max}" type="text" value="" />
					</label>
					<div>
						<label class="sublabel" title="class feat description">
							<span class="sublabel darkred" >description</span>
							<textarea name="attr_feat_class_notes" placeholder="description" spellcheck="false" title="@{feat_class_notes}" value=""></textarea>
						</label>
					</div>
                </div>
            </fieldset>
        </div>
    </div>
</div>
<div class="inventory">
    <div class="background-color">
        <h1 >inventory</h1>
        <div class="grid inv-top-row">
            <div class="circle bulk-circle">
                <label title="bulk">
                    <span >bulk</span>
                    <span class="bulk-circle" name="attr_bulk" title="@{bulk}"></span>
                </label>
            </div>
            <div class="grid encumbered">
                <h2 >encumbered</h2>
                <div class='circle'>
                    <span name="attr_encumbered_base" title="@{encumbered_base}"></span>
                </div>
                <span class='center'>=</span>
                <div class="dcbase sublabel">
                    <span >base</span>
                    <span ><b>5</b></span>
                </div>
                <label title="strength modifier display">
                    <span class="title" >str</span>
                    <span class="value" name="attr_strength_modifier" title="@{strength_modifier}"></span>
                </label>
                <div class="dcbase sublabel">
                    <span >mode</span>
                    <input name="attr_encumbered_modifier" type="number" value="0"/>
                </div>
            </div>
            <div class="grid encumbered">
                <h2 >maximum</h2>
                <div class='circle'>
                    <span name="attr_maximum_base" title="@{maximum_base}"></span>
                </div>
                <span class='center'>=</span>
                <div class="dcbase sublabel">
                    <span >base</span>
                    <span ><b>10</b></span>
                </div>
                <label title="strength modifier display">
                    <span class="title" >str</span>
                    <span class="value" name="attr_strength_modifier" title="@{strength_modifier}"></span>
                </label>
                <div class="dcbase sublabel">
                    <span >mode</span>
                    <input name="attr_maximum_modifier" type="number" value="0"/>
                </div>
            </div>
            <div class="coins">
                <h2 >cp</h2>
                <label title="copper pieces">
                    <input class="circle coins-circle" name="attr_cp" placeholder="0" spellcheck="false" title="@{cp}" type="text" value="" />
                </label>
            </div>
            <div class="coins">
                <h2 >sp</h2>
                <label title="silver pieces">
                    <input class="circle coins-circle" name="attr_sp" placeholder="0" spellcheck="false" title="@{sp}" type="text" value="" />
                </label>
            </div>
            <div class="coins">
                <h2 >gp</h2>
                <label title="gold pieces">
                    <input class="circle coins-circle" name="attr_gp" placeholder="0" spellcheck="false" title="@{gp}" type="text" value="" />
                </label>
            </div>
            <div class="coins">
                <h2 >pp</h2>
                <label title="platinum pieces">
                    <input class="circle coins-circle" name="attr_pp" placeholder="0" spellcheck="false" title="@{pp}" type="text" value="" />
                </label>
            </div>
        </div>
        <div class="column worn-items">
            <div class="grid inv-display-grid">
                <h2 >worn item</h2>
                <h2 >material</h2>
                <h2 >bulk</h2>
                <h2 >qty</h2>
            </div>
            <fieldset class="repeating_items-worn">
                <input class="toggles" name="attr_toggles" type="hidden" value="display,settings," />
                <div class="grid inv-display-grid">
                    <button class="pictos settings-button" name="act_settings" title="worn item settings" type="action">
                        y
                    </button>
                    <button name="roll_ACTION" type="roll" value="@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{worn_item}}} {{subheader=^{worn_item}}} {{info01_name=^{invest}}} {{info01=@{worn_invest}}} {{info02_name=^{bulk}}} {{info02=@{worn_bulk}}} {{info03_name=^{quantity}}} {{info03=@{worn_quantity}}} {{notes_show=[[1]]}} {{notes=@{worn_item_notes}}}">
                        <span name= "attr_worn_item"></span>
                    </button>
                    <span class="inv-bulk" name="attr_worn_invest"></span>
                    <span class="inv-bulk" name="attr_worn_bulk"></span>
                    <input class="" name="attr_worn_quantity" title="@{worn_quantity}" type="number" value="1" />
                    <button name="act_collapse" title="show or hide worn item notes" type="action">
                        4
                    </button>
                    <span class="inv-notes collapse" class="collapse" name="attr_worn_item_notes"></span>
                </div>
                <div class="grid item-repeating-grid settings">
                    <label class="inv-name" title="worn item">
                        <span >name</span>
                        <input name="attr_worn_item" placeholder="name" spellcheck="false" title="@{worn_item}" type="text" value="" />
                    </label>
                    <label class="inv-invest" title="work item invest (max 10)">
                        <span >material</span>
                        <input name="attr_worn_invest" placeholder="material" spellcheck="false" title="@{worn_invest}" type="text" value="" />
                    </label>
                    <label class="inv-bulk" title="worn item bulk">
                        <span >bulk</span>
                        <input name="attr_worn_bulk" placeholder="0" spellcheck="false" title="@{worn_bulk}" type="text" value="" />
                    </label>
                    <label class="inv-notes" title="worn item notes">
                        <span >notes</span>
                        <textarea name="attr_worn_item_notes" placeholder="notes" spellcheck="false" title="@{worn_item_notes}" value=""></textarea>
                    </label>
                </div>
            </fieldset>
        </div>
        <div class="column">
            <div class="inv-half-col">
                <div class="grid inv-display-grid">
                    <h2 >readied items</h2>
                    <h2 >bulk</h2>
                    <h2 >qty</h2>
                </div>
                <fieldset class="repeating_items-readied">
                    <input class="toggles" name="attr_toggles" type="hidden" value="display,settings," />
                    <div class="grid inv-display-grid inv-display-grid-other feat-border">
                        <button class="pictos settings-button" name="act_settings" title="readied item settings" type="action">
                            y
                        </button>
                        <button class="h2" name="roll_action" type="roll" value="@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{readied_item}}} {{subheader=^{readied_items}}} {{info01_name=^{bulk}}} {{info01=@{readied_bulk}}} {{info02_name=^{quantity}}} {{info02=@{readied_quantity}}} {{notes_show=[[1]]}} {{notes=@{readied_item_notes}}}">
                            <span name= "attr_readied_item"></span>
                        </button>
                        <span class="inv-bulk" name="attr_readied_bulk"></span>
                        <input class="" name="attr_readied_quantity" title="@{readied_quantity}" type="number" value="1" />
                        <button name="act_collapse" title="show or hide readied item notes" type="action">
                            4
                        </button>
                        <span class="inv-notes collapse" name="attr_readied_item_notes"></span>
                    </div>
                    <div class="grid item-repeating-grid settings">
                        <label class="inv-name" title="readied item name">
                            <span >name</span>
                            <input name="attr_readied_item" placeholder="name" spellcheck="false" title="@{readied_item}" type="text" value="" />
                        </label>
                        <label class="inv-bulk" title="readied item bulk">
                            <span >bulk</span>
                            <input name="attr_readied_bulk" placeholder="0" spellcheck="false" title="@{readied_bulk}" type="text" value="" />
                        </label>
                        <label class="inv-notes" title="readied item notes">
                            <span >notes</span>
                            <textarea name="attr_readied_item_notes" placeholder="notes" spellcheck="false" title="@{readied_item_notes}" value=""></textarea>
                        </label>
                    </div>
                </fieldset>
            </div>
            <div class="inv-half-col">
                <div class="grid inv-display-grid">
                    <h2 >other items</h2>
                    <h2 >bulk</h2>
                    <h2 >qty</h2>
                </div>
                <fieldset class="repeating_items-other">
                    <input class="toggles" name="attr_toggles" type="hidden" value="display,settings," />
                    <div class="grid inv-display-grid inv-display-grid-other feat-border">
                        <button class="pictos settings-button" name="act_settings" title="other item settings" type="action">
                            y
                        </button>
                        <button class="h2" name="roll_action" type="roll" value="@{whispertype} &{template:rolls} {{limit_height=@{roll_limit_height}}} {{charactername=@{character_name}}} {{header=@{other_item}}} {{subheader=^{other_items}}} {{info01_name=^{bulk}}} {{info01=@{other_bulk}}} {{info02_name=^{quantity}}} {{info02=@{other_quantity}}} {{notes_show=[[1]]}} {{notes=@{other_item_notes}}}">
                            <span name="attr_other_item"></span>
                        </button>
                        <span class="inv-bulk" name="attr_other_bulk"></span>
                        <input class="" name="attr_other_quantity" title="@{other_quantity}" type="number" value="1" />
                        <button name="act_collapse" title="show or hide other item notes" type="action">
                            4
                        </button>
                        <span class="inv-notes collapse" name="attr_other_item_notes"></span>
                    </div>
                    <div class="grid item-repeating-grid settings">
                        <label class="inv-name" title="other item name">
                            <span >name</span>
                            <input name="attr_other_item" placeholder="name" spellcheck="false" title="@{other_item}" type="text" value="" />
                        </label>
                        <label class="inv-bulk" title="other item bulk">
                            <span >bulk</span>
                            <input name="attr_other_bulk" placeholder="0" spellcheck="false" title="@{other_bulk}" type="text" value="" />
                        </label>
                        <label class="inv-notes" title="other item notes">
                            <span >notes</span>
                            <textarea name="attr_other_item_notes" placeholder="notes" spellcheck="false" title="@{other_item_notes}" value=""></textarea>
                        </label>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
</div>
<!--include src/pug/tabs/spells.pug--><div class="options"><div class="options-wrapper"><h1>options</h1><div class="options-panel"><h2>customize rolls</h2><label title="bonus to roll"><input name="attr_query_roll_bonus" title="@{query_roll_bonus}" type="checkbox" value="?{@{text_roll_bonus}|0}"/><span>bonus to roll</span></label><label title="bonus to damage"><input name="attr_query_roll_damage_bonus" title="@{query_roll_damage_bonus}" type="checkbox" value="?{@{text_roll_damage_bonus}|0}"/><span>bonus to damage</span></label><label title="# Damage Dice"><input name="attr_query_roll_damage_dice" title="@{query_roll_damage_dice}" type="checkbox" value="?{@{text_#_damage_dice}|@{damage_dice}}"/><span># Damage Dice</span></label><label title="roll critical damage options"><span>ROLL CRITICAL DAMAGE OPTIONS</span><select name="attr_roll_option_critical_damage" title="@{roll_option_critical_damage}"><option value="none">Don't roll critical damage</option><option value="button">Show a chat button to roll critical damage</option><option selected="selected" value="auto">Auto roll critical damage</option></select></label><label title="Show Notes in Rolls"><input name="attr_roll_show_notes" title="@{roll_show_notes}" type="checkbox" value="[[1]]"/><span>Show Notes in Rolls</span></label><label title="Limit height of Notes and Description in roll template"><input name="attr_roll_limit_height" title="@{roll_limit_height}" type="checkbox" value="limit-height"/><span>Limit height of Notes and Description in roll template</span></label></div><div class="options-panel"><h2>customize sheet layout</h2><h3>color scheme</h3><label title="color scheme select"><select name="attr_color_scheme" title="@{color_scheme}" value="default"><option value="default" selected="selected">default</option><option value="neutral">neutral</option></select></label></div></div></div></div><!-- FOOTER--><div class="footer">
    <span ><i> 2019 Paizo Inc. Paizo, the Paizo golem logo, Pathfinder, and the Pathfinder logo are registered trademarks of Paizo Inc.  Pathfinder Adventure Path, Pathfinder Roleplaying Game, Pathfinder World Guide, and the Pathfinder P logo are trademarks of Paizo Inc.  All Paizo titles and Paizo's character names and distinctive likenesses are property and copyright of Paizo, Inc. in the United States and other countries.</i></span><br />
    <span>version </span><span name="attr_version"></span>
</div>
</div><!-- HIDDEN ATTRIBUTES-->
<!-- Misc -->
<input type="hidden" name="attr_version_character" value="1.0" /> <!-- Versioning: this is the current version of the character sheet - don't change it -->

<!-- Ability Scores -->
<input name="attr_strength" type="hidden" value="10" />
<input name="attr_dexterity" type="hidden" value="10" />
<input name="attr_constitution" type="hidden" value="10" />
<input name="attr_intelligence" type="hidden" value="10" />
<input name="attr_wisdom" type="hidden" value="10" />
<input name="attr_charisma" type="hidden"value="10" />
<input name="attr_strength_score" type="hidden" value="10" />
<input name="attr_dexterity_score" type="hidden" value="10" />
<input name="attr_constitution_score" type="hidden" value="10" />
<input name="attr_intelligence_score" type="hidden" value="10" />
<input name="attr_wisdom_score" type="hidden" value="10" />
<input name="attr_charisma_score" type="hidden"value="10" />
<input name="attr_strength_modifier" type="hidden" value="0" />
<input name="attr_strength_modifier_half" type="hidden" value="0" />
<input name="attr_dexterity_modifier" type="hidden" value="0" />
<input name="attr_constitution_modifier" type="hidden" value="0" />
<input name="attr_intelligence_modifier" type="hidden" value="0" />
<input name="attr_wisdom_modifier" type="hidden" value="0" />
<input name="attr_charisma_modifier" type="hidden" value="0" />

<!-- Class DC -->
<input name="attr_class_dc" type="hidden" value="10" />
<input name="attr_class_dc_key_ability" type="hidden" value="0" />

<!-- Hit Points -->
<input name="attr_hit_points" type="hidden" value="0" />
<input name="attr_hit_points_max" type="hidden" value="0" />

<!-- Perception -->
<input name="attr_perception" type="hidden" value="0" />
<input name="attr_perception_ability" type="hidden" value="0" />

<!-- Armor -->
<input name="attr_armor_class_dc_base" type="hidden" value="10" />
<input name="attr_armor_class" type="hidden" value="10" />
<input name="attr_ac" type="hidden" value="@{armor_class}" disabled="disabled" />
<input name="attr_armor_class_shield" type="hidden" value="0" />

<!-- Saving Throws -->
<input name="attr_saving_throws_strengthsave" type="hidden" value="0" />
<input name="attr_saving_throws_fortitude" type="hidden" value="0" />
<input name="attr_saving_throws_reflex" type="hidden" value="0" />
<input name="attr_saving_throws_will" type="hidden" value="0" />

<!-- Spell Attack -->
<input name="attr_spell_attack" type="hidden" value="0" />
<input name="attr_spell_attack_key_ability" type="hidden" value="0" />

<!-- Spell DC -->
<input name="attr_spell_dc" type="hidden" value="10" />
<input name="attr_spell_dc_key_ability" type="hidden" value="0" />

<!-- Spells: Magic Tradition -->
<input name="attr_magic_tradition_arcane" type="hidden" value="0" />
<input name="attr_magic_tradition_arcane_proficiency" type="hidden" value="0" />
<input name="attr_magic_tradition_primal" type="hidden" value="0" />
<input name="attr_magic_tradition_primal_proficiency" type="hidden" value="0" />
<input name="attr_magic_tradition_occult" type="hidden" value="0" />
<input name="attr_magic_tradition_occult_proficiency" type="hidden" value="0" />
<input name="attr_magic_tradition_divine" type="hidden" value="0" />
<input name="attr_magic_tradition_divine_proficiency" type="hidden" value="0" />

<!-- Bulk -->
<input name="attr_bulk" type="hidden" value="0" />
<input name="attr_encumbered_base" type="hidden" value="5" />
<input name="attr_maximum_base" type="hidden" value="10" />

<!-- Proficiencies -->
<input name="attr_class_dc_proficiency" type="hidden" value="0" />
<input name="attr_armor_class_proficiency" type="hidden" value="0" />
<input name="attr_saving_throws_fortitude_proficiency" type="hidden" value="0" />
<input name="attr_saving_throws_reflex_proficiency" type="hidden" value="0" />
<input name="attr_saving_throws_will_proficiency" type="hidden" value="0" />
<input name="attr_acrobatics_proficiency" type="hidden" value="0" />
<input name="attr_alchemy_proficiency" type="hidden" value="0" />
<input name="attr_athletics_proficiency" type="hidden" value="0" />
<input name="attr_awareness_proficiency" type="hidden" value="0" />
<input name="attr_charm_proficiency" type="hidden" value="0" />
<input name="attr_craft_proficiency" type="hidden" value="0" />
<input name="attr_deception_proficiency" type="hidden" value="0" />
<input name="attr_husbandry_proficiency" type="hidden" value="0" />
<input name="attr_insight_proficiency" type="hidden" value="0" />
<input name="attr_intimidation_proficiency" type="hidden" value="0" />
<input name="attr_investigation_proficiency" type="hidden" value="0" />
<input name="attr_lore_proficiency" type="hidden" value="0" />
<input name="attr_medicine_proficiency" type="hidden" value="0" />
<input name="attr_navigation_proficiency" type="hidden" value="0" />
<input name="attr_operate_proficiency" type="hidden" value="0" />
<input name="attr_performance_proficiency" type="hidden" value="0" />
<input name="attr_religion_proficiency" type="hidden" value="0" />
<input name="attr_repair_proficiency" type="hidden" value="0" />
<input name="attr_stealth_proficiency" type="hidden" value="0" />
<input name="attr_survival_proficiency" type="hidden" value="0" />
<input name="attr_tech_proficiency" type="hidden" value="0" />
<input name="attr_thievery_proficiency" type="hidden" value="0" />
<input name="attr_withstand_proficiency" type="hidden" value="0" />
<input name="attr_spell_attack_proficiency" type="hidden" value="0" />
<input name="attr_spell_dc_proficiency" type="hidden" value="0" />

<input name="attr_perception" type="hidden" value="0" />
<input name="attr_acrobatics" type="hidden" value="0" />
<input name="attr_alchemy" type="hidden" value="0" />
<input name="attr_athletics" type="hidden" value="0" />
<input name="attr_awareness" type="hidden" value="0" />
<input name="attr_charm" type="hidden" value="0" />
<input name="attr_craft" type="hidden" value="0" />
<input name="attr_deception" type="hidden" value="0" />
<input name="attr_husbandry" type="hidden" value="0" />
<input name="attr_insight" type="hidden" value="0" />
<input name="attr_intimidation" type="hidden" value="0" />
<input name="attr_investigation" type="hidden" value="0" />
<input name="attr_lore" type="hidden" value="0" />
<input name="attr_medicine" type="hidden" value="0" />
<input name="attr_navigation" type="hidden" value="0" />
<input name="attr_operate" type="hidden" value="0" />
<input name="attr_performance" type="hidden" value="0" />
<input name="attr_religion" type="hidden" value="0" />
<input name="attr_repair" type="hidden" value="0" />
<input name="attr_stealth" type="hidden" value="0" />
<input name="attr_survival" type="hidden" value="0" />
<input name="attr_tech" type="hidden" value="0" />
<input name="attr_thievery" type="hidden" value="0" />
<input name="attr_withstand" type="hidden" value="0" />

<!-- Translatable Texts for rolls queries, rolls details etc. -->
    <!-- Must be translated at sheet opening -->
<input name="attr_text_modifier" type="hidden" value="modifier" />
<input name="attr_text_ability_modifier" type="hidden" value="ability modifier" />
<input name="attr_text_bonus" type="hidden" value="bonus" />
<input name="attr_text_roll_bonus" type="hidden" value="bonus to roll" />
<input name="attr_text_roll_damage_bonus" type="hidden" value="bonus to damage" />
<input name="attr_text_#_damage_dice" type="hidden" value="# Damage Dice" />
<input name="attr_text_use" type="hidden" value="Use" />

<!-- Token Settings  -->
<input type="hidden" name="settings_bar1value" value="" />
<input type="hidden" name="settings_bar1max" value="" />
<input type="hidden" name="settings_bar1link" value="" />
<input type="hidden" name="settings_bar2value" value="" />
<input type="hidden" name="settings_bar2max" value="" />
<input type="hidden" name="settings_bar2link" value="" />
<input type="hidden" name="settings_bar3value" value="" />
<input type="hidden" name="settings_bar3max" value="" />
<input type="hidden" name="settings_bar3link" value="" />

<!-- Tenacity -->
<input type="hidden" name="attr_strength_max_tenacity" value="0" />
<input type="hidden" name="attr_dexterity_max_tenacity" value="0" />
<input type="hidden" name="attr_constitution_max_tenacity" value="0" />
<input type="hidden" name="attr_intelligence_max_tenacity" value="0" />
<input type="hidden" name="attr_wisdom_max_tenacity" value="0" />

<input type="hidden" name="attr_strength_tenacity_mod" value="0" />
<input type="hidden" name="attr_dexterity_tenacity_mod" value="0" />
<input type="hidden" name="attr_constitution_tenacity_mod" value="0" />
<input type="hidden" name="attr_intelligence_tenacity_mod" value="0" />
<input type="hidden" name="attr_wisdom_tenacity_mod" value="0" /><!-- ROLL TEMPLATES--><div class="rolltemplates">
    <rolltemplate class="sheet-rolltemplate-rolls">
        {{#charactername}}
            <span class="charactername">
                {{charactername}}
            </span>
        {{/charactername}}
        <!--- Display a header on the template --->
        <div class="template-header">
            {{#header}}{{header}}{{/header}}
            {{#subheader}}
                <div class="template-subheader">{{subheader}}</div>
            {{/subheader}}
        </div>
        <!--- Display the dice rolls in the template --->
        <div class="template-body">
            <!-- Generic rolls -->
            {{#roll01}}
                <div class="template-row {{roll01_type}}">
                    {{#roll01_name}}
                        <span class="template-roll-name {{roll01_type}}">{{roll01_name}}</span>
                    {{/roll01_name}}
                    {{roll01}}
                    {{#roll01_info}}
                        <span class="template-roll-info {{roll01_type}}">{{roll01_info}}</span>
                    {{/roll01_info}}
                </div>
            {{/roll01}}
            {{#roll01misc}}<div class="template-row">{{roll01misc}}</div>{{/roll01misc}}
			{{#criticalconfirm}}
				{{#rollWasCrit() roll01}}
					<div class="template-row {{criticalconfirm_type}}">
						{{#criticalconfirm_name}}
							<span class="template-roll-name {{criticalconfirm_type}}">{{criticalconfirm_name}}</span>
						{{/criticalconfirm_name}}
						{{criticalconfirm}}
						{{#criticalconfirm_info}}
							<span class="template-roll-info {{criticalconfirm_type}}">{{criticalconfirm_info}}</span>
						{{/criticalconfirm_info}}
					</div>
				{{/rollWasCrit() roll01}}
			{{/criticalconfirm}}
            {{#roll02}}
                <div class="template-row {{roll02_type}}">
                    {{#roll02_name}}
                        <span class="template-roll-name {{roll02_type}}">{{roll02_name}}</span>
                    {{/roll02_name}}
                    {{roll02}}
                    {{#roll02_info}}
                        <span class="template-roll-info {{roll02_type}}">{{roll02_info}}</span>
                    {{/roll02_info}}
                </div>
            {{/roll02}}
            {{#roll02misc}}<div class="template-row">{{roll02misc}}</div>{{/roll02misc}}
			{{#criticalroll}}
				{{#rollWasCrit() roll01}}
					<div class="template-row {{criticalroll_type}}">
						{{#criticalroll_name}}
							<span class="template-roll-name {{criticalroll_type}}">{{criticalroll_name}}</span>
						{{/criticalroll_name}}
						{{criticalroll}}
						{{#criticalroll_info}}
							<span class="template-roll-info {{criticalroll_type}}">{{criticalroll_info}}</span>
						{{/criticalroll_info}}
					</div>
				{{/rollWasCrit() roll01}}
			{{/criticalroll}}
            {{#criticalrollmisc}}<div class="template-row">{{criticalrollmisc}}</div>{{/criticalrollmisc}}
            {{#roll03}}
					<div class="template-row {{roll03_type}}">
						{{#roll03_name}}
							<span class="template-roll-name {{roll03_type}}">{{roll03_name}}</span>
						{{/roll03_name}}
						{{roll03}}
						{{#roll03_info}}
							<span class="template-roll-info {{roll03_type}}">{{roll03_info}}</span>
						{{/roll03_info}}
					</div>
            {{/roll03}}
            {{#roll03misc}}<div class="template-row">{{roll03misc}}</div>{{/roll03misc}}
            {{#roll04}}
                <div class="template-row {{roll04_type}}">
                    {{#roll04_name}}
                        <span class="template-roll-name {{roll04_type}}">{{roll04_name}}</span>
                    {{/roll04_name}}
                    {{roll04}}
                    {{#roll04_info}}
                        <span class="template-roll-info {{roll04_type}}">{{roll04_info}}</span>
                    {{/roll04_info}}
                </div>
            {{/roll04}}
            {{#roll04misc}}<div class="template-row">{{roll04misc}}</div>{{/roll04misc}}
            <!-- SAVES -->
            {{#savedc}}
                <div class="template-row">
                    {{#savebasic}}<span class="template-roll-name bold save" >basic</span>{{/savebasic}}
                    <span class="template-roll-name bold save" >Saving Throw</span>
                    <span class="template-roll-name bold">{{savetype}}</span>
                    <span class="template-roll-name bold" >DC</span>
                    {{^savespecialdc}}{{savedc}}{{/savespecialdc}}
                    {{#savespecialdc}}
                        {{#rollGreater() savespecialdc savedcmisc}}{{savespecialdc}}{{/rollGreater() savespecialdc savedcmisc}}
                        {{#rollTotal() savespecialdc savedcmisc}}{{savedc}}{{/rollTotal() savespecialdc savedcmisc}}
                    {{/savespecialdc}}
                    {{^savebasic}}
                        <div class="notes {{limit_height}}">
                            {{#savecriticalsuccess}}
                                <div class="left">
                                    <span class="template-roll-name bold" >critical success</span>:
                                    <span class="template-roll-info">{{savecriticalsuccess}}</span>
                                </div>
                            {{/savecriticalsuccess}}
                            {{#savesuccess}}
                                <div class="left">
                                    <span class="template-roll-name bold" >success</span>:
                                    <span class="template-roll-info">{{savesuccess}}</span>
                                </div>
                            {{/savesuccess}}
                            {{#savefailure}}
                                <div class="left">
                                    <span class="template-roll-name bold" >failure</span>:
                                    <span class="template-roll-info">{{savefailure}}</span>
                                </div>
                            {{/savefailure}}
                            {{#savecriticalfailure}}
                                <div class="left">
                                    <span class="template-roll-name bold" >critical failure</span>:
                                    <span class="template-roll-info">{{savecriticalfailure}}</span>
                                </div>
                            {{/savecriticalfailure}}
                        </div>
                    {{/savebasic}}
                </div>
            {{/savedc}}
            <!-- Generic informations (bold label: information) -->
            {{#info01}}
                <div class="template-row left">
                    <span class="template-roll-name bold">{{info01_name}}</span>:
                    <span class="template-roll-info">{{info01}}</span>
                </div>
            {{/info01}}
            {{#info02}}
                <div class="template-row left">
                    <span class="template-roll-name bold">{{info02_name}}</span>:
                    <span class="template-roll-info">{{info02}}</span>
                </div>
            {{/info02}}
            {{#info03}}
                <div class="template-row left">
                    <span class="template-roll-name bold">{{info03_name}}</span>:
                    <span class="template-roll-info">{{info03}}</span>
                </div>
            {{/info03}}
            {{#info04}}
                <div class="template-row left">
                    <span class="template-roll-name bold">{{info04_name}}</span>:
                    <span class="template-roll-info">{{info04}}</span>
                </div>
            {{/info04}}
            {{#info05}}
                <div class="template-row left">
                    <span class="template-roll-name bold">{{info05_name}}</span>:
                    <span class="template-roll-info">{{info05}}</span>
                </div>
            {{/info05}}
            {{#info06}}
                <div class="template-row left">
                    <span class="template-roll-name bold">{{info06_name}}</span>:
                    <span class="template-roll-info">{{info06}}</span>
                </div>
            {{/info06}}
            {{#info07}}
                <div class="template-row left">
                    <span class="template-roll-name bold">{{info07_name}}</span>:
                    <span class="template-roll-info">{{info07}}</span>
                </div>
            {{/info07}}
            {{#info08}}
                <div class="template-row left">
                    <span class="template-roll-name bold">{{info08_name}}</span>:
                    <span class="template-roll-info">{{info08}}</span>
                </div>
            {{/info08}}
            {{#info09}}
                <div class="template-row left">
                    <span class="template-roll-name bold">{{info09_name}}</span>:
                    <span class="template-roll-info">{{info09}}</span>
                </div>
            {{/info09}}
            {{#desc}}
                <div class="desc {{limit_height}}">
                    {{desc}}
                </div>
            {{/desc}}
            {{#rollTotal() notes_show 1}}
                {{#notes}}
                    <div class="notes {{limit_height}}">
                        {{notes}}
                    </div>
                {{/notes}}
            {{/rollTotal() notes_show 1}}
        </div>
    </rolltemplate>
</div>
<!-- SHEET WORKERS--><script type="text/worker">/* === MODULE BEGINS === */

var modPf2 = (function () {

    /* === GLOBAL VARIABLES === */
    var global_sheet_init_done = 0;
    // Attribute names by category
    const global_attributes_by_category = {
        "abilities": ["strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma"]
        , "ability_modifiers": ["strength_modifier", "strength_modifier_half", "dexterity_modifier", "constitution_modifier", "intelligence_modifier", "wisdom_modifier", "charisma_modifier"]
        , "setting_toggles": ["class_dc", "armor_class", "hitpoints", "saving_throws", "shield", "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma", "perception", "ancestry", "notes", "spell_attack", "spell_dc", "npcsettings", "npcspellcaster"]
        , "repeating_toggles": ["repeating_conditions", "repeating_resistances-immunities", "repeating_senses", "repeating_languages", "repeating_melee-strikes", "repeating_ranged-strikes","repeating_actions","repeating_actions-activities","repeating_free-actions-reactions","repeating_feat-ancestry","repeating_feat-class","repeating_feat-general","repeating_feat-bonus", "repeating_feat-skill", "repeating_lore", "repeating_items-worn", "repeating_items-readied", "repeating_items-other", "repeating_npc-items", "repeating_npc-melee-strikes", "repeating_npc-ranged-strikes","repeating_spellinnate","repeating_spellfocus","repeating_cantrip","repeating_normalspells", "repeating_interaction-abilities"]
        , "select_attributes": ["armor_class","saving_throws_strengthsave","saving_throws_fortitude","saving_throws_reflex","saving_throws_will","class_dc_key","perception","repeating_melee-strikes:weapon", "repeating_melee-strikes:damage","repeating_ranged-strikes:weapon","repeating_ranged-strikes:damage","acrobatics", "alchemy", "athletics", "awareness", "charm", "craft", "deception", "husbandry", "insight", "intimidation", "investigation", "lore", "medicine","navigation", "operate", "performance", "religion", "repair", "stealth", "survival", "tech", "thievery", "withstand","spell_attack_key","spell_dc_key"]
        , "skills": ["acrobatics", "alchemy", "athletics", "awareness", "charm", "craft", "deception", "husbandry", "insight", "intimidation", "investigation", "lore", "medicine", "navigation", "operate", "performance", "religion", "repair", "stealth", "survival", "tech", "thievery", "withstand"]
        , "skills_fields": ["ability","ability_select","rank","proficiency","item","armor","temporary","name"]
        , "repeating_skills": ["lore"]
        , "saves": ["saving_throws_strengthsave","saving_throws_fortitude","saving_throws_reflex","saving_throws_will"]
        , "saves_fields": ["ability","ability_select","rank","proficiency","item","temporary"]
        , "ac": ["armor_class"]
        , "ac_fields": ["ability","ability_select","dc_rank","proficiency","item","temporary","misc","dc_base","cap","shield_ac_bonus","shield_temporary"]
        , "hit_points": ["hit_points_ancestry","hit_points_class","hit_points_other","hit_points_item","constitution"]
        , "repeating_attacks": ["melee-strikes","ranged-strikes"]
        , "attacks_fields": ["weapon","weapon_ability_select","weapon_ability","weapon_proficiency","weapon_rank","weapon_item","weapon_temporary","weapon_traits","damage_dice","damage_dice_size","damage_ability_select","damage_ability","damage_b","damage_p","damage_s","damage_other","damage_effects","damage_additional"]
        , "perception": ["perception_ability_select","perception_ability","perception_rank","perception_proficiency","perception_item","perception_temporary"]
        , "class_dc": ["class_dc_key_ability_select","class_dc_key_ability","class_dc_proficiency","class_dc_rank","class_dc_item","class_dc_temporary"]
        , "spell_attack": ["spell_attack_key_ability_select","spell_attack_key_ability", "spell_attack_rank","spell_attack_proficiency","spell_attack_temporary"]
        , "spell_dc": ["spell_dc_key_ability_select","spell_dc_key_ability", "spell_dc_rank","spell_dc_proficiency","spell_dc_temporary"]
        , "magic_tradition": ["arcane","primal","occult","divine"]
        , "magic_tradition_fields": ["rank","proficiency"]
        , "repeating_spells": ["cantrip","spellinnate","spellfocus","normalspells"]
        , "spell_types": ["cantrips","innate","focus","normalspells"]
        , "spells_fields": ["area","attack_checkbox","cast","cast_actions","cast_detail_information","cast_detail_label","current_level","damage_ability","damage_additional","damage_checkbox","damage_dice","damage_misc","damage_type","description","domain","duration","frequency","heightened","magic_tradition","name","npc_attack_checkbox","npc_saving_throw_select","range","save_critical_failure","save_critical_success","save_failure","save_success","save_type","saving_throw_select","school","spell_dc","spellattack","spellattack_ability","spellattack_misc","spellattack_rank","spelldc","spelldc_ability","spelldc_misc","spelldc_rank","spelllevel","target","toggles","traits","uses","uses_max"]
        , "spells_fields_triggering": ["magic_tradition","damage_checkbox"]
        , "spells_calculation_attributes": ["sheet_type","level","magic_tradition_arcane_proficiency","magic_tradition_primal_proficiency","magic_tradition_occult_proficiency","magic_tradition_divine_proficiency","spell_dc","spell_dc_key_ability","spell_attack_key_ability_select","spell_dc_temporary","spell_attack","spell_attack_key_ability","spell_attack_temporary","roll_option_critical_damage"]
        , "repeating_bulks": ["worn","readied","other"]
        , "bulks_fields": ["quantity","bulk"]
        , "encumbrance_attributes": ["strength_modifier", "encumbered_modifier", "maximum_modifier"]
        , "translatables": ["modifier","ability_modifier","bonus","roll_bonus","roll_damage_bonus","#_damage_dice","use"]
    };
    // NPC attributes object for building NPC from Compendium
    const global_npc_attributes = {
        basics: ["npc_type","level","alignment","size","traits","perception","senses","languages","acrobatics","acrobatics_notes","alchemy","alchemy_notes","athletics","athletics_notes","awaremess","awareness_notes","charm","charm_notes","craft","craft_notes","deception","deception_notes","husbandry","husbandry_notes","insight","insight_notes","intimidation","intimidation_notes","investigation","investigation_notes","lore","lore_notes","medicine","medicine_notes","navigation","navigation_notes","operate","operate_notes","performance","performance_notes","religion","religion_notes","repair","repair_notes","stealth","stealth_notes","survival","survival_notes","tech","tech_notes","thievery","thievery_notes","withstand","withstand_notes","strength_modifier","dexterity_modifier","constitution_modifier","intelligence_modifier","wisdom_modifier","charisma_modifier","armor_class","armor_class_notes","saving_throws_strengthsave","saving_throws_fortitude","saving_throws_reflex","saving_throws_will","saving_throws_notes","hit_points_max","hit_points_notes","immunities","weaknesses","resistances","speed","speed_notes","spell_attack","spell_dc","focus_points_max"]
    };
    // Misc
    const global_magic_traditions = ["arcane","divine","primal","occult"];
    const global_spell_frequencies = ["constant","at-will","daily-limit"];
    const global_sizes = [
        {size:"tiny", squares: 1.0}
        , {size:"small", squares: 1.0}
        , {size:"medium", squares: 1.0}
        , {size:"large", squares: 2.0}
        , {size:"huge", squares: 3.0}
        , {size:"gargantuan", squares: 4.0}
    ];
    const global_rollregex = /(\d+d*\d*\+*\-*\d*)/gi; // Improvable Regex formula to parse damage dice rolls (like 1d6+2 or 2d4 or just ... 3)
    // Repeating sections and their attributes
    var global_repsecs = {
        "lore": {"section": "lore","attrs":global_attributes_by_category["skills_fields"].map(fld => `lore_${fld}`)}
    };

    // === UTILITIES
    const toTitleCase = function(str) {
        return str.replace(/\w\S*/g, function(txt){
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
        });
    };
    // -- Constant attribute names
    const getAttrNames = function(categories) {
        let names = [];
        categories.forEach((category) => {
            if(category in global_attributes_by_category) {
                names = names.concat(global_attributes_by_category[category]);
            }
        });
        return names;
    };
    // == Collecting repeating sections IDs
    const getRepSecIds = function(repsec_array,callback,repsec_agr) {
        // Returns an array of objects, aggregating ids and attributes for various repeating sections items
        // Parameters: Source (like global_repsecs["lore"]), callback function, Aggregate ([{section:string, ids:[ids], attrs:[attribute]}])
        // Courtesy of Scott C. :)
        let currsection = repsec_array.shift();
        if(currsection.section) {
            repsec_agr = repsec_agr || [];
            getSectionIDs(`repeating_${currsection.section}`, (itemsids)=>{
                repsec_agr.push({
                    section:currsection.section,
                    ids:itemsids,
                    attrs:currsection.attrs
                });
                if (_.isEmpty(repsec_array)) {
                    callback(repsec_agr);
                } else {
                    getRepSecIds(repsec_array,callback,repsec_agr);
                }
            });
        } else {
            if (_.isEmpty(repsec_array)) {
                callback(repsec_agr);
            } else {
                getRepSecIds(repsec_array,callback,repsec_agr);
            }
        }
    };
    // == Collecting repeating sections attributes
    const getRepSecFields = function(repsec_agr, other_attrs = []) {
        // Returns an array of attribute names from several repeating sections and optional other standard attributes
        // Parameters: Repeating section Aggregate ([{section:string, ids:[ids], attrs:[attributes]}]), [other attributes names]
        let repsecfields = [];
        _.each(repsec_agr, (current_section)=>{
            // console.log("*** DEBUG getRepsecFields section: " + current_section.section);
            _.each(current_section.ids, (id)=>{
                // console.log("*** DEBUG getRepsecFields ids: " + id);
                _.each(current_section.attrs, (attr)=>{
                    // console.log("*** DEBUG getRepsecFields attrs: " + attr);
                    repsecfields.push(`repeating_${current_section.section}_${id}_${attr}`);
                });
            });
        });
        return repsecfields.concat(other_attrs);
    };
    // == Collecting one repeating section and attributes in an array of objects
    const getRepSecObjectArray = function(section = "normalspell", attributesArray, callback) {
        // Gather all spells from a spell section and constitute a array of objets with [{id: ID, attribute: value}]
        let items = [];
        getSectionIDs(`repeating_${section}`, (ids) => {
            let fields = [];
            ids.forEach(id => {
                fields.push(...attributesArray.map(attribute => `repeating_${section}_${id}_${attribute}`));
            });
            getAttrs(fields, (values) => {
                ids.forEach(id => {
                    let item = {};
                    item["id"] = id;
                    attributesArray.forEach(attribute => {
                        item[attribute] = (values[`repeating_${section}_${id}_${attribute}`] || "");
                    });
                    items.push(item);
                });
                if(callback) {
                    callback(items);
                } else {
                    return items;
                }
            });
        });
    };
    // == Sorting (repeating section, objects ...)
    const defaultComparison = function(a, b) {
        // Standard sorting comparison
        if (a == b) return 0;
        return a < b ? -1 : 1;
    };
    const stringComparison = function(a, b) {
        // Sorting two strings ignoring casing and punctuation but not accents
        return String(a).localeCompare(String(b),getTranslationLanguage(),{"ignorePunctuation":true,"caseFirst":false,"sensitivity":"accent"});
    };
    const getComparisonFunction = function(primer = String, reverse = false) {
        // Sorting comparison
        let comparisonFunction;
        if(primer == String) {
            comparisonFunction = (a, b) => {
                return stringComparison(a, b);
            };
        } else {
            comparisonFunction = (a, b) => {
                return defaultComparison(primer(a), primer(b));
            };
        }
        if (reverse) {
            return function(a, b) {
                return -1 * comparisonFunction(a, b);
            };
        }
        return comparisonFunction;
    };
    const sortObjectArrayBy = function(sorting) {
        /* Sorting an array of objects.
            The `sorting` parameter is an array of sorting criteria(s), in the form of one or more attribute (key) names, or object(s) like {
                    name:"attribute name"
                    , primer: typing function name like parseInt. Defaults to String
                    , reverse: boolean. Ascending or descending order. Default to false.
                }
            Uses:
            * new array = arrayOfObjetcs.sort(sortObjectArrayBy(["name"]));
            * (same as) new array = arrayOfObjetcs.sort(sortObjectArrayBy([{name:"name", primer:String, reverse:false}]);
            * (multiple criterias : descending level and ascending name) new array = arrayOfObjetcs.sort(sortObjectArrayBy([{name:"current_level", primer:parseInt, reverse:true},"name"]);
        */
        let fields = [],
            n_fields = sorting.length, field, name, comparison;
        // preprocess sorting options
        for (let i = 0; i < n_fields; i++) {
            field = sorting[i];
            if (typeof field === "string") {
                name = field;
                comparison = stringComparison;
            } else {
                name = field.name;
                comparison = getComparisonFunction(field.primer, field.reverse);
            }
            fields.push({
                name: name,
                comparison: comparison
            });
        }
        // final comparison function
        return function(A, B) {
            let name, result;
            for (let i = 0; i < n_fields; i++) {
                result = 0;
                field = fields[i];
                name = field.name;
                result = field.comparison(A[name], B[name]);
                if (result !== 0) break;
            }
            return result;
        }
    };
    const sortRepeatingSection = function(section, attributes, sorting) {
        // sorting is an array of one or more attribute names, or object(s). See sortObjectArrayBy()
        getRepSecObjectArray(section, attributes, (items) => {
            let newItems = items.sort(sortObjectArrayBy(sorting));
            let sorted_attributes = newItems.map(item => `repeating_${section}_${item.id}`);
            setSectionOrder(section, sorted_attributes);
        });
    };

    // === GENERAL CALCULATIONS
    // -- Sheet opening (completing global variables, versioning etc.)
    const sheetOpen = function(eventinfo) {
        // Initialization at first opening of sheet per the user game session
        if (global_sheet_init_done === 0) {
            let update = {};
            // completing global variables
                // Attacks
            global_attributes_by_category["repeating_attacks"].forEach(category => {
                global_repsecs[category] = {"section": category, "attrs": global_attributes_by_category["attacks_fields"]};
            });
                // Spells
            global_attributes_by_category["repeating_spells"].forEach(category => {
                global_repsecs[category] = {"section": category, "attrs": ["magic_tradition"]};
            });
                // Bulk
            global_attributes_by_category["repeating_bulks"].forEach(category => {
                global_repsecs[category] = {"section": `items-${category}`, "attrs": global_attributes_by_category["bulks_fields"].map(attr => `${category}_${attr}`)};
            });
            // translatable texts for roll queries etc.
            global_attributes_by_category["translatables"].forEach(attr => {
                update[`text_${attr}`] = (getTranslationByKey(attr) || "").toUpperCase();
            });
            // ending initialization
            setAttrs(update, {silent: true}, () => {
                global_sheet_init_done = 1;
                versioning();
            });
        } else {
            versioning();
        }
    };
    // -- Calculates proficiency according to rank, level and misc bonus
    const calcProficiency = function(rank, level, misc) {
        let trng = (parseInt(rank) || 0);
        if(trng > 0) {
            return (trng + (parseInt(misc) || 0));
        } else {
            return (parseInt(misc) || 0);
        }
    };
    const calcProficiencyDisplay = function(rank) {
        switch(parseInt(rank) || 0) {
            default:
                return " ";
        }
    };
    // -- Returns the ability modifier of an ability select, based on the value of the select and the fact that it needs updating or not. values requires ability modifiers, plus the xxx_ability_select and xxx_ability attributes.
    const getSelectAbilityModifier = function(attr, values, update_ability = false) {
        let modifier = 0;
        if(update_ability) {
            if((values[`${attr}_ability_select`] === "custom") || (!values[`${attr}_ability_select`])) {
                modifier = (parseInt(values[`${attr}_ability`]) || 0);
            } else {
                modifier = (parseInt(values[values[`${attr}_ability_select`].slice(2,-1)]) || 0);
            }
        } else {
            modifier = (parseInt(values[`${attr}_ability`]) || 0);
        }
        // console.log(`%c getSelectAbilityModifier ${attr} ${update_ability} ${modifier}`, "color:purple;font-size:14px;");
        return modifier;
    };
    // --- General update (to cascade ability or level/proficiency updates)
    const totalUpdate = function(callback = null) {
        let debug_start = new Date(); // Performance measurement
        // == Gathering all necessary repeating section IDs
        getRepSecIds(JSON.parse(JSON.stringify(Object.values(global_repsecs))), (repsec_agr) => {
            // == Gathering all necessary attributes
            let tmpfields = ["character_name","sheet_type","level","query_roll_damage_dice","cp","sp","gp","pp","spell_attack","spell_dc","roll_option_critical_damage"];
            // --- Ability modifiers, Perception, Class DC, Hit Points
            tmpfields.push(...global_attributes_by_category["ability_modifiers"],...global_attributes_by_category["perception"],...global_attributes_by_category["class_dc"],...global_attributes_by_category["hit_points"],...global_attributes_by_category["spell_attack"],...global_attributes_by_category["spell_dc"], ...global_attributes_by_category["encumbrance_attributes"]);
            // --- Skills, Saves, AC etc.
            ["skills","saves","ac"].forEach(category => {
                global_attributes_by_category[category].forEach(attr => {
                    tmpfields.push(...global_attributes_by_category[`${category}_fields`].map(field => `${attr}_${field}`));
                });
            });
            // --- Magic_traditions
            global_attributes_by_category["magic_tradition"].forEach(tradition => {
                tmpfields.push(...global_attributes_by_category[`magic_tradition_fields`].map(field => `magic_tradition_${tradition}_${field}`));
            });
            // -- Add repeating section fields & remove duplicates
            let all_fields = getRepSecFields(repsec_agr,Array.from(new Set(tmpfields)));
            // == Gathering values
            getAttrs(all_fields, (values) => {
                // console.table(values);
                let big_update = {};
                let update = {}; // Will be used to collect intermediate updates and replace values in values, when necessary
                if((values["sheet_type"] || "").toLowerCase() === "npc") {
                    // NPCs : just update weapon strikes (for critical damage roll option) and spells for now
                    // == Attacks / Weapon strikes
                    global_attributes_by_category["repeating_attacks"].forEach(r_attack => {
                        repsec_agr.filter(current_section => current_section.section == r_attack)[0].ids.forEach(r_attack_id => {
                            _.extend(big_update, calcAttack(`repeating_${r_attack}_${r_attack_id}`,values,true));
                        });
                    });
                    // == Spells
                    global_attributes_by_category["repeating_spells"].forEach(r_spell => {
                        repsec_agr.filter(current_section => current_section.section == r_spell)[0].ids.forEach(r_spell_id => {
                            _.extend(big_update, calcSpell(`repeating_${r_spell}_${r_spell_id}_`,values));
                        });
                    });
                } else {
                    // == Starting re-calculation

                    // == Skills
                    // Fixed skills
                    global_attributes_by_category["skills"].forEach(skill => {
                        _.extend(big_update, calcSkill(skill,values,true));
                    });
                    // Repeating skills
                    global_attributes_by_category["repeating_skills"].forEach(r_skill => {
                        repsec_agr.filter(current_section => current_section.section == r_skill)[0].ids.forEach(r_skill_id => {
                            _.extend(big_update, calcSkill(`repeating_${r_skill}_${r_skill_id}_${r_skill}`,values,true));
                        });
                    });

                    // == Saves
                    global_attributes_by_category["saves"].forEach(save => {
                        _.extend(big_update, calcSave(save,values,true));
                    });

                    // == Armor Class (AC)
                    global_attributes_by_category["ac"].forEach(ac => {
                        _.extend(big_update, calcArmorClass(ac,values,true));
                    });

                    // == Hit Points
                    _.extend(big_update, calcHitPoints(values,true));

                    // == Perception
                    _.extend(big_update, calcPerception(values,true));

                    // == Class DC
                    _.extend(big_update, calcClassDc(values,true));

                    // == Attacks / Weapon strikes
                    global_attributes_by_category["repeating_attacks"].forEach(r_attack => {
                        repsec_agr.filter(current_section => current_section.section == r_attack)[0].ids.forEach(r_attack_id => {
                            _.extend(big_update, calcAttack(`repeating_${r_attack}_${r_attack_id}`,values,true));
                        });
                    });

                    // == Spell Attack
                    update = calcSpellAttack(values,true);
                    _.extend(big_update, update);
                    _.extend(values, update);

                    // == Spell DC
                    update = calcSpellDc(values,true);
                    _.extend(big_update, update);
                    _.extend(values, update);

                    // === Spells: Magic Tradition
                    global_attributes_by_category["magic_tradition"].forEach(tradition => {
                        update = calcMagicTradition(values,tradition);
                        _.extend(big_update, update);
                        _.extend(values, update);
                    });

                    // == Spells
                    global_attributes_by_category["repeating_spells"].forEach(r_spell => {
                        repsec_agr.filter(current_section => current_section.section == r_spell)[0].ids.forEach(r_spell_id => {
                            _.extend(big_update, calcSpell(`repeating_${r_spell}_${r_spell_id}_`,values));
                        });
                    });

                    // === Encumbrance / Bulk
                    update = calcEncumbrance(values);
                    _.extend(big_update, update);
                    _.extend(values, update);
                    _.extend(big_update, calcBulk(values,repsec_agr));
                };
                // == Updating (finally)
                // console.table(big_update);
                setAttrs(big_update, {silent: true}, ()=>{
                    console.log(`%c Pathfinder Second Edition by Roll20: ${(values["character_name"] || "Unnamed character")} updated (${new Date() - debug_start}ms)`, "color:purple;font-size:14px;");
                    if(callback) {
                        callback();
                    }
                });
            });
        });
    };

    // === VERSIONING ===
    const versioning = function(callback) {
        let fields = ["version","version_character","sheet_type","character_name"].concat(global_attributes_by_category["ability_modifiers"]);
        getAttrs(fields, (values) => {
            let version_sheet = parseFloat(values["version"]) || 0.0;
            let version_character = parseFloat(values["version_character"]) || 0.0;
            if (version_character === version_sheet) {
                console.log(`%c Pathfinder Second Edition by Roll20: ${(values["character_name"] || "Unnamed character")}, version ${version_character}`, "color:purple;font-size:14px;");
                if(callback) {
                    callback();
                }
            } else if (version_character === 0.0) {
                // Check if the character is pre-versioning
                let total_mods = 0;
                global_attributes_by_category["ability_modifiers"].forEach(modifier => {
                    total_mods += parseInt(values[modifier] || "0");
                });
                if(total_mods === 0) {
                    // new characteur, don"t update
                    setAttrs({"version_character": version_sheet}, {silent: true}, () => {
                        versioning(callback);
                    });
                } else {
                    // old character
                    setAttrs({"version_character": 1.0}, {silent: true}, () => {
                        versioning(callback);
                    });
                }
            } else if (version_character < 2.01) {
                versioningUpdateTo2_01(values, () => {
                    setAttrs({"version_character": 2.01}, {silent: true}, () => {
                        versioning(callback);
                    });
                });
            } else if (version_character < 2.05) {
                versioningUpdateTo2_05(values, () => {
                    setAttrs({"version_character": 2.05}, {silent: true}, () => {
                        versioning(callback);
                    });
                });
            } else if (version_character < 3.02) {
                versioningUpdateTo3_02(values, () => {
                    setAttrs({"version_character": 3.02}, {silent: true}, () => {
                        versioning(callback);
                    });
                });
            } else if (version_character < 3.03) {
                versioningUpdateTo3_03(values, () => {
                    setAttrs({"version_character": 3.03}, {silent: true}, () => {
                        versioning(callback);
                    });
                });
            } else if (version_character < 3.042) {
                versioningUpdateTo3_042(values, () => {
                    setAttrs({"version_character": 3.042}, {silent: true}, () => {
                        versioning(callback);
                    });
                });
            } else if (version_character < 3.06) {
                versioningUpdateTo3_06(values, () => {
                    setAttrs({"version_character": 3.06}, {silent: true}, () => {
                        versioning(callback);
                    });
                });
            } else if (version_character < 3.08) {
                versioningUpdateTo3_08(values, () => {
                    setAttrs({"version_character": 3.08}, {silent: true}, () => {
                        versioning(callback);
                    });
                });
            } else if (version_character < 3.09) {
                versioningUpdateTo3_09(values, () => {
                    setAttrs({"version_character": 3.09}, {silent: true}, () => {
                        versioning(callback);
                    });
                });
            } else {
                setAttrs({"version_character": version_sheet}, {silent: true}, () => {
                    versioning(callback);
                });
            }
        });
    };
    const versioningUpdateTo2_01 = function(versioning_values, versioningDoneUpdating) {
        console.log(`%c Pathfinder Second Edition by Roll20: ${(versioning_values["character_name"] || "Unnamed character")} updating to version 2.01`, "color:purple;font-size:13px;font-style:italic;");
        if((versioning_values["sheet_type"] || "").toLowerCase() !== "npc") {
            // Global recalculation to update all spells DC
            totalUpdate(versioningDoneUpdating);
        } else {
            versioningDoneUpdating();
        }
    };
    const versioningUpdateTo2_05 = function(versioning_values, versioningDoneUpdating) {
        console.log(`%c Pathfinder Second Edition by Roll20: ${(versioning_values["character_name"] || "Unnamed character")} updating to version 2.05`, "color:purple;font-size:13px;font-style:italic;");
        if((versioning_values["sheet_type"] || "").toLowerCase() === "npc") {
            // Update NPCs" npc_save_checkbox for innate and focule spells to handle new NPC spell DC handling
            getSectionIDs("spellinnate", (innate_ids) => {
                getSectionIDs("spellfocus", (focus_ids) => {
                    let fields = innate_ids.map(id => `repeating_spellinnate_${id}_npc_save_checkbox`).concat(focus_ids.map(id => `repeating_spellfocus_${id}_npc_save_checkbox`));
                    if(fields.length) {
                        getAttrs(fields, (values) => {
                            let update = {};
                            fields.forEach((attr) => {
                                if((values[attr] || "0") !== "0") { // the save checkbox was checked
                                    // update to new roll value with new savesepecialdc
                                    update[attr] = "{{savedc=[[@{spell_dc}[DC] + @{spelldc_misc}[MISC]]]}} {{savespecialdc=[[0 + @{spelldc}[DC] + @{spelldc_misc}[MISC]]]}} {{savedcmisc=[[0 + @{spelldc_misc}[MISC]]]}} {{savetype=^{@{save_type}}}} {{savecriticalsuccess=@{save_critical_success}}} {{savesuccess=@{save_success}}} {{savecriticalfailure=@{save_critical_failure}}} {{savefailure=@{save_failure}}}";
                                }
                            });
                            setAttrs(update, {silent: true}, ()  => {
                                // plus Global recalculation to update all spells DC
                                totalUpdate(versioningDoneUpdating);
                            });
                        });
                    } else {
                        // NPC without spells: nothing to do
                        versioningDoneUpdating();
                    }
                });
             });
        } else {
            // PC: nothing to do
            versioningDoneUpdating();
        }
    };
    const versioningUpdateTo3_02 = function(versioning_values, versioningDoneUpdating) {
        console.log(`%c Pathfinder Second Edition by Roll20: ${(versioning_values["character_name"] || "Unnamed character")} updating to version 3.02`, "color:purple;font-size:13px;font-style:italic;");
        /*
        Update spell damage checkbox to handle optional critical damage roll
        "{{roll02_name=^{damage}}} {{roll02=[[@{damage_dice} + (@{damage_ability}[ABI]) + @{damage_misc}[MISC] + @{query_roll_damage_bonus}[@{text_roll_damage_bonus}]]]}} {{roll02_type=damage}} {{roll02_info=@{damage_type}}} {{roll03_name=^{critical_damage}}} {{roll03=[[(@{damage_dice}+@{damage_ability}[ABI] + @{damage_misc}[MISC] + @{query_roll_damage_bonus}[@{text_roll_damage_bonus}])*2]]}} {{roll03_type=critical-damage}} {{roll03_info=@{damage_type}}}"
        =>
        "{{roll02_name=^{damage}}} {{roll02=[[@{damage_dice} + (@{damage_ability}[ABI]) + @{damage_misc}[MISC] + @{query_roll_damage_bonus}[@{text_roll_damage_bonus}]]]}} {{roll02_type=damage}} {{roll02_info=@{damage_type}}} @{roll_critical_damage}"
        */
        let spells_repsecs = {}, update = {};
        global_attributes_by_category["repeating_spells"].forEach(category => {
            spells_repsecs[category] = {"section": category, "attrs": ["damage_dice"]};
        });
        getRepSecIds(JSON.parse(JSON.stringify(Object.values(spells_repsecs))), (repsec_agr) => {
            getAttrs(getRepSecFields(repsec_agr), (values) => {
                repsec_agr.forEach(category => {
                    category.ids.forEach(id => {
                        if( (values[`repeating_${category.section}_${id}_damage_dice`] || "") !== "") {
                            update[`repeating_${category.section}_${id}_damage_checkbox`] = "{{roll02_name=^{damage}}} {{roll02=[[@{damage_dice} + (@{damage_ability}[ABI]) + @{damage_misc}[MISC] + @{query_roll_damage_bonus}[@{text_roll_damage_bonus}]]]}} {{roll02_type=damage}} {{roll02_info=@{damage_type}}} @{roll_critical_damage}";
                        }
                    });
                });
                setAttrs(update, {silent: true}, () => {
                    versioningDoneUpdating();
                });
            });
        });
    };
    const versioningUpdateTo3_03 = function(versioning_values, versioningDoneUpdating) {
        console.log(`%c Pathfinder Second Edition by Roll20: ${(versioning_values["character_name"] || "Unnamed character")} updating to version 3.03`, "color:purple;font-size:13px;font-style:italic;");
        /*
            This function is aimed at reducing repeating spell sections level 1 to 10 to one unique repeating section (version X of the sheet, alongside spell UI overhaul)
            And converting changed attributes (type => magic_tradition, save checkbox => save select and attack checkboxes)
        */
        let spells = ["spellinnate","spellfocus","cantrip","spell1","spell2","spell3","spell4","spell5","spell6","spell7","spell8","spell9","spell10"];
        let repsecs = {};
        let attributes = ["type","save_checkbox","npc_save_checkbox"].concat(global_attributes_by_category["spells_fields"]);
        spells.forEach(level => {
            repsecs[level] = {"section": level, "attrs": attributes};
        });
        getRepSecIds(JSON.parse(JSON.stringify(Object.values(repsecs))), (repsec_agr) => {
            let fields = ["sheet_type"].concat(getRepSecFields(repsec_agr));
            getAttrs(fields, (values) => {
                let update = {}, row = "", field = "";
                spells.forEach(level => {
                    repsec_agr.filter(current_section => current_section.section == level)[0].ids.forEach(id => { // for every ids of the spell section
                        if(["spellinnate","spellfocus","cantrip"].includes(level)){ // Updating other spell sections
                            row = `repeating_${level}_${id}_`;
                        } else { // Reducing spells lvl 1 to 10 to one section
                            row = `repeating_normalspells_${generateRowID()}_`;
                        }
                        attributes.forEach(attribute => { // for every possible attributee
                            if(["spellinnate","spellfocus","cantrip"].includes(level)){
                                field = `${row}${attribute}`;
                            } else {
                                field = `repeating_${level}_${id}_${attribute}`;
                            }
                            if(values[field]) {
                                switch(attribute) {
                                    case "type":
                                        update[`${row}magic_tradition`] = values[field];
                                        break;
                                    case "save_checkbox":
                                        if((values[field] || "0") !== "0") {
                                            update[`${row}saving_throw_select`] = "@{save_roll}";
                                        }
                                        break;
                                    case "npc_save_checkbox":
                                        if((values[field] || "0") !== "0") {
                                            update[`${row}npc_saving_throw_select`] = "@{npc_save_roll}";
                                        }
                                        break;
                                    case "attack_checkbox":
                                        if((values[field] || "0") !== "0") {
                                            if((values["sheet_type"] || "").toLowerCase() === "npc") {
                                                update[`${row}npc_attack_checkbox`] = "@{npc_attack_roll}";
                                            } else {
                                                update[`${row}attack_checkbox`] = "@{attack_roll}";
                                            }
                                        }
                                        break;
                                    case "npc_attack_checkbox":
                                        if((values[field] || "0") !== "0") {
                                            update[`${row}npc_attack_checkbox`] = "@{npc_attack_roll}";
                                        }
                                        break;
                                    case "damage_checkbox":
                                        if((values[field] || "0") !== "0") {
                                            update[`${row}damage_checkbox`] = "@{damage_roll}";
                                        }
                                        break;
                                    default:
                                        if(!["spellinnate","spellfocus","cantrip"].includes(level)){
                                            update[`${row}${attribute}`] = values[field];
                                        }
                                        break;
                                }
                            }
                        });
                        if(["spellinnate","spellfocus","cantrip"].includes(level)){ // Updating other spell sections
                            update[`${row}spelllevel`] = (values[`${row}spelllevel`] || "1");
                        } else { // Reducing spells lvl 1 to 10 to one section
                            update[`${row}spelllevel`] = level.replace(/[^\d]/gi,"");
                        }
                        update[`${row}current_level`] = update[`${row}spelllevel`];
                    });
                });
                // Saving new spell entries
                setAttrs(update, {silent: true}, () => {
                    // Removing old spells 1 to 10
                    repsec_agr.forEach(repsec => {
                        if(!["spellinnate","spellfocus","cantrip"].includes(repsec.section)){
                            repsec.ids.forEach(id => {
                                removeRepeatingRow(`repeating_${repsec.section}_${id}`);
                            });
                        }
                    });
                    if(versioningDoneUpdating) {
                        versioningDoneUpdating();
                    }
                });
            });
        });
    };
    const versioningUpdateTo3_042 = (versioning_values, versioningDoneUpdating) => {
        console.log(`%c Pathfinder Second Edition by Roll20: ${(versioning_values["character_name"] || "Unnamed character")} updating to version 3.042`, "color:purple;font-size:13px;font-style:italic;");
        // Re-synchronizing spell section toggles, and make sure color:default is in
        let toggles = "";
        let toggles_array = ["normalspells","cantrips","focus","innate"];
        let fields = ["toggles"].concat(toggles_array.map(toggle => `toggle_${toggle}`));
        getAttrs(fields, (values) => {
            toggles = (values["toggles"] || "");
            toggles_array.forEach(uniq => {
                if((values[`toggle_${uniq}`] || "0") === "0" && toggles.includes(uniq)) {
                    toggles = toggles.replace(uniq + ",","");
                } else if(!toggles.includes(uniq)){
                    toggles += `${uniq},`;
                }
            });
            if(!toggles.includes("color:default")) {
                toggles += "color:default,";
            }
            // Remove duplicates and empty strings, undefined, nulls and other "false" elements
            toggles = [...new Set(toggles.split(","))].filter(element => {return element != null && String(element).trim().length;}).join();
            setAttrs({"toggles": toggles}, {silent: true}, () => {
                if(versioningDoneUpdating) {
                    versioningDoneUpdating();
                }
            });
        });
    };
    const versioningUpdateTo3_06 = function(versioning_values, versioningDoneUpdating) {
        console.log(`%c Pathfinder Second Edition by Roll20: ${(versioning_values["character_name"] || "Unnamed character")} updating to version 3.06`, "color:purple;font-size:13px;font-style:italic;");
        // Fixing the actions & reactions repeating section items roll
        getSectionIDs("repeating_free-actions-reactions", (ids) => {
            let fields = [], update = {};
            ["free_action","reaction"].forEach(attr => {
                fields.push(...ids.map(id => `repeating_free-actions-reactions_${id}_${attr}`));
            });
            getAttrs(fields, (values) => {
                ids.forEach(id => {
                    update[`repeating_free-actions-reactions_${id}_action_type`] = (`${(values[`repeating_free-actions-reactions_${id}_free_action`] || "0") == "0" ? "" : toTitleCase(getTranslationByKey("free_action"))} `
                    + `${(values[`repeating_free-actions-reactions_${id}_reaction`] || "0") == "0" ? "" : toTitleCase(getTranslationByKey("reaction"))} `).trim();
                });
                setAttrs(update, {silent: true}, () => {
                    totalUpdate(versioningDoneUpdating);
                });
            });
        });
    };
    const versioningUpdateTo3_08 = function(versioning_values, versioningDoneUpdating) {
        console.log(`%c Pathfinder Second Edition by Roll20: ${(versioning_values["character_name"] || "Unnamed character")} updating to version 3.08`, "color:purple;font-size:13px;font-style:italic;");
        // Refreshing Character for TEML proficiency display improvements
        getAttrs(["sheet_type"], (values) => {
            if((values["sheet_type"] || "").toLowerCase() !== "npc"){
                totalUpdate(versioningDoneUpdating);
            }
        });
    };
    const versioningUpdateTo3_09 = function(versioning_values, versioningDoneUpdating) {
        console.log(`%c Pathfinder Second Edition by Roll20: ${(versioning_values["character_name"] || "Unnamed character")} updating to version 3.09`, "color:purple;font-size:13px;font-style:italic;");
        /*
            This function is aimed at reducing PC's Actions & Activities, and Reactions & Free Actions repeating sections into one new  Actions repeating section
        */
        getAttrs(["sheet_type"], (chartyp) => {
            if((chartyp["sheet_type"] || "").toLowerCase() !== "npc"){
                getSectionIDs("repeating_actions-activities", (ids_aa) => {
                    getSectionIDs("repeating_free-actions-reactions", (ids_ar) => {
                        // collecting attributes
                        let fields = [];
                        let fields_aa = ["name","actions","traits","source","description"];
                        let fields_ar = ["name","free_action","reaction","traits","source","trigger","description"];
                        ids_aa.forEach(id => {
                            fields_aa.forEach(attr => {
                                fields.push(`repeating_actions-activities_${id}_${attr}`);
                            });
                        });
                        ids_ar.forEach(id => {
                            fields_ar.forEach(attr => {
                                fields.push(`repeating_free-actions-reactions_${id}_${attr}`);
                            });
                        });
                        getAttrs(fields, (values) => {
                            let update = {};
                            // Adding new Actions rows
                            ids_aa.forEach(id => {
                                let row = `repeating_actions_${generateRowID()}_`;
                                update[`${row}toggles`] = "display,";
                                update[`${row}action`] = "1-action";
                                fields_aa.forEach(attr => {
                                    if(attr === "actions" && (values[`repeating_actions-activities_${id}_actions`] || "")) {
                                        update[`${row}action`] = "other";
                                        update[`${row}other`] = values[`repeating_actions-activities_${id}_actions`];
                                    } else {
                                        update[`${row}${attr}`] = (values[`repeating_actions-activities_${id}_${attr}`] || "");
                                    }
                                });
                                // action type string
                                update[`${row}action_type`] = toTitleCase(getTranslationByKey((update[`${row}action`] || "1-action")));
                            });
                            ids_ar.forEach(id => {
                                let row = `repeating_actions_${generateRowID()}_`;
                                update[`${row}toggles`] = "display,";
                                update[`${row}action`] = "free_action";
                                fields_ar.forEach(attr => {
                                    if(attr === "free_action" && (values[`repeating_free-actions-reactions_${id}_${attr}`] || "") === "free action") {
                                        update[`${row}action`] = "free_action";
                                    } else if(attr === "reaction" && (values[`repeating_free-actions-reactions_${id}_${attr}`] || "") === "reaction") {
                                        update[`${row}action`] = "reaction";
                                    } else {
                                        update[`${row}${attr}`] = (values[`repeating_free-actions-reactions_${id}_${attr}`] || "");
                                    }
                                });
                                // action type string
                                update[`${row}action_type`] = toTitleCase(getTranslationByKey((update[`${row}action`] || "free_action")));
                            });
                            update["color_scheme"] = "default";
                            setAttrs(update, {silent: true}, () => {
                                // Removing old ids
                                ids_aa.forEach(id => removeRepeatingRow(id));
                                ids_ar.forEach(id => removeRepeatingRow(id));
                                versioningDoneUpdating();
                            });
                        });
                    });
                });
            } else {
                // NPC: nothing to do
                versioningDoneUpdating();
            }
        });
    };

    // === ABILITIES
    const updateAbility = function(attr) {
        console.log(`%c Update ability ${attr}`, "color:purple;font-size:14px;");
        let fields = [`${attr}_score`,`${attr}_score_temporary`,`${attr}_modifier_temporary`, `constitution_tenacity_drain`];
        getAttrs(fields, (values) => {
            setAttrs(calcAbility(attr,values), {silent: true}, () => {
				updateTenacity(attr);
                totalUpdate();
            });
        });
    };
    const calcAbility = function (attr, values) {
        let update = {}, mod = 0;
        update[`${attr}`] = (parseInt(values[`${attr}_score`]) || 0) + (parseInt(values[`${attr}_score_temporary`]) || 0);
        mod = (Math.floor((parseInt(update[`${attr}`], 10) - 10) / 2) || 0) + (parseInt(values[`${attr}_modifier_temporary`]) || 0);

		if (attr === "constitution") {
			update[`${attr}`] -= values[`constitution_tenacity_drain`];
		}

        update[`${attr}_modifier`] = mod;
        if(attr === "strength") {
            if(mod < 0) {
                update[`${attr}_modifier_half`] = mod;
            } else {
                update[`${attr}_modifier_half`] = Math.floor(mod/2);
            }
        }
        return update;
    };

	const updateTenacity = function(attr) {
        console.log(`%c Update tenacity ${attr}`, "color:purple;font-size:14px;");
		var abilities = getAttrNames(['abilities']);
		let fields = [];
		abilities.forEach(ability => {fields = fields.concat([`${ability}_score`,`${ability}_score_temporary`,`${ability}_modifier_temporary`,`${ability}_modifier`, `${ability}_tenacity_mod`])})
        getAttrs(fields, (values) => {
            setAttrs(calcTenacity(attr,values), {silent: true}, () => {
				updateTenacityDrain();
			});
        });
	}

	const calcTenacity = function (attr, values) {
		let update = {};
		if (attr !== "charisma") {
			var baseMod = ((Math.floor((parseInt(values[`${attr}_score`], 10) - 10) / 2) || 0) || 0);
			update[`${attr}_max_tenacity`] = Math.max(baseMod + parseInt(values[`charisma_modifier`]) + parseInt(values[`${attr}_tenacity_mod`]), 0);
		}
		else {
			var abilities = getAttrNames(['abilities']);
			
			abilities.forEach(ability => {
				var baseMod = ((Math.floor((parseInt(values[`${ability}_score`], 10) - 10) / 2) || 0) || 0);
				update[`${ability}_max_tenacity`] = Math.max(baseMod + parseInt(values[`charisma_modifier`]) + parseInt(values[`${ability}_tenacity_mod`]), 0);
			})
		}

        return update;
	}

	const updateTenacityDrain = function() {
		var abilities = getAttrNames(['abilities']);
		let fields = [];
		abilities.forEach(ability => {fields = fields.concat([`${ability}`, `${ability}_score`,`${ability}_score_temporary`,`${ability}_modifier_temporary`,`${ability}_modifier`, `${ability}_tenacity_mod`, `${ability}_max_tenacity`, `${ability}_tenacity`])})

		getAttrs(fields, (values) => {
            setAttrs(calcTenacityDrain(values), {silent: true}, () => {
				updateHitPoints();
			});
        });
	}

	const calcTenacityDrain = function (values) {
        console.log(`%c Update tenacity drain`, "color:purple;font-size:14px;");
		let update = {}
		var drain = 0;
		var abilities = getAttrNames(['abilities']);

		abilities.forEach(ability => {
			var excess = parseInt(values[`${ability}_tenacity`]) - values[`${ability}_max_tenacity`];
			if (excess > 0) {
				drain += excess;
			}
		})

		update[`constitution_tenacity_drain`] = drain;

		update[`constitution`] = (parseInt(values[`constitution_score`]) || 0) + (parseInt(values[`constitution_score_temporary`]) || 0) - drain;
        mod = (Math.floor((parseInt(update['constitution'], 10) - 10) / 2) || 0) + (parseInt(values[`constitution_modifier_temporary`]) || 0);

		return update;
	}

    // === SKILLS
    const updateSkill = function(id, attr, callback) {
        console.log(`%c Update skill ${attr}`, "color:purple;font-size:14px;");
        let fields = ["sheet_type","level"];
        fields.push(...global_attributes_by_category["ability_modifiers"],...global_attributes_by_category["skills_fields"].map(field => `${id}_${field}`));
        getAttrs(fields, (values) => {
            let update_ability = true;
            if(attr.includes("ability")) {
                update_ability = false;
            }
            setAttrs(calcSkill(id,values,update_ability), {silent: true}, () => {
                if(callback) {
                    callback();
                }
            });
        });
    };
    const calcSkill = function(attr, values, update_ability = false) {
        let update = {};
        if((values["sheet_type"] || "").toLowerCase() != "npc") {
            update[`${attr}_ability`] = getSelectAbilityModifier(attr, values, update_ability);
            update[`${attr}_proficiency`] = calcProficiency(values[`${attr}_rank`], values["level"]);
            update[`${attr}_proficiency_display`] = calcProficiencyDisplay(values[`${attr}_rank`]);
            update[attr] = (parseInt(update[`${attr}_ability`]) || 0)
                + (parseInt(update[`${attr}_proficiency`]) || 0)
                + (parseInt(values[`${attr}_item`]) || 0)
                + (parseInt(values[`${attr}_armor`]) || 0)
                + (parseInt(values[`${attr}_temporary`]) || 0);
        }
        return update;
    };

    // === SAVES
    const updateSave = function(id, attr, callback) {
        console.log(`%c Update save ${attr}`, "color:purple;font-size:14px;");
        let fields = ["sheet_type","level"];
        fields.push(...global_attributes_by_category["ability_modifiers"],...global_attributes_by_category["saves_fields"].map(field => `${id}_${field}`));
        getAttrs(fields, (values) => {
            let update_ability = true;
            if(attr.includes("ability")) {
                update_ability = false;
            }
            setAttrs(calcSave(id,values,update_ability), {silent: true}, () => {
                if(callback) {
                    callback();
                }
            });
        });
    };
    const calcSave = function(attr, values, update_ability = false) {
        let update = {};
        if((values["sheet_type"] || "").toLowerCase() != "npc") {
            update[`${attr}_ability`] = getSelectAbilityModifier(attr, values, update_ability);
            update[`${attr}_proficiency`] = calcProficiency(values[`${attr}_rank`], values["level"]);
            update[`${attr}_proficiency_display`] = calcProficiencyDisplay(values[`${attr}_rank`]);
            update[attr] = (parseInt(update[`${attr}_ability`]) || 0)
                + (parseInt(update[`${attr}_proficiency`]) || 0)
                + (parseInt(values[`${attr}_item`]) || 0)
                + (parseInt(values[`${attr}_temporary`]) || 0);
        }
        return update;
    };

    // === ARMOR CLASS (AC)
    const updateArmorClass = function(id, attr, callback) {
        console.log(`%c Update AC ${attr}`, "color:purple;font-size:14px;");
        let fields = ["sheet_type","level"];
        fields.push(...global_attributes_by_category["ability_modifiers"],...global_attributes_by_category["ac_fields"].map(field => `${id}_${field}`));
        getAttrs(fields, (values) => {
            let update_ability = true;
            if(attr.includes("ability")) {
                update_ability = false;
            }
            setAttrs(calcArmorClass(id,values,update_ability), {silent: true}, () => {
                if(callback) {
                    callback();
                }
            });
        });
    };
    const calcArmorClass = function(attr, values, update_ability = false) {
        let update = {}, ability = 0;
        if((values["sheet_type"] || "").toLowerCase() != "npc") {
            // Ability modifier
            ability = getSelectAbilityModifier(attr, values, update_ability);
            update[`${attr}_ability`] = ability;
            // Managing armor cap
            ability = Math.min(ability,parseInt((values[`${attr}_cap`] || "99")));
            // Proficiency
            update[`${attr}_proficiency`] = calcProficiency(values[`${attr}_dc_rank`], values["level"]);
            update[`${attr}_proficiency_display`] = calcProficiencyDisplay(values[`${attr}_dc_rank`]);
            // AC
            update[attr] = (parseInt(values[`${attr}_dc_base`]) || 10)
                + ability
				+ (parseInt(values[`${attr}_misc`]) || 0)
                + (parseInt(values[`${attr}_proficiency`]) || 0)
                + (parseInt(values[`${attr}_item`]) || 0)
                + (parseInt(values[`${attr}_temporary`]) || 0);
            // Shield
            update[`${attr}_shield`] = (parseInt(values[`${attr}_shield_ac_bonus`]) || 0)
                + (parseInt(values[`${attr}_shield_temporary`]) || 0);
        }
        return update;
    };

    // === HIT POINTS (HP)
    const updateHitPoints = function(attr, callback) {
        console.log(`%c Update HP ${attr}`, "color:purple;font-size:14px;");
        let fields = ["sheet_type","level","constitution"];
        fields.push(...global_attributes_by_category["ability_modifiers"],...global_attributes_by_category["hit_points"]);
        getAttrs(fields, (values) => {
            setAttrs(calcHitPoints(values), {silent: true}, () => {
                if(callback) {
                    callback();
                }
            });
        });
    };
    const calcHitPoints = function(values) {
        let update = {};
        if((values["sheet_type"] || "").toLowerCase() != "npc") {
            update["hit_points_max"] = (2 * parseInt(values[`constitution`]))
                + (parseInt(values[`hit_points_other`]) || 0)
                + (parseInt(values[`hit_points_item`]) || 0);
        }
        return update;
    };

    // === ATTACKS
    const updateAttack = function(id, attr, callback) {
        console.log(`%c Update attack ${attr}`, "color:purple;font-size:14px;");
        let fields = ["sheet_type","level","query_roll_damage_dice","roll_option_critical_damage"];
        fields.push(...global_attributes_by_category["ability_modifiers"],...global_attributes_by_category["attacks_fields"].map(field => `${id}_${field}`));
        getAttrs(fields, (values) => {
            let update_ability = true;
            if(attr.includes("ability")) {
                update_ability = false;
            }
            setAttrs(calcAttack(id,values,update_ability), {silent: true}, () => {
                if(callback) {
                    callback();
                }
            });
        });
    };
    const calcAttack = function(id, values, update_ability = false) {
        let update = {};
        let critoption = (values["roll_option_critical_damage"] || "auto"); // critical damage roll option
        if((values["sheet_type"] || "").toLowerCase() === "npc") {
            // Critical damage roll option handling
            switch (critoption) {
                case "none":
                    update[`${id}_roll_critical_damage_npc`] = " "; // no critical damage roll
                    break
                case "button":
                    update[`${id}_roll_critical_damage_npc`] = "@{roll_critical_damage_button_npc}"; // chat button
                    break
                case "auto":
                    update[`${id}_roll_critical_damage_npc`] = "@{damage_critical_roll_npc}"; // auto roll critical damage
                    break
                default:
                    update[`${id}_roll_critical_damage_npc`] = "@{damage_critical_roll_npc}"; // auto roll critical damage
            }
        } else { // PC
            // Ability modifiers handling
            let weapon_ability = getSelectAbilityModifier(`${id}_weapon`, values, update_ability);
            update[`${id}_weapon_ability`] = weapon_ability;
            let damage_ability = getSelectAbilityModifier(`${id}_damage`, values, update_ability);
            update[`${id}_damage_ability`] = damage_ability;
            // Attack: calculating attack display value ("weapon_strike")
            update[`${id}_weapon_proficiency`] = calcProficiency(values[`${id}_weapon_rank`], values["level"]);
            update[`${id}_weapon_proficiency_display`] = calcProficiencyDisplay(values[`${id}_weapon_rank`]);
            let weapon_strike = weapon_ability
                + (parseInt(update[`${id}_weapon_proficiency`]) || 0)
                + (parseInt(values[`${id}_weapon_item`]) || 0)
                + (parseInt(values[`${id}_weapon_temporary`]) || 0);
            update[`${id}_weapon_strike`] = weapon_strike;
            // Damage: calculating dice and total fixed damage
            update[`${id}_damage_dice`] = (parseInt(values[`${id}_damage_dice`]) || 0);
            if((parseInt(values[`${id}_damage_dice_size`].replace(/[^\d]/gi,"")) || 0)) {
                update[`${id}_damage_dice_size`] = `D${parseInt(values[`${id}_damage_dice_size`].replace(/[^\d]/gi,""))}`;
            } else {
                update[`${id}_damage_dice_size`] = "D0";
            }
            let damage_dice = `${update[`${id}_damage_dice`]}${update[`${id}_damage_dice_size`]}`;
            let damage_bonus = damage_ability
                + (parseInt(values[`${id}_damage_other`]) || 0);
            // Attack display
            update[`${id}_weapon_display`] = `${update[`${id}_weapon_proficiency_display`] || ""} ${weapon_strike < 0 ? "" : "+"}${weapon_strike}${(values[`${id}_weapon_traits`] || "").length ? " ("+values[`${id}_weapon_traits`]+")" : ""}`.trim();
            // Damage display
            update[`${id}_damage_display`] = `${damage_dice == "0D0" ? "" : damage_dice}${damage_bonus < 0 ? "" : "+"}${damage_bonus}${(values[`${id}_damage_effects`] || "").length ?  " + "+values[`${id}_damage_effects`] : ""}${(values[`${id}_damage_additional`] || "").length ?  " + "+values[`${id}_damage_additional`] : ""}`;
            // Damage Roll: calculating info to include translated damage type
            let damage_info = "";
            if((values[`${id}_damage_effects`] || "").length) {
                damage_info += ` + @{damage_effects}`;
            }
            update[`${id}_damage_info`] = damage_info.trim();
            // Damage roll : query damage dice # or not
            if((values[`query_roll_damage_dice`] || "0") == "0") {
                update[`${id}_damage_dice_query`] = "@{damage_dice}";
            } else {
                update[`${id}_damage_dice_query`] = values[`query_roll_damage_dice`];
            }
            // Forced update to attack and damage rolls (in case of logic change)
            update[`${id}_weapon_roll`] = "{{roll01_name=^{attack}}} {{roll01=[[1d20cs>@{weapon_crit_range}cf1 + [@{weapon_proficiency_display}] @{weapon_strike}[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{roll01_type=attack}} {{roll01_info=@{weapon_traits}}} {{roll01_critical=1}}";
            update[`${id}_critical_confirm`] = "{{criticalconfirm_name=^{critical_confirm}}} {{criticalconfirm=[[1d20cf1 + [@{weapon_proficiency_display}] @{weapon_strike}[@{text_modifier}] + (@{query_roll_bonus})[@{text_bonus}]]]}} {{criticalconfirm_type=critical-damage}} {{criticalconfirm_info=@{weapon_traits}}}";
			update[`${id}_damage_roll`] = `{{roll02_name=^{damage}}} {{roll02=[[@{damage_dice_query}@{damage_dice_size} + @{damage_ability}[@{text_ability_modifier}] + @{damage_other}[${(getTranslationByKey("other") || "").toUpperCase()}] + @{query_roll_damage_bonus}[@{text_roll_damage_bonus}]]]}} {{roll02_type=damage}} {{roll02_info=@{damage_info}}}`;
            update[`${id}_damage_critical_roll`] = `{{criticalroll_name=^{critical_damage}}} {{criticalroll=[[(@{damage_dice_query}*@{weapon_crit_mult})@{damage_dice_size} + @{damage_ability}[@{text_ability_modifier}] + @{damage_other}[${(getTranslationByKey("other") || "").toUpperCase()}] + @{query_roll_damage_bonus}[@{text_roll_damage_bonus}]]]}} {{criticalroll_type=critical-damage}} {{criticalroll_info=@{damage_info}}}`;
            // Critical damage roll option handling
            switch (critoption) {
                case "none":
                    update[`${id}_roll_critical_damage`] = " "; // no critical damage roll
                    break
                case "button":
                    update[`${id}_roll_critical_damage`] = "@{roll_critical_damage_button}"; // chat button
                    break
                case "auto":
                    update[`${id}_roll_critical_damage`] = "@{damage_critical_roll}"; // auto roll critical damage
                    break
                default:
                    update[`${id}_roll_critical_damage`] = "@{damage_critical_roll}"; // auto roll critical damage
            }
        }
        return update;
    };

    // === PERCEPTION
    const updatePerception = function(attr, callback) {
        console.log(`%c Update perception ${attr}`, "color:purple;font-size:14px;");
        let fields = ["sheet_type","level"];
        fields.push(...global_attributes_by_category["ability_modifiers"],...global_attributes_by_category["perception"]);
        getAttrs(fields, (values) => {
            let update_ability = true;
            if(attr.includes("ability")) {
                update_ability = false;
            }
            setAttrs(calcPerception(values, update_ability), {silent: true}, () => {
                if(callback) {
                    callback();
                }
            });
        });
    };
    const calcPerception = function(values, update_ability = false) {
        let update = {};
        if((values["sheet_type"] || "").toLowerCase() != "npc") {
            update["perception_ability"] = getSelectAbilityModifier("perception", values, update_ability);
            update["perception_proficiency"] = calcProficiency(values["perception_rank"], values["level"]);
            update["perception_proficiency_display"] = calcProficiencyDisplay(values["perception_rank"]);
            update["perception"] = (parseInt(update["perception_ability"]) || 0)
                + (parseInt(update["perception_proficiency"]) || 0)
                + (parseInt(values["perception_item"]) || 0)
                + (parseInt(values["perception_temporary"]) || 0);
        }
        return update;
    };

    // === CLASS DC
    const updateClassDc = function(attr, callback) {
        console.log(`%c Update Class DC ${attr}`, "color:purple;font-size:14px;");
        let fields = ["sheet_type","level"];
        fields.push(...global_attributes_by_category["ability_modifiers"],...global_attributes_by_category["class_dc"]);
        getAttrs(fields, (values) => {
            let update_ability = true;
            if(attr.includes("ability")) {
                update_ability = false;
            }
            setAttrs(calcClassDc(values, update_ability), {silent: true}, () => {
                if(callback) {
                    callback();
                }
            });
        });
    };
    const calcClassDc = function(values, update_ability = false) {
        let update = {};
        if((values["sheet_type"] || "").toLowerCase() != "npc") {
            update["class_dc_key_ability"] = getSelectAbilityModifier("class_dc_key", values, update_ability);
            update["class_dc_proficiency"] = Math.floor(parseInt(values["level"] / 2))
            update["class_dc_proficiency_display"] = calcProficiencyDisplay(values["class_dc_rank"]);
            update["class_dc"] = 10
                + (parseInt(update["class_dc_key_ability"]) || 0)
                + (parseInt(values["class_dc_item"]) || 0)
                + (parseInt(values["class_dc_temporary"]) || 0)
				+ (Math.floor(parseInt(values["level"]) / 2) || 0);
        }
        return update;
    };

    // === SPELL ATTACKS
    const updateSpellAttack = function(attr, callback) {
        console.log(`%c Update spell attack ${attr}`, "color:purple;font-size:14px;");
        let fields = ["sheet_type","level"];
        fields.push(...global_attributes_by_category["ability_modifiers"],...global_attributes_by_category["spell_attack"]);
        getAttrs(fields, (values) => {
            let update_ability = true;
            if(attr.includes("ability")) {
                update_ability = false;
            }
            setAttrs(calcSpellAttack(values, update_ability), {silent: true}, () => {
                if(callback) {
                    callback();
                }
            });
        });

    };
    const calcSpellAttack = function(values, update_ability = false) {
        let update = {};
        if((values["sheet_type"] || "").toLowerCase() != "npc") {
            update["spell_attack_key_ability"] = getSelectAbilityModifier("spell_attack_key", values, update_ability);
            update["spell_attack_proficiency"] = calcProficiency(values["spell_attack_rank"], values["level"]);
            update["spell_attack_proficiency_display"] = calcProficiencyDisplay(values["spell_attack_rank"]);
            update["spell_attack"] = (parseInt(update["spell_attack_key_ability"]) || 0)
                + (parseInt(update["spell_attack_proficiency"]) || 0)
                + (parseInt(values["spell_attack_temporary"]) || 0);
        }
        return update;
    };

    // === SPELL DC
    const updateSpellDc = function(attr, callback) {
        console.log(`%c Update spell DC ${attr}`, "color:purple;font-size:14px;");
        let fields = ["sheet_type","level"];
        fields.push(...global_attributes_by_category["ability_modifiers"],...global_attributes_by_category["spell_dc"]);
        getAttrs(fields, (values) => {
            let update_ability = true;
            if(attr.includes("ability")) {
                update_ability = false;
            }
            setAttrs(calcSpellDc(values, update_ability), {silent: true}, () => {
                if(callback) {
                    callback();
                }
            });
        });
    };
    const calcSpellDc = function(values, update_ability = false) {
        let update = {};
        if((values["sheet_type"] || "").toLowerCase() != "npc") {
            update["spell_dc_key_ability"] = getSelectAbilityModifier("spell_dc_key", values, update_ability);
            update["spell_dc_proficiency"] = calcProficiency(values["spell_dc_rank"], values["level"]);
            update["spell_dc_proficiency_display"] = calcProficiencyDisplay(values["spell_dc_rank"]);
            update["spell_dc"] = 10
                + (parseInt(update["spell_dc_key_ability"]) || 0)
                + (parseInt(update["spell_dc_proficiency"]) || 0)
                + (parseInt(values["spell_dc_temporary"]) || 0)
                // + (parseInt(values["spell_dc_item"]) || 0)
                ;
        }
        return update;
    };

    // === SPELLS: MAGIC TRADITIONS
    const updateMagicTradition = function(attr, tradition, callback) {
        console.log(`%c Update Magic Tradition ${tradition} with ${attr}`, "color:purple;font-size:14px;");
        let fields = ["sheet_type","level"];
        global_attributes_by_category["magic_tradition_fields"].forEach(field => {
            fields.push(`magic_tradition_${tradition}_${field}`);
        });
        getAttrs(fields, (values) => {
            setAttrs(calcMagicTradition(values, tradition), {silent: true}, () => {
                if(callback) {
                    callback();
                }
            });
        });
    };
    const calcMagicTradition = function(values, tradition) {
        let update = {};
        if((values["sheet_type"] || "").toLowerCase() != "npc") {
            update[`magic_tradition_${tradition}_proficiency`] = calcProficiency(values[`magic_tradition_${tradition}_rank`], values["level"]);
            // update[`magic_tradition_${tradition}_proficiency_display`] = calcProficiencyDisplay(values[`magic_tradition_${tradition}_rank`]);
        }
        return update;
    };

    // === SPELLS: SPELL
    const updateSpell = function(row, attr, callback) {
        console.log(`%c Update spell ${attr}`, "color:purple;font-size:14px;");
        let fields = global_attributes_by_category["spells_calculation_attributes"];
        fields.push(`${row}magic_tradition`);
        getAttrs(fields, (values) => {
            setAttrs(calcSpell(row,values), {silent: true}, () => {
                if(callback) {
                    callback();
                }
            });
        });
    };
    const calcSpell = function(row, values) {
        /*
            Calculating DC (dc) and Attack (spellattack) value based on chosen magic tradition:
            If no magic tradition has been chosen on the spell, then standard spell DC (spell_dc) and standard spell attack (spell_attack) are used.
            Otherwise (a magic tradition has been selected for the spell), a specifi spell base DC and attack are calcuted based on magic tradition proficiency and relative (DC or Attack) ability modifiers and temporary bonuses.
            In a future version, full magic tradition attack and DC should be calcultared with their own ability modifiers and temporary bonuses (ie a full setting section for each magic tradition, with notes and all)
        */
        let update = {};
        let tradition = (values[`${row}magic_tradition`] || "empty-string");
        if((values["sheet_type"] || "").toLowerCase() == "npc") { // NPC
            update[`${row}spellattack`] = values["spell_attack"];
            update[`${row}spell_dc`] = values["spell_dc"];
        } else { // PC
            if(tradition == "empty-string") {
                update[`${row}spellattack`] = values["spell_attack"];
                update[`${row}spelldc`] = values["spell_dc"];
            } else {
                update[`${row}spellattack`] = (parseInt(values[`magic_tradition_${tradition}_proficiency`]) || 0)
                + (parseInt(values[`spell_attack_key_ability`]) || 0)
                + (parseInt(values[`spell_attack_temporary`]) || 0);
                update[`${row}spelldc`] = 10
                + (parseInt(values[`magic_tradition_${tradition}_proficiency`]) || 0)
                + (parseInt(values[`spell_dc_key_ability`]) || 0)
                + (parseInt(values[`spell_dc_temporary`]) || 0);
            }
        }
        // critical damage roll option
        switch (values["roll_option_critical_damage"] || "auto") {
            case "none":
                update[`${row}roll_critical_damage`] = " "; // no critical damage roll
                break
            case "button":
                update[`${row}roll_critical_damage`] = "@{roll_critical_damage_button}"; // chat button
                break
            case "auto":
                update[`${row}roll_critical_damage`] = "@{damage_critical_roll}"; // auto roll critical damage
                break
            default:
                update[`${row}roll_critical_damage`] = "@{damage_critical_roll}"; // auto roll critical damage
        }
        return update;
    };

    // === SPELLS: DROP
    const updateSpellDrop = function(section, rawdata) {
        // Checking dropped data from comendium for spell building
        let cdata;
        try{
            cdata = JSON.parse(rawdata) || {};
        }
        catch(error){
            cdata = {};
            console.log(`%c Pathfinder Second Edition by Roll20: drop on ${section}: no valid data`, "color:red;font-size:14px;");
        }
        if(_.isEmpty(cdata)) {
            console.log(`%c Pathfinder Second Edition by Roll20: drop on ${section}: empty data`, "color:red;font-size:14px;");
        } else {
            // console.log(`%c PF2E Debug: Spell data: ${JSON.stringify(cdata,null,"  ")}`, "color:purple;font-size:12px;");
            if(cdata["Category"] && (cdata["Category"].trim().toLowerCase() === "spells")) {
                let fields = global_attributes_by_category["spells_calculation_attributes"];
                fields.push(`${section}_spelldrop_name`,`${section}_spelldrop_uniq`,`sort_${section}`);
                getAttrs(fields, (values) => {
                    if(values[`${section}_spelldrop_name`]) {
                        let row = `repeating_${section}_${generateRowID()}_`, spell_data = {}, update = {};
                        spell_data["name"] = values[`${section}_spelldrop_name`];
                        spell_data["data"] = cdata;
                        // Base properties
                        update[`${row}name`] = spell_data["name"];
                        update[`${row}toggles`] = "display,";
                        // Extended properties from Compendium
                        _.extend(update,calcDroppedSpell(row,spell_data,values,(values["sheet_type"] === "npc")));
                        // Calculate final spell details
                        _.extend(values,update); // add eventual calculated attributes necessary for calcSpell()
                        _.extend(update,calcSpell(row,values));
                        // Clean dropping attributes
                        update[`${section}_spelldrop_name`] = "";
                        update[`${section}_spelldrop_uniq`] = "";
                        update[`${section}_spelldrop_data`] = "";
                        // Record everything
                        setAttrs(update,{silent: true}, () => {
                            // Re-sorting the spell section
                            sortSpells(section, values[`sort_${section}`]);
                        });
                    }
                });
            }
        }
    };
    const calcDroppedSpell = function(row, spell_data, values = {}, is_npc = false) {
        /*
            Complete an existing spell with compendium data.
            Parameters:
            - row: `repeating_section_id_`
            - spell_data: object from compendium page (with blobs)
            - values: additional needed data
            - is_npc: NPC character or not
        */
        let update = {};
        let cast_actions = {
            "one-action": "1-action",
            "two-action": "2-action",
            "three-action": "3-action",
            "1-to-3 actions": "1-to-3-actions",
            "reaction": "reaction",
            "free-action": "free_action"
        };
        if(spell_data && spell_data.name && spell_data.data && spell_data.data.blobs) {
            let blob = spell_data.data.blobs[spell_data.name];
            if(blob) {
                // Using data from Compendium
                Object.keys(blob).forEach(key => {
                    switch(key) {
                        case "magic_traditions":
                            update[`${row}magic_tradition`] = (blob[key].split(",")[0] || "").trim();
                            break;
                        case "cast_actions":
                            update[`${row}cast_actions`] = (cast_actions[blob[key].trim().toLowerCase()] || "1-action");
                            break;
                        case "cast_detail_label":
                            update[`${row}cast_detail_label`] = blob[key].trim().toLowerCase();
                            break;
                        case "data-attack":
                            if(blob[key] && blob[key].trim().toLowerCase() == "true") {
                                update[`${row}${is_npc ? "npc_" : ""}attack_checkbox`] = `@{${is_npc ? "npc_" : ""}attack_roll}`;
                            }
                            break;
                        case "damage":
                            update[`${row}damage_dice`] = blob[key];
                            update[`${row}damage_checkbox`] = "@{damage_roll}";
                            break;
                        case "data-damage_add_ability":
                            if(!is_npc && String(blob[key]).toLowerCase().trim() === "true" ) {
                                update[`${row}damage_ability`] = (values["spell_attack_key_ability_select"] || "");
                            }
                            break;
                        case "damage_additional":
                            update[`${row}damage_additional`] = blob[key].replace(global_rollregex,"[[$1]]");
                            break;
                        case "saving_throw":
                            if(["basic","normal"].includes(blob[key].trim().toLowerCase())) {
                                update[`${row}${is_npc ? "npc_" : ""}saving_throw_select`] = `@{${is_npc ? "npc_" : ""}save_roll${blob[key].trim().toLowerCase() === "basic" ? "_basic" : ""}}`;
                            } else {
                                update[`${row}${is_npc ? "npc_" : ""}saving_throw_select`] = "";
                            }
                            break;
                        case "level":
                            if(!values[`${row}spelllevel`]) {
                                update[`${row}spelllevel`] = blob[key];
                                update[`${row}current_level`] = blob[key];
                            }
                        default:
                            if(global_attributes_by_category["spells_fields"].includes(key) && !values[`${row}${key}`]) {
                                update[`${row}${key}`] = blob[key];
                            }
                            break;
                    }
                });
                // Default empty values
                global_attributes_by_category["spells_fields"].forEach(attribute => {
                    if(!(values[`${row}${attribute}`] || update[`${row}${attribute}`])) {
                        if(!["toggles","name"].includes(attribute)){
                            if(attribute === "saving_throw_select") {
                                update[`${row}${attribute}`] = "none";
                            } else {
                                update[`${row}${attribute}`] = attribute.includes("check") ? "0" : "";
                            }
                        }
                    }
                });
            }
        }
        return update;
    };

    //== SPELLS: sorting
    const sortSpells = function(section, sorting) {
        if(sorting === "name") {
            sortRepeatingSection(section, global_attributes_by_category["spells_fields"], ["name"]);
        } else if (sorting === "name_desc") {
            sortRepeatingSection(section, global_attributes_by_category["spells_fields"], [{name:"name", reverse:true}]);
        } else if (sorting === "level") {
            sortRepeatingSection(section, global_attributes_by_category["spells_fields"], [{name:"current_level",primer: parseInt},"name"]);
        } else if (sorting === "level_desc") {
            sortRepeatingSection(section, global_attributes_by_category["spells_fields"], [{name:"current_level", primer:parseInt, reverse:true},"name"]);
        }
    };

    // === BULK
    const updateEncumbrance = function(attr) {
        console.log(`%c Update Encumbrance ${attr}`, "color:purple;font-size:14px;");
        getAttrs(global_attributes_by_category["encumbrance_attributes"], (values) => {
            setAttrs(calcEncumbrance(values), {silent: true});
        });
    };
    const calcEncumbrance = function(values) {
        let update = {};
        update["encumbered_base"] = 5
            + (parseInt(values["strength_modifier"]) || 0)
            + (parseInt(values["encumbered_modifier"]) || 0);
        update["maximum_base"] = 10
            + (parseInt(values["strength_modifier"]) || 0)
            + (parseInt(values["maximum_modifier"]) || 0);
        return update;
    };
    const updateBulk = function(attr, callback) {
        console.log(`%c Update Bulk ${attr}`, "color:purple;font-size:14px;");
        let repsecs = {};
        global_attributes_by_category["repeating_bulks"].forEach(category => {
            repsecs[category] = {"section": `items-${category}`, "attrs": global_attributes_by_category["bulks_fields"].map(attr => `${category}_${attr}`)};
        });
        getRepSecIds(JSON.parse(JSON.stringify(Object.values(repsecs))), (repsec_agr) => {
            let fields = getRepSecFields(repsec_agr, Array.from(new Set(["cp","sp","gp","pp"])));
            getAttrs(fields, (values) => {
                setAttrs(calcBulk(values,repsec_agr), {silent: true}, () => {
                    if(callback) {
                        callback();
                    }
                });
            });
        });
    };
    const calcBulk = function(values,repsec_agr) {
        let update = {};
        let total = 0, light = 0, coins = 0, other = 0;
        // Tallying bulk values from various items
        global_attributes_by_category["repeating_bulks"].forEach(category => {
            repsec_agr.filter(current_section => current_section.section == `items-${category}`)[0].ids.forEach(category_id => {
                if((values[`repeating_items-${category}_${category_id}_${category}_bulk`] || "").toUpperCase() === "L") {
                    // Light item
                    light += (parseInt(values[`repeating_items-${category}_${category_id}_${category}_quantity`]) || 0);
                } else {
                    // Other / normal bulk
                    other += ((parseInt(values[`repeating_items-${category}_${category_id}_${category}_bulk`]) || 0) * (parseInt(values[`repeating_items-${category}_${category_id}_${category}_quantity`]) || 0));
                }
            });
        });
        // Coins
        coins = 0
            + (parseInt(values["cp"]) || 0)
            + (parseInt(values["sp"]) || 0)
            + (parseInt(values["gp"]) || 0)
            + (parseInt(values["pp"]) || 0);
        total = other + Math.floor(light / 10) + Math.floor(coins / 1000);
        update["bulk"] = total;
        return update;
    };

    // == Character Compendium Drops
    const completeCharacterWithCompendium = function(character_object, callback) {
        /*
            Completes a character with data from the Compendium.
            Parameters:
                - character_object:
                    * base_character: an object (simple keys/values) with some usefull data from the character
                    * compendium_spells: array of objects. Each one being {row: `repeating_section_id_`, name: name of the spell}
                    * more to come ? (compendium_feats, compendium_items ... ?)
                - optional callback function
        */
        let update = {}, pages = [], fields = ["spell_attack_key_ability_select","sheet_type"];
        getAttrs(fields, (values) => {
            let is_npc = ((values["sheet_type"] || "pc") === "npc");
            _.extend(values,character_object.base_character); // merging character data and other usefull fields
            // Gather all necessary compendium pages names
            if(character_object["compendium_spells"] && character_object["compendium_spells"].length) {
                pages.push(...character_object.compendium_spells.map(spell => "Spells:" + toTitleCase((spell["name"] || "").trim())));
            }
            getCompendiumPage(pages, (compendium_data) => {
                let compendium_data_array = [];
                if(Array.isArray(compendium_data)) {
                    compendium_data_array = compendium_data;
                } else if(typeof compendium_data === "object" && compendium_data.id) { // Single page object loaded from the compendium
                    compendium_data_array.push(compendium_data);
                }
                if(character_object["compendium_spells"] && character_object["compendium_spells"].length) {
                    // Spells to be processed
                    character_object.compendium_spells.forEach(spell => {
                        // Find individual spell data in compendium data
                        let spell_data = {};
                        try {
                            spell_data = compendium_data_array.find(o => ((o.name) && (o.name.toLowerCase().trim() === spell.name.toLowerCase().trim()) && (o.data["Category"] === "Spells")));
                        }
                        catch(error) {
                            spell_data = {};
                            console.log(`%c Pathfinder Second Edition by Roll20: completeCharacterWithCompendium: no valid data in compendium data for this spell: ${(spell["name"] || "")}`, "color:red;font-size:14px;");
                        }
                        if(spell_data && spell_data.id && spell_data.data) {
                            _.extend(update,calcDroppedSpell(spell.row, spell_data, values, is_npc));
                        }
                    });
                }
                if(callback) {
                    callback(update);
                } else {
                    return update;
                }
            });
        });
    };
    // === NPC Compendium drops
    const updateNpcDrop = function(rawdata) {
        // Checking dropped data from comendium for NPC building
        let cdata;
        try{
            cdata = JSON.parse(rawdata) || {};
        }
        catch(error){
            cdata = {};
            console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: no valid data`, "color:red;font-size:14px;");
        }
        if(_.isEmpty(cdata)) {
            console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: empty data`, "color:red;font-size:14px;");
        } else {
            // console.log(`%c PF2E Debug: NPC data: ${JSON.stringify(cdata,null,"  ")}`, "color:purple;font-size:12px;");
            if(cdata["Category"] && (cdata["Category"].trim().toLowerCase() === "monsters")) {
                // Initialize NPC & show building splash
                setAttrs({"sheet_type": "npc","build_message": (getTranslationByKey("building_npc") || "BUILDING")},{silent: true}, ()=>{
                    getAttrs(["npcdrop_name","npcdrop_uniq","toggles"], (values) => {
                        // Do 2 setAttrs: one "quick", one "long" (after getCompendiumPages), to avoid setTokenAttrs timeout
                        let npc_object = calcNpcDrop(cdata,values);
                        setAttrs(npc_object.base_character,{silent: true}, () => {
                            updateDefaultToken(() => { // Setting token size, bars
                                // Dealing with Compendium Pages (completing spells ...)
                                completeCharacterWithCompendium(npc_object, (character_update) => {
                                    // -- Hide building splash
                                    character_update["build_message"] = "";
                                    setAttrs(character_update, {silent:true}, () => {
                                        toggleStringBuilder(npc_object["toggles"], () => {
                                            totalUpdate(); // Global NPC recalculation
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            }
        }
    };
    const calcNpcDrop = function (cdata,values) {
        // Budiling / Updating an NPC character with dropped data from the compendium
        let update = {}, row = "", obj_array = [];
        // Base NPC information
        if(values["npcdrop_name"]) {
            update["character_name"] = values["npcdrop_name"];
        }
        if(values["npcdrop_uniq"]) {
            update["npc_fromcompendium"] = values["npcdrop_uniq"];
        } else {
            update["npc_fromcompendium"] = "Monsters:" + values["npcdrop_name"];
        }
        // === Basic non repeating informations
        global_npc_attributes.basics.forEach((attr) => {
            if(cdata[attr]) {
                update[`${attr}`] = cdata[attr];
            }
        });
        // === Repeating data
        // -- Lore skills
        if(cdata["data-lore"]) {
            try{
                obj_array = JSON.parse(cdata["data-lore"]);
            }
            catch(error) {
                obj_array = [];
                console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: invalid lore`, "color:red;font-size:14px;");
            }
            if(obj_array.length) {
                obj_array.forEach((obj) => {
                    row = `repeating_lore_${generateRowID()}_`;
                    update[`${row}toggles`] = "display,";
                    update[`${row}lore_name`] = (obj["lore_name"] || getTranslationByKey("lore").toUpperCase());
                    update[`${row}lore`] = (obj["lore"] || "0");
                    update[`${row}lore_notes`] = (obj["lore_notes"] || "");
                });
            }
        }
        // -- Items
        if(cdata["data-items"]) {
            try{
                obj_array = JSON.parse(cdata["data-items"]);
            }
            catch(error) {
                obj_array = [];
                console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: invalid items`, "color:red;font-size:14px;");
            }
            if(obj_array.length) {
                obj_array.forEach((obj) => {
                    row = `repeating_items-worn_${generateRowID()}_`;
                    update[`${row}toggles`] = "display,";
                    update[`${row}worn_item`] = (obj["item"] || getTranslationByKey("item").toUpperCase());
                    update[`${row}description`] = (obj["description"] || "");
                });
            }
        }
        // -- Interaction abilities
        if(cdata["data-interaction-abilities"]) {
            try{
                obj_array = JSON.parse(cdata["data-interaction-abilities"]);
            }
            catch(error) {
                obj_array = [];
                console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: invalid interaction abilities`, "color:red;font-size:14px;");
            }
            if(obj_array.length) {
                obj_array.forEach((obj) => {
                    row = `repeating_interaction-abilities_${generateRowID()}_`;
                    update[`${row}toggles`] = "display,";
                    update[`${row}name`] = (obj["name"] || getTranslationByKey("ability").toUpperCase());
                    update[`${row}traits`] = (obj["traits"] || "");
                    update[`${row}description`] = (obj["description"] || "");
                });
            }
        }
        // -- Free actions reactions (automatic and reactive abilities)
        if(cdata["data-free-actions-reactions"]) {
            try{
                obj_array = JSON.parse(cdata["data-free-actions-reactions"]);
            }
            catch(error) {
                obj_array = [];
                console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: invalid actions reactions`, "color:red;font-size:14px;");
            }
            if(obj_array.length) {
                obj_array.forEach((obj) => {
                    row = `repeating_free-actions-reactions_${generateRowID()}_`;
                    update[`${row}toggles`] = "display,";
                    update[`${row}name`] = (obj["name"] || getTranslationByKey("ability").toUpperCase());
                    update[`${row}action_type`] = "";
                    if((obj["free_action"] || "")) {
                        update[`${row}free_action`] = "free action";
                        update[`${row}action_type`] = update[`${row}action_type`] + toTitleCase(getTranslationByKey("free_action"));
                    }
                    if((obj["reaction"] || "")) {
                        update[`${row}reaction`] = "reaction";
                        update[`${row}action_type`] = update[`${row}action_type`] + " " + toTitleCase(getTranslationByKey("reaction"));
                    }
                    update[`${row}action_type`] = update[`${row}action_type`].trim();
                    update[`${row}traits`] = (obj["traits"] || "");
                    update[`${row}source`] = (obj["source"] || "");
                    update[`${row}trigger`] = (obj["trigger"] || "");
                    update[`${row}description`] = (obj["description"] || "");
                });
            }
        }
        // -- Melee strikes
        if(cdata["data-melee-strikes"]) {
            try{
                obj_array = JSON.parse(cdata["data-melee-strikes"]);
            }
            catch(error) {
                obj_array = [];
                console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: invalid melee strikes`, "color:red;font-size:14px;");
            }
            if(obj_array.length) {
                obj_array.forEach((obj) => {
                    row = `repeating_melee-strikes_${generateRowID()}_`;
                    update[`${row}toggles`] = "display,";
                    update[`${row}weapon`] = (obj["weapon"] || getTranslationByKey("weapon").toUpperCase());
                    update[`${row}weapon_strike`] = (obj["weapon_strike"] || "+0");
                    update[`${row}weapon_traits`] = (obj["weapon_traits"] || "");
                    update[`${row}weapon_strike_damage`] = (obj["weapon_strike_damage"] || "+0");
                    update[`${row}weapon_strike_damage_type`] = (obj["weapon_strike_damage_type"] || "");
                    update[`${row}weapon_strike_damage_additional`] = (obj["weapon_strike_damage_additional"] || "").replace(global_rollregex,"[[$1]]");
                    update[`${row}weapon_notes`] = (obj["weapon_notes"] || "");
                });
            }
        }
        // -- Ranged strikes
        if(cdata["data-ranged-strikes"]) {
            try{
                obj_array = JSON.parse(cdata["data-ranged-strikes"]);
            }
            catch(error) {
                obj_array = [];
                console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: invalid ranged strikes`, "color:red;font-size:14px;");
            }
            if(obj_array.length) {
                obj_array.forEach((obj) => {
                    row = `repeating_ranged-strikes_${generateRowID()}_`;
                    update[`${row}toggles`] = "display,";
                    update[`${row}weapon`] = (obj["weapon"] || getTranslationByKey("weapon").toUpperCase());
                    update[`${row}weapon_strike`] = (obj["weapon_strike"] || "+0");
                    update[`${row}weapon_traits`] = (obj["weapon_traits"] || "");
                    update[`${row}weapon_strike_damage`] = (obj["weapon_strike_damage"] || "+0");
                    update[`${row}weapon_strike_damage_type`] = (obj["weapon_strike_damage_type"] || "");
                    update[`${row}weapon_strike_damage_additional`] = (obj["weapon_strike_damage_additional"] || "").replace(global_rollregex,"[[$1]]");
                    update[`${row}weapon_range`] = (obj["weapon_range"] || "");
                    update[`${row}weapon_notes`] = (obj["weapon_notes"] || "");
                });
            }
        }
        // -- Actions activities (Offensive or Proactive abilities)
        if(cdata["data-actions-activities"]) {
            try{
                obj_array = JSON.parse(cdata["data-actions-activities"]);
            }
            catch(error) {
                obj_array = [];
                console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: invalid actions activities (offensive or proactive abilities)`, "color:red;font-size:14px;");
            }
            if(obj_array.length) {
                obj_array.forEach((obj) => {
                    row = `repeating_actions-activities_${generateRowID()}_`;
                    update[`${row}toggles`] = "display,";
                    update[`${row}name`] = (obj["name"] || getTranslationByKey("ability").toUpperCase());
                    update[`${row}actions`] = (obj["actions"] || "");
                    update[`${row}traits`] = (obj["traits"] || "");
                    update[`${row}source`] = (obj["source"] || "");
                    update[`${row}description`] = (obj["description"] || "");
                });
            }
        }
        // === Spell/spellcaster handling
        let is_spellcaster = false;
        let spells_array = [0,0,0,0,0,0,0,0,0,0]; // number of spells per level (1 to 10)
        let compendium_spells = [];
        let toggles = "";
        // -- Innate Spells
        if(cdata["data-spellinnate"]) {
            try{
                obj_array = JSON.parse(cdata["data-spellinnate"]);
            }
            catch(error) {
                obj_array = [];
                console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: invalid innate spells`, "color:red;font-size:14px;");
            }
            if(obj_array.length) {
                is_spellcaster = true;
                obj_array.forEach((obj) => {
                    row = `repeating_spellinnate_${generateRowID()}_`;
                    update[`${row}toggles`] = "display,";
                    update[`${row}name`] = (obj["name"] || getTranslationByKey("spell").toUpperCase()).trim();
                    update[`${row}spelllevel`] = (obj["spelllevel"] || "0");
                    update[`${row}current_level`] = update[`${row}spelllevel`];
                    update[`${row}spelldc`] = (obj["spelldc"] || "0");
                    update[`${row}domain`] = (obj["domain"] || "");
                    update[`${row}description`] = (obj["description"] || "");
                    if(obj["name"]) { // Collecting names for getCompendium page.
                        compendium_spells.push({
                            name: obj["name"].trim(),
                            row: row
                        });
                    }
                });
            }
        } else {
            update["toggle_innate"] = "0";
            toggles += "innate,";
        }
        // -- Focus spells
        if((cdata["casts_focus"] || "false").toLowerCase() == "true") {
            is_spellcaster = true;
        }
        if(cdata["data-spellfocus"]) {
            try{
                obj_array = JSON.parse(cdata["data-spellfocus"]);
            }
            catch(error) {
                obj_array = [];
                console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: invalid focus spells`, "color:red;font-size:14px;");
            }
            if(obj_array.length) {
                is_spellcaster = true;
                obj_array.forEach((obj) => {
                    row = `repeating_spellfocus_${generateRowID()}_`;
                    update[`${row}toggles`] = "display,";
                    update[`${row}name`] = (obj["name"] || getTranslationByKey("spell").toUpperCase()).trim();
                    update[`${row}spelllevel`] = (obj["spelllevel"] || "0");
                    update[`${row}current_level`] = update[`${row}spelllevel`];
                    update[`${row}spelldc`] = (obj["spelldc"] || "0");
                    update[`${row}domain`] = (obj["domain"] || "");
                    update[`${row}description`] = (obj["description"] || "");
                    if(obj["name"]) { // Collecting names for getCompendium page.
                        compendium_spells.push({
                            name: obj["name"].trim(),
                            row: row
                        });
                    }
                });
            }
        } else {
            update["toggle_focus"] = "0";
            toggles += "focus,";
        }
        // -- Cantrips
        if((cdata["casts_cantrips"] || "false").toLowerCase() == "true") {
            is_spellcaster = true;
        }
        if(cdata["data-cantrip"]) {
            try{
                obj_array = JSON.parse(cdata["data-cantrip"]);
            }
            catch(error) {
                obj_array = [];
                console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: invalid cantrips`, "color:red;font-size:14px;");
            }
            if(obj_array.length) {
                is_spellcaster = true;
                update["cantrips_per_day"] = obj_array.length;
                obj_array.forEach((obj) => {
                    row = `repeating_cantrip_${generateRowID()}_`;
                    update[`${row}toggles`] = "display,";
                    update[`${row}name`] = (obj["name"] || getTranslationByKey("spell").toUpperCase()).trim();
                    update[`${row}spelllevel`] = (obj["spelllevel"] || "0");
                    update[`${row}current_level`] = update[`${row}spelllevel`];
                    update[`${row}spelldc`] = (obj["spelldc"] || "0");
                    if(obj["type"] && global_magic_traditions.includes(obj["type"].trim().toLowerCase())) {
                        update[`${row}magic_tradition`] = obj["type"];
                    } else if(obj["magic_tradition"] && global_magic_traditions.includes(obj["magic_tradition"].trim().toLowerCase())) {
                        update[`${row}magic_tradition`] = obj["magic_tradition"];
                    }
                    if(obj["frequency"] && global_spell_frequencies.includes(obj["frequency"].trim().toLowerCase())) {
                        update[`${row}frequency`] = obj["frequency"];
                    }
                    update[`${row}uses_max`] = (obj["uses_max"] || "0");
                    update[`${row}uses`] = update[`${row}uses_max`];
                    update[`${row}description`] = (obj["description"] || "");
                    if(obj["name"]) { // Collecting names for getCompendium page.
                        compendium_spells.push({
                            name: obj["name"].trim(),
                            row: row
                        });
                    }
                });
            }
        } else {
            update["toggle_cantrips"] = "0";
            toggles += "cantrips,";
        }
        // --- Prepared and Spontaneous Spells, level 1 to 10
        if(cdata["spellcaster_prepared"] && cdata["spellcaster_prepared"].trim().toLowerCase() !== "false") {
            is_spellcaster = true;
            update["spellcaster_prepared"] = "prepared";
        }
        if(cdata["spellcaster_spontaneous"] && cdata["spellcaster_spontaneous"].trim().toLowerCase() !== "false") {
            is_spellcaster = true;
            update["spellcaster_spontaneous"] = "spontaneous";
        }
        if(cdata["data-spell"]) {
            try{
                obj_array = JSON.parse(cdata["data-spell"]);
            }
            catch(error) {
                obj_array = [];
                console.log(`%c Pathfinder Second Edition by Roll20: npcdrop_data: invalid spell`, "color:red;font-size:14px;");
            }
            if(obj_array.length) {
                is_spellcaster = true;
                let spellvl = 1;
                obj_array.forEach((obj) => {
                    spellvl = parseInt((obj["spelllevel"] || "1"));
                    spells_array[spellvl-1]++;
                    row = `repeating_normalspells_${generateRowID()}_`;
                    // attributes
                    update[`${row}toggles`] = "display,";
                    update[`${row}name`] = (obj["name"] || getTranslationByKey("spell").toUpperCase()).trim();
                    update[`${row}spelllevel`] = spellvl;
                    update[`${row}current_level`] = spellvl;
                    update[`${row}spelldc`] = (obj["spelldc"] || "0");
                    if(obj["type"] && global_magic_traditions.includes(obj["type"].trim().toLowerCase())) {
                        update[`${row}magic_tradition`] = obj["type"];
                    } else if(obj["magic_tradition"] && global_magic_traditions.includes(obj["magic_tradition"].trim().toLowerCase())) {
                        update[`${row}magic_tradition`] = obj["magic_tradition"];
                    }
                    if(obj["frequency"] && global_spell_frequencies.includes(obj["frequency"].trim().toLowerCase())) {
                        update[`${row}frequency`] = obj["frequency"];
                    }
                    update[`${row}uses_max`] = (obj["uses_max"] || "0");
                    update[`${row}uses`] = update[`${row}uses_max`];
                    update[`${row}description`] = (obj["description"] || "");
                    if(obj["name"]) { // Collecting names for getCompendium page.
                        compendium_spells.push({
                            name: obj["name"].trim(),
                            row: row
                        });
                    }
                });
            }
        } else {
            update["toggle_normalspells"] = "0";
            toggles += "normalspells,";
        }
        // -- Spells per level (1 to 10)
        if(is_spellcaster) {
            // Activating (or not) spell sections, and spells per day
            for (let i = 0; i < 10; i++) {
                if(cdata[`level_${i+1}_per_day_max`] && (parseInt(cdata[`level_${i+1}_per_day_max`]) || 0) > 0) {
                    update[`casts_level_${i+1}`] = "1";
                    update[`level_${i+1}_per_day`] = parseInt(cdata[`level_${i+1}_per_day_max`]);
                    update[`level_${i+1}_per_day_max`] = parseInt(cdata[`level_${i+1}_per_day_max`]);
                } else {
                    update[`casts_level_${i+1}`] = (parseInt(spells_array[i]) || 0) > 0 ? "1" : "0";
                    update[`level_${i+1}_per_day`] = spells_array[i];
                    update[`level_${i+1}_per_day_max`] = spells_array[i];
                }
            }
        }
        // -- Rituals: TBC when sheet updated with rituals
        // === Final calculations
        if(is_spellcaster) { // make sure the spell/magic sections is visible
            update["toggles"] = (values["toggles"] || "") + "npcspellcaster,";
        }
        update["hit_points"] = (update["hit_points_max"] || 0);
        update["focus_points"] = (update["focus_points_max"] || 0);
        // -- End / return
        let obj_npc = {};
        obj_npc["base_character"] = update;
        obj_npc["compendium_spells"] = compendium_spells;
        obj_npc["toggles"] = toggles;
        return obj_npc;
    };
    const updateDefaultToken = function(callback) {
        // === Token default attributes handling
        getAttrs(["size","settings_bar1value","settings_bar1max","settings_bar1link","settings_bar2value","settings_bar2max","settings_bar2link","settings_bar3value","settings_bar3max","settings_bar3link"], (settings) => {
            let default_attr = {};
            // SIZE
            default_attr["width"] = 70;
            default_attr["height"] = 70;
            if(settings["size"]) {
                let squares = 1.0;
                let squarelength = 70;
                let obj_size = global_sizes.find((size_item) => size_item.size === settings["size"].toLowerCase());
                if(! _.isEmpty(obj_size)) {
                    squares = Math.max((parseFloat(obj_size.squares) || 1.0), 1.0);
                }
                let squaresize = parseInt(squarelength * squares);
                default_attr["width"] = squaresize;
                default_attr["height"] = squaresize;
            }
            // === BARS
            let getList = {}, keyword = "";
            for(let x = 1; x < 4; x++) {
                ["value","max"].forEach(word => {
                    keyword = `settings_bar${x}${word}`;
                    if(settings[keyword]) {
                        getList[keyword] = settings[keyword];
                    }
                });
            }
            let fields = [];
            fields = fields.concat(_.values(getList));
            getAttrs(fields, (values) =>  {
                // Bar 1
                if(settings["settings_bar1link"]) {
                    default_attr["bar1_link"] = settings["settings_bar1link"];
                } else if(settings["settings_bar1value"] || settings["settings_bar1max"]) {
                    if(settings["settings_bar1value"] && values[settings["settings_bar1value"]]) {
                        default_attr["bar1_value"] = values[settings["settings_bar1value"]];
                    }
                    if(settings["settings_bar1max"] && values[settings["settings_bar1max"]]) {
                        default_attr["bar1_max"] = values[settings["settings_bar1max"]];
                    }
                }
                // Bar 2
                if(settings["settings_bar2link"]) {
                    default_attr["bar2_link"] = settings["settings_bar2link"];
                } else if(settings["settings_bar2value"] || settings["settings_bar2max"]) {
                    if(settings["settings_bar2value"] && values[settings["settings_bar2value"]]) {
                        default_attr["bar2_value"] = values[settings["settings_bar2value"]];
                    }
                    if(settings["settings_bar2max"] && values[settings["settings_bar2max"]]) {
                        default_attr["bar2_max"] = values[settings["settings_bar2max"]];
                    }
                }
                // Bar 3
                if(settings["settings_bar3link"]) {
                    default_attr["bar3_link"] = settings["settings_bar3link"];
                } else if(settings["settings_bar3value"] || settings["settings_bar3max"]) {
                    if(settings["settings_bar3value"] && values[settings["settings_bar3value"]]) {
                        default_attr["bar3_value"] = values[settings["settings_bar3value"]];
                    }
                    if(settings["settings_bar3max"] && values[settings["settings_bar3max"]]) {
                        default_attr["bar3_max"] = values[settings["settings_bar3max"]];
                    }
                }
                setDefaultToken(default_attr);
                if(callback) {
                    callback();
                }
            });
        });
    };

    // === Module Interface
    return {
        sheetOpen: sheetOpen
        , getAttrNames: getAttrNames
        , totalUpdate: totalUpdate
        , updateAbility: updateAbility
		, updateTenacity: updateTenacity
		, updateTenacityDrain: updateTenacityDrain
        , updateSkill: updateSkill
        , updateSave: updateSave
        , updateArmorClass: updateArmorClass
        , updateHitPoints: updateHitPoints
        , updateAttack: updateAttack
        , updatePerception: updatePerception
        , updateClassDc: updateClassDc
        , updateSpellAttack: updateSpellAttack
        , updateSpellDc: updateSpellDc
        , updateMagicTradition: updateMagicTradition
        , updateSpell: updateSpell
        , updateEncumbrance: updateEncumbrance
        , updateBulk: updateBulk
        , updateNpcDrop: updateNpcDrop
        , sortSpells: sortSpells
        , updateSpellDrop: updateSpellDrop
        , toTitleCase: toTitleCase
    }

})();
/* === MODULE ENDS === */
/* === EVENTS HANDLING BEGINS === */

// == Generalities
// Sheet opening
on("sheet:opened", (eventinfo) => {
    modPf2.sheetOpen(eventinfo);
});

//Changes sheet type
['npc', 'character'].forEach(attr => {
    on(`clicked:toggle_${attr}`, (eventinfo) => {
        setAttrs({
            sheet_type : attr
        });
    });
});
// === SETTINGS TOGGLE
modPf2.getAttrNames(['setting_toggles', 'skills']).forEach(attr => {
    on(`clicked:toggle_${attr}`, (eventinfo) => {
        toggleStringBuilder(attr);
    });
});

modPf2.getAttrNames(['spell_types', 'color_scheme']).forEach(attr => {
    on(`change:toggle_${attr}`, (eventinfo) => {
        toggleStringBuilder(attr);
    });
});

const toggleStringBuilder = (toggle, callback) => {
    getAttrs(["toggles"], (values) => {
        let toggles_array = [];
        // Remove duplicates from current toggles, and empty strings, undefined, nulls and other "false" elements
        toggles_array = [...new Set((values[`toggles`] || "").split(","))].filter(element => {return element != null && String(element).trim().length;});
        // For each toggle passed as parameter, add it if absent, or remove it if present
        (toggle || "").split(",").forEach(toggle_uniq => {
            if(toggles_array.includes(toggle_uniq)) {
                // Alreay present: remove
                toggles_array.splice(toggles_array.indexOf(toggle_uniq), 1);
            } else {
                // Absent: add it
                toggles_array.push(toggle_uniq);
            }
        });
        setAttrs({"toggles" : toggles_array.join()},{silent: true}, () => {
            if(callback) {
                callback();
            }
        });
    });
};

on(`change:color_scheme`, (eventinfo) => {
    const newColor = `color:${(eventinfo.newValue || "neutral")},`;
    getAttrs(["toggles"], (values) => {
        let update = {};
        let toggles = (values["toggles"] || "");
        let oldColor = `color:${(eventinfo.previousValue || "default")},`;
        if(newColor === oldColor) {
            if(newColor.includes("neutral")) {
                oldColor = "color:default,";
            } else {
                oldColor = "color:neutral,";
            }
        }
        if(toggles.includes("color:")) {
            toggles = toggles.replace(oldColor, newColor);
        } else {
            toggles += newColor;
        }
        update["toggles"] = toggles;
        setAttrs(update,{silent: true});
    });
});

// === REPEATING SETTINGS TOGGLES
modPf2.getAttrNames(['repeating_toggles']).forEach(attr => {
    on(`clicked:${attr}:settings clicked:${attr}:collapse`, (eventinfo) => {
        const trigger = eventinfo.triggerName.split("clicked:")[1];
        const id      = trigger.split("_")[2];
        const keyword = trigger.split("_")[3];
        getAttrs([`${attr}_${id}_toggles`], (values) => {
            let string = values[`${attr}_${id}_toggles`];
            (string.includes(`${keyword}`)) ? string = string.replace(`${keyword},`, "") : string += `${keyword},`;
            setAttrs({
                [`${attr}_${id}_toggles`] : string
            });
        });
    });
});

// === Options - settings
on("clicked:whisper", (eventinfo) => {
    getAttrs(["whispertype"], function (values) {
        setAttrs({
            "whispertype": ((values["whispertype"] || "").includes("gm")) ?  " " : "/w gm "
        });
    });
});
on("change:roll_option_critical_damage", () => {
    modPf2.totalUpdate();
});

// === LEVEL
on("change:level", (eventinfo) => {
    // console.table(eventinfo);
    modPf2.totalUpdate();
});

// === ABILITIES
//Modifier calculators
modPf2.getAttrNames(['abilities']).forEach(attr => {
    on(`change:${attr}_score change:${attr}_score_temporary change:${attr}_modifier_temporary`, (eventinfo) => {
        //console.table(eventinfo);
        modPf2.updateAbility(attr);
    });
	on(`change:${attr}_tenacity_mod`, (eventinfo) => {
		modPf2.updateTenacity(attr);
	})
	on(`change:${attr}_tenacity`, (eventinfo) => {
		modPf2.updateTenacityDrain();
	})
});
//Update ability inputs with the appropriate selectable modifier
modPf2.getAttrNames(['select_attributes']).forEach(attr => {
    on(`change:${attr}_ability_select`, (eventinfo) => {
        // console.table(eventinfo);
        if((eventinfo.newValue || "").includes("modifier")) {
            const ability = eventinfo.newValue.slice(2,-1);
            getAttrs([ability], (values) => {
                let update = {};
                update[`${eventinfo.sourceAttribute.replace(/_select$/,"")}`] = values[ability];
                setAttrs(update);
            });
        }
    });
});
//Update ability selects to custom if the user inputs their own modifer
modPf2.getAttrNames(['select_attributes']).forEach(attr => {
    on(`change:${attr}_ability`, (eventinfo) => {
        // console.table(eventinfo);
        if (eventinfo.sourceType === "player") {
            getAttrs([`${eventinfo.sourceAttribute}_select`], (values) => {
                if (values[`${eventinfo.sourceAttribute}_select`].includes("modifier")) {
                    setAttrs({
                        [`${eventinfo.sourceAttribute}_select`] : "custom"
                    },{silent: true});
                } else {
                    console.log(`%c Ability value was ${values[`${eventinfo.sourceAttribute}_select`]}`, "color:orange;");
                };
            });
        };
    });
});

// === SKILLS
// Fixed skills
modPf2.getAttrNames(["skills"]).forEach(attr => {
    on(modPf2.getAttrNames(["skills_fields"]).map(field => `change:${attr}_${field}`).join(' '), (eventinfo) => {
        // console.table(eventinfo);
        if(!eventinfo.sourceAttribute.includes("ability_select")) {
            modPf2.updateSkill(attr,eventinfo.sourceAttribute);
        }
    });
});
// Repeating skills
modPf2.getAttrNames(['repeating_skills']).forEach(attr => {
    on(modPf2.getAttrNames(["skills_fields"]).map(field => `change:repeating_${attr}:${attr}_${field}`).join(' '), (eventinfo) => {
        // console.table(eventinfo);
        if(!eventinfo.sourceAttribute.includes("ability_select")) {
            modPf2.updateSkill(`repeating_${attr}_${eventinfo.sourceAttribute.split(`${attr}_`)[1]}${attr}`,eventinfo.sourceAttribute);
        }
    });
});

// === SAVES
modPf2.getAttrNames(["saves"]).forEach(attr => {
    on(modPf2.getAttrNames(["saves_fields"]).map(field => `change:${attr}_${field}`).join(' '), (eventinfo) => {
        // console.table(eventinfo);
        if(!eventinfo.sourceAttribute.includes("ability_select")) {
            modPf2.updateSave(attr,eventinfo.sourceAttribute);
        }
    });
});

// === ARMOR CLASS (AC)
modPf2.getAttrNames(["ac"]).forEach(attr => {
    on(modPf2.getAttrNames(["ac_fields"]).map(field => `change:${attr}_${field}`).join(' '), (eventinfo) => {
        // console.table(eventinfo);
        if(!eventinfo.sourceAttribute.includes("ability_select")) {
            modPf2.updateArmorClass(attr,eventinfo.sourceAttribute);
        }
    });
});

// === HIT POINTS
on(modPf2.getAttrNames(["hit_points"]).map(attr => `change:${attr}`).join(' '), (eventinfo) => {
    // console.table(eventinfo);
    modPf2.updateHitPoints(eventinfo.sourceAttribute);
});

// === ATTACKS
modPf2.getAttrNames(["repeating_attacks"]).forEach(attr => {
    on(modPf2.getAttrNames(["attacks_fields"]).map(field => `change:repeating_${attr}:${field}`).join(' '), (eventinfo) => {
        // console.table(eventinfo);
        if(!eventinfo.sourceAttribute.includes("ability_select")) {
            modPf2.updateAttack(`repeating_${attr}_${eventinfo.sourceAttribute.split('_')[2]}`,eventinfo.sourceAttribute);
        }
    });
});
on("change:query_roll_damage_dice", (eventinfo) => {
    modPf2.totalUpdate();
});

// === PERCEPTION
on(modPf2.getAttrNames(["perception"]).map(attr => `change:${attr}`).join(' '), (eventinfo) => {
    // console.table(eventinfo);
    if(!eventinfo.sourceAttribute.includes("ability_select")) {
        modPf2.updatePerception(eventinfo.sourceAttribute);
    }
});

// === INITIATIVE
on("change:initiative_skill", (eventinfo) => {
    setAttrs({"initiative": `@{${eventinfo.newValue}}[${getTranslationByKey(eventinfo.newValue).toUpperCase()}]`},{silent:true});
});

// === CLASS DC
on(modPf2.getAttrNames(["class_dc"]).map(attr => `change:${attr}`).join(' '), (eventinfo) => {
    // console.table(eventinfo);
    if(!eventinfo.sourceAttribute.includes("ability_select")) {
        modPf2.updateClassDc(eventinfo.sourceAttribute);
    }
});

// === SPELL ATTACK
on(modPf2.getAttrNames(["spell_attack"]).map(attr => `change:${attr}`).join(' '), (eventinfo) => {
    // console.table(eventinfo);
    if(!eventinfo.sourceAttribute.includes("ability_select")) {
        modPf2.updateSpellAttack(eventinfo.sourceAttribute,() => {modPf2.totalUpdate()});
    }
});
on("change:spell_attack", (eventinfo) => { // NPC only
    getAttrs(["sheet_type"], (values) => {
        if( (values["sheet_type"] || "").toLowerCase() === "npc"  ) {
            modPf2.totalUpdate();
        }
    });
});

// === SPELL DC
on(modPf2.getAttrNames(["spell_dc"]).map(attr => `change:${attr}`).join(' '), (eventinfo) => {
    // console.table(eventinfo);
    if(!eventinfo.sourceAttribute.includes("ability_select")) {
        modPf2.updateSpellDc(eventinfo.sourceAttribute,() => {modPf2.totalUpdate()});
    }
});
on("change:spell_dc", (eventinfo) => { // NPC only
    getAttrs(["sheet_type"], (values) => {
        if( (values["sheet_type"] || "").toLowerCase() === "npc"  ) {
            modPf2.totalUpdate();
        }
    });
});

// === SPELLS: MAGIC TRADITIONS
modPf2.getAttrNames(["magic_tradition"]).forEach(tradition => {
    on(modPf2.getAttrNames(["magic_tradition_fields"]).map(field => `change:magic_tradition_${tradition}_${field}`).join(' '), (eventinfo) => {
        // console.table(eventinfo);
        modPf2.updateMagicTradition(eventinfo.sourceAttribute,tradition,() => {modPf2.totalUpdate()});
    });
});

// === SPELLS: SPELLS
modPf2.getAttrNames(["repeating_spells"]).forEach(attr => {
    on(modPf2.getAttrNames(["spells_fields_triggering"]).map(field => `change:repeating_${attr}:${field}`).join(' '), (eventinfo) => {
        // console.table(eventinfo);
        modPf2.updateSpell(`repeating_${attr}_${eventinfo.sourceAttribute.split('_')[2]}_`,eventinfo.sourceAttribute);
    });
});
// -- Sorting spells
modPf2.getAttrNames(["repeating_spells"]).forEach(section => {
    on(`change:sort_${section}`, (eventinfo) => {
        // console.table(eventinfo);
        modPf2.sortSpells(section, (eventinfo["newValue"] || ""));
    });
});
modPf2.getAttrNames(["repeating_spells"]).forEach(section => {
    on(`change:_reporder:${section}`, (eventinfo) => {
        // console.table(eventinfo);
        let update = {};
        update[`sort_${section}`] = ""; // resetting select to "Sort By:"
        setAttrs(update,{silent:true});
     });
});
// -- Drop spells
modPf2.getAttrNames(["repeating_spells"]).forEach(section => {
    on(`change:${section}_spelldrop_data`, (eventinfo) => {
        if(eventinfo && eventinfo.newValue && ((!eventinfo.triggerType) || (eventinfo.triggerType && eventinfo.triggerType == "compendium"))) {
            modPf2.updateSpellDrop(section,eventinfo.newValue);
        }
    });
});

// === ENCUMBRANCE & BULK
on("change:encumbered_modifier change:maximum_modifier", (eventinfo) => {
    modPf2.updateEncumbrance(eventinfo.sourceAttribute);
});
modPf2.getAttrNames(["repeating_bulks"]).forEach(attr => {
    on(modPf2.getAttrNames(["bulks_fields"]).map(field => `change:repeating_items-${attr}:${attr}_${field}`).join(' '), (eventinfo) => {
        // console.table(eventinfo);
        modPf2.updateBulk(eventinfo.sourceAttribute);
    });
    on(`remove:repeating_items-${attr}`, (eventinfo) => {
        // console.table(eventinfo);
        modPf2.updateBulk(eventinfo.sourceAttribute);
    });
});
on("change:cp change:sp change:gp change:pp", (eventinfo) => {
        // console.table(eventinfo);
        modPf2.updateBulk(eventinfo.sourceAttribute);
});

// === ACTIONS
// -- NPC Compendium drops
on("change:npcdrop_data", (eventinfo) => {
    if(eventinfo && eventinfo.newValue && ((!eventinfo.triggerType) || (eventinfo.triggerType && eventinfo.triggerType == "compendium"))) {
        modPf2.updateNpcDrop(eventinfo.newValue);
    }
});
// -- Actions (PC)
on("change:repeating_actions:action change:repeating_actions:name", (eventinfo) => {
    let row = eventinfo.sourceAttribute.substr(0,39);
    getAttrs([`${row}action`], (values) => {
        let update = {};
        update[`${row}action_type`] = modPf2.toTitleCase(getTranslationByKey((values[`${row}action`] || "other")));
        setAttrs(update,{silent: true});
    });
});

// === Automatic and Reactive abilities (NPC)
on("change:repeating_free-actions-reactions:free_action change:repeating_free-actions-reactions:reaction", (eventinfo) => {
    let row = eventinfo.sourceAttribute.substr(0,54);
    getAttrs([`${row}free_action`,`${row}reaction`], (values) => {
        let update = {};
        update[`${row}action_type`] = (`${(values[`${row}free_action`] || "0") == "0" ? "" : modPf2.toTitleCase(getTranslationByKey("free_action"))} `
                              + `${(values[`${row}reaction`] || "0") == "0" ? "" : modPf2.toTitleCase(getTranslationByKey("reaction"))} `).trim();
        setAttrs(update,{silent: true});
    })
});

/* === EVENTS HANDLING ENDS === */
//# sourceURL=Pathfinder2ByRoll20.js
</script>